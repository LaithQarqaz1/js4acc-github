<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تفاصيل الحساب</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="header.css">
  <style>
    :root{
      --bg:#05070f;
      --text:#e6edff;
      --muted:#9aa6c8;
      --primary:#2f74e4;
      --primary-2:#3f86ff;
      --card:#0f1628;
      --border:rgba(255,255,255,.08);
    }
    [data-theme="light"]{
      --bg:#f5f6fb;
      --text:#111827;
      --muted:#6b7280;
      --primary:#2f74e4;
      --primary-2:#3f86ff;
      --card:#ffffff;
      --border:#e5e7eb;
    }
    *{box-sizing:border-box;}
    body{margin:0;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);}
    header{background:linear-gradient(135deg,#0b1020,#111a2f);color:#fff;padding:14px 16px;font-weight:800;font-size:1.2rem;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.45);}
    .container{width:min(1200px,94vw);margin:18px auto 32px;display:flex;flex-direction:column;gap:16px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 14px 32px rgba(0,0,0,.35);padding:14px;animation:fadeUp .4s ease;}
    .hero{position:relative;overflow:hidden;}
    .hero img{width:100%;border-radius:14px;aspect-ratio:16/9;object-fit:cover;cursor:pointer;max-height:320px;}
    .hero .nav-btn{position:absolute;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.6);color:#fff;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 16px rgba(0,0,0,0.35);}
    .hero .nav-btn.left{left:10px;}
    .hero .nav-btn.right{right:10px;}
    .thumbs{display:flex;gap:10px;overflow-x:auto;padding:6px 2px;}
    .thumbs img{width:120px;height:70px;border-radius:10px;border:2px solid transparent;object-fit:cover;cursor:pointer;background:#0f1628;}
    .thumbs img.active{border-color:var(--primary);}
    .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-start;margin:10px 0;}
    .btn{border:none;border-radius:12px;padding:10px 16px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 10px 20px rgba(0,0,0,0.18);}
    .btn.primary{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;}
    .btn.ghost{background:var(--card);color:var(--text);border:1px solid var(--border);}
    h2,h3{margin:0 0 10px;}
    .section-title{color:var(--primary);margin:12px 0;font-size:1.2rem;}
    .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;}
    .gallery img{width:100%;border-radius:12px;aspect-ratio:16/9;object-fit:cover;background:#0f1628;cursor:pointer;}
    .gallery video{width:100%;border-radius:12px;aspect-ratio:16/9;object-fit:cover;background:#0f1628;}
    .muted{color:var(--muted);}
    .price{font-size:1.3rem;font-weight:800;color:#1fc9ab;}
    .skeleton{background:linear-gradient(90deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02),rgba(255,255,255,0.06));border-radius:12px;animation:sh 1.3s infinite;}
    @keyframes sh{0%{background-position:-200px 0}100%{background-position:200px 0}}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    /* عرض الصورة الكاملة */
    #fullOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.78);backdrop-filter:blur(6px);z-index:12000;padding:18px;}
    #fullOverlay img{max-width:96vw;max-height:92vh;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.6);object-fit:contain;}
  </style>
</head>
<body>
  <div id="headerContainer"></div>
  <header>تفاصيل الحساب</header>
  <main class="container">
    <section class="card">
      <div class="hero" id="hero">
        <div class="skeleton" style="width:100%;aspect-ratio:16/9;"></div>
      </div>
      <div class="thumbs" id="thumbs"></div>
      <div class="actions">
        <button class="btn ghost" id="downloadBtn">تحميل صور الحساب</button>
        <button class="btn ghost" id="copyLinkBtn">نسخ رابط الحساب</button>
        <button class="btn primary" id="purchaseBtn">شراء الحساب بالرصيد</button>
      </div>
      <div class="muted tiny" id="purchaseStatus"></div>
      <div>
        <h2 id="title"></h2>
        <div class="price" id="price"></div>
        <div class="muted tiny" id="priceNote" style="display:none;"></div>
        <p class="muted" id="desc"></p>
      </div>
    </section>

    <section class="card">
      <h3 class="section-title">استعراض الحساب</h3>
      <div class="gallery" id="gallery"></div>
    </section>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>window.ADMIN_ROUTER_BASE = 'https://js4acc.laithqarqaz1.workers.dev/';</script>
  <script src="header.js" defer></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBD4zpvsUdygm7KxRYXPDHbotwvf9Y7pOQ",
      authDomain: "js4accweb.firebaseapp.com",
      projectId: "js4accweb",
      storageBucket: "js4accweb.appspot.com",
      messagingSenderId: "635891162580",
      appId: "1:635891162580:web:1ee495e5b51f96ab16ca41",
      measurementId: "G-0Y3LMPBEWJ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const qs = new URLSearchParams(location.search);
    const accountId = qs.get('id');
    const hero = document.getElementById('hero');
    const thumbs = document.getElementById('thumbs');
    const gallery = document.getElementById('gallery');
    const titleEl = document.getElementById('title');
    const priceEl = document.getElementById('price');
    const priceNoteEl = document.getElementById('priceNote');
    const descEl = document.getElementById('desc');
    const downloadBtn = document.getElementById('downloadBtn');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const purchaseBtn = document.getElementById('purchaseBtn');
    const purchaseStatus = document.getElementById('purchaseStatus');
    const ADMIN_ROUTER_BASE = (window.ADMIN_ROUTER_BASE || window.ROUTER_BASE || window.BACKEND_BASE || '').toString().replace(/\/+$/, '');

    let images = [];
    let videoUrl = '';
    let accountOwnerId = '';
    let accountPrice = 0;
    let currentUser = null;
    let buyerLevel = 'customer';
    const feesConfig = getDefaultFees();
    firebase.auth().onAuthStateChanged((u) => { currentUser = u; loadUserLevel().then(refreshPrice); });

    const fullOverlay = document.createElement('div');
    fullOverlay.id = 'fullOverlay';
    fullOverlay.innerHTML = '<img alt="عرض كامل">';
    document.body.appendChild(fullOverlay);
    fullOverlay.addEventListener('click', ()=>{ fullOverlay.style.display='none'; });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') fullOverlay.style.display='none'; });

    let heroIndex = 0;

    function showFull(src){
      const img = fullOverlay.querySelector('img');
      if (img){ img.src = src; fullOverlay.style.display = 'flex'; }
    }

    function getDefaultFees(){
      return { buyerMarkup: { customer: 0, trader: 0, vip: 0 }, sellerFee: 0 };
    }
    function normalizeLevel(value){
      const v = (value || '').toString().trim().toLowerCase();
      if (!v) return 'customer';
      if (v.includes('vip')) return 'vip';
      if (v.includes('تج') || v.includes('trader')) return 'trader';
      if (v.includes('زب') || v.includes('عميل') || v.includes('customer')) return 'customer';
      return 'customer';
    }
    async function loadUserLevel(){
      try{
        if (!currentUser || !db) { buyerLevel = 'customer'; return; }
        const snap = await db.collection('users').doc(currentUser.uid).get();
        if (snap && snap.exists){
          const data = snap.data() || {};
          buyerLevel = normalizeLevel(data.level || data.type || data.role);
        }
      }catch(_){ buyerLevel = 'customer'; }
    }
    async function loadFeesConfig(){
      if (!ADMIN_ROUTER_BASE) return;
      try{
        const res = await fetch(`${ADMIN_ROUTER_BASE}/accounts`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'fees:get' })
        });
        const data = await res.json().catch(()=>({}));
        if (res.ok && data?.fees){
          feesConfig.buyerMarkup.customer = Number(data.fees?.buyerMarkup?.customer) || 0;
          feesConfig.buyerMarkup.trader = Number(data.fees?.buyerMarkup?.trader) || 0;
          feesConfig.buyerMarkup.vip = Number(data.fees?.buyerMarkup?.vip) || 0;
          feesConfig.sellerFee = Number(data.fees?.sellerFee) || 0;
        }
      }catch(_){ /* ignore */ }
    }

    const basePriceRef = { value: null };
    function formatPrice(val){
      const num = Number(val);
      if (!Number.isFinite(num)) return 'غير محدد';
      if (typeof window.formatCurrencyFromJOD === 'function'){
        try { return window.formatCurrencyFromJOD(num); } catch(_){}
      }
      return num.toFixed(2) + ' $';
    }
    function applyPriceMarkup(base){
      const pct = Number(feesConfig?.buyerMarkup?.[buyerLevel]) || 0;
      const final = Math.max(0, Math.round(Number(base || 0) * (1 + pct/100) * 100) / 100);
      return { pct, final };
    }
    function refreshPrice(){
      if (basePriceRef.value == null) return;
      const applied = applyPriceMarkup(basePriceRef.value);
      priceEl.textContent = formatPrice(applied.final);
      if (priceNoteEl){
        if (applied.pct){
          const lvl = buyerLevel === 'vip' ? 'VIP' : (buyerLevel === 'trader' ? 'تجار' : 'زبائن');
          priceNoteEl.style.display = 'block';
          priceNoteEl.textContent = `السعر يشمل زيادة ${applied.pct}% (${lvl})`;
        } else {
          priceNoteEl.style.display = 'none';
          priceNoteEl.textContent = '';
        }
      }
      try {
        if (priceEl) {
          priceEl.dataset.priceUsd = Number(applied.final);
          priceEl.dataset.priceBase = 'USD';
        }
      } catch {}
    }

    function setHeroByIndex(idx){
      if (!images.length) return;
      heroIndex = (idx + images.length) % images.length;
      const src = images[heroIndex];
      hero.innerHTML = `
        <img src="${src}" alt="صورة الحساب">
        ${images.length > 1 ? '<button class="nav-btn left" id="heroPrev" aria-label="السابق">‹</button><button class="nav-btn right" id="heroNext" aria-label="التالي">›</button>' : ''}
      `;
      const el = hero.querySelector('img');
      if (el) el.addEventListener('click', ()=>showFull(src));
      const prev = hero.querySelector('#heroPrev');
      const next = hero.querySelector('#heroNext');
      if (prev) prev.addEventListener('click', ()=>setHeroByIndex(heroIndex-1));
      if (next) next.addEventListener('click', ()=>setHeroByIndex(heroIndex+1));
      Array.from(thumbs.querySelectorAll('img')).forEach(img=>{
        img.classList.toggle('active', img.dataset.src === src);
      });
    }

    function renderThumbs(list){
      thumbs.innerHTML = list.map((src, idx)=>`<img data-src="${src}" class="${idx===0?'active':''}" src="${src}" alt="thumb">`).join('');
      thumbs.addEventListener('click', (e)=>{
        const img = e.target.closest('img[data-src]');
        if (!img) return;
        const idx = images.indexOf(img.dataset.src);
        setHeroByIndex(idx >= 0 ? idx : 0);
      });
    }

    function renderGallery(list){
      gallery.innerHTML = list.map(src => `<img src="${src}" alt="صورة الحساب">`).join('');
      Array.from(gallery.querySelectorAll('img')).forEach(img => {
        img.addEventListener('click', ()=>showFull(img.src));
      });
    }

    function renderVideo(url){
      const poster = images.length ? ` poster="${images[0]}"` : '';
      gallery.innerHTML = `<video controls playsinline preload="metadata"${poster}><source src="${url}"></video>`;
    }

    async function loadAccount(){
      if (!accountId){ titleEl.textContent = 'لم يتم العثور على الحساب'; return; }
      try{
        const snap = await db.collection('accounts').doc(accountId).get();
        if (!snap.exists){ titleEl.textContent = 'الحساب غير موجود'; return; }
        const data = snap.data() || {};
        titleEl.textContent = data.title || 'حساب';
        if (data.price != null) {
          basePriceRef.value = data.price;
          refreshPrice();
        } else {
          priceEl.textContent = '';
          if (priceNoteEl){ priceNoteEl.style.display = 'none'; priceNoteEl.textContent = ''; }
        }
        descEl.textContent = data.description || 'لا يوجد وصف.';
        accountOwnerId = data.ownerId || '';
        accountPrice = Number(data.price || data.priceUSD || 0);
        images = Array.isArray(data.images) && data.images.length ? data.images : (data.image ? [data.image] : []);
        videoUrl = typeof data.video === 'string' ? data.video.trim() : '';

        if (images.length){
          setHeroByIndex(0);
          renderThumbs(images);
        } else if (videoUrl){
          hero.innerHTML = `<video controls playsinline preload="metadata" style="width:100%;border-radius:14px;aspect-ratio:16/9;background:#0f1628;"><source src="${videoUrl}"></video>`;
        } else {
          hero.innerHTML = '<div class="skeleton" style="width:100%;aspect-ratio:16/9;"></div>';
        }

        if (videoUrl){
          renderVideo(videoUrl);
        } else if (images.length){
          renderGallery(images);
        } else {
          gallery.innerHTML = '<p class="muted">لا يوجد استعراض متاح لهذا الحساب حالياً.</p>';
        }
        if (purchaseBtn) {
          if (data.status && data.status !== 'approved') {
            purchaseBtn.disabled = true;
            setPurchaseStatus('الحساب غير متاح للشراء حالياً', 'error');
          } else {
            purchaseBtn.disabled = false;
            setPurchaseStatus('');
          }
        }
      } catch(e){
        titleEl.textContent = 'تعذر تحميل الحساب';
      }
    }

    downloadBtn.addEventListener('click', ()=>{
      if (!images.length) return;
      const a = document.createElement('a');
      a.href = images[0];
      a.download = 'account.jpg';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    copyLinkBtn.addEventListener('click', ()=>{
      const link = location.href;
      navigator.clipboard.writeText(link).then(()=>{ copyLinkBtn.textContent='تم النسخ'; setTimeout(()=>{ copyLinkBtn.textContent='نسخ رابط الحساب'; },1200); });
    });

    function setPurchaseStatus(text, kind = '') {
      if (!purchaseStatus) return;
      purchaseStatus.textContent = text || '';
      if (kind === 'error') purchaseStatus.style.color = '#f87171';
      else if (kind === 'success') purchaseStatus.style.color = '#4ade80';
      else purchaseStatus.style.color = 'var(--muted)';
    }

    async function purchaseAccount() {
      if (!purchaseBtn) return;
      if (!ADMIN_ROUTER_BASE) {
        setPurchaseStatus('اضبط ADMIN_ROUTER_BASE لإتمام الشراء', 'error');
        return;
      }
      if (!currentUser) {
        setPurchaseStatus('سجّل الدخول لمتابعة الشراء', 'error');
        window.location.href = 'login.html';
        return;
      }
      purchaseBtn.disabled = true;
      setPurchaseStatus('جارٍ إرسال طلب الشراء...');
      try {
        const token = await currentUser.getIdToken();
        const res = await fetch(`${ADMIN_ROUTER_BASE}/accounts`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ action: 'purchase', accountId })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.ok === false) {
          throw new Error(data.error || data.message || 'تعذر إتمام الشراء');
        }
        setPurchaseStatus('تم إرسال طلب الشراء وسيتم إشعارك بعد المراجعة', 'success');
        purchaseBtn.textContent = 'تم إرسال الطلب';
      } catch (err) {
        setPurchaseStatus(err?.message || 'تعذر إتمام الشراء', 'error');
      } finally {
        purchaseBtn.disabled = false;
      }
    }

    if (purchaseBtn) purchaseBtn.addEventListener('click', purchaseAccount);

    window.addEventListener('currency:change', refreshPrice);
    window.addEventListener('currency:rates:change', refreshPrice);

    loadFeesConfig().then(refreshPrice);
    loadUserLevel().then(refreshPrice);
    loadAccount();
  </script>
</body>
</html>
