
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JS4ACC</title>
  <link rel="icon" href="emp.png" type="image/png">
  <link rel="apple-touch-icon" href="emp.png" sizes="180x180">
  <meta name="application-name" content="JS4ACC">
  <meta name="apple-mobile-web-app-title" content="JS4ACC">
  <meta name="robots" content="index, follow, max-image-preview:large">
  <link rel="canonical" href="https://z3em.shop/">
  <link rel="alternate" href="https://z3em.shop/" hreflang="ar">
  <link rel="alternate" href="https://z3em.shop/" hreflang="x-default">
  <meta name="turnstile-sitekey" content="0x4AAAAAABmiVmi7wosqeHQT">

  <!-- SEO -->
  <meta name="description" content="JS4ACC | JS4ACC — متجر موثوق لشراء حسابات الألعاب والاشتراكات الرقمية بسرعة وأمان. فري فاير، ببجي،  جواكر والمزيد بأسعار تنافسية ودعم فني سريع.">

<meta name="keywords" content="زعيم شوب, JS4ACC, موبايل ليجند, بلا لودو, جواكر, ببجي, فري فاير, بلود سترايك, وي بلاي, بلياردو, chatgpt Plus, كانفا, فيسبوك, انستجرام, تسوق, عروض, شراء حسابات, خدمات رقمية">


  <!-- Open Graph / Twitter -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://z3em.shop/">
  <meta property="og:title" content="JS4ACC">
  <meta property="og:description" content="JS4ACC (JS4ACC) — شراء حسابات الألعاب والاشتراكات الرقمية بسرعة وأمان وبأفضل الأسعار.">
  <meta property="og:image" content="https://z3em.shop/emp.png">
  <meta property="og:image:alt" content="شعار JS4ACC">
  <meta property="og:site_name" content="JS4ACC">
  <meta property="og:locale" content="ar_AR">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="JS4ACC">
  <meta name="twitter:description" content="سرعة وأمان وأسعار تنافسية عبر JS4ACC (JS4ACC).">
  <meta name="twitter:image" content="https://z3em.shop/emp.png">

  <!-- Structured data for rich sitelinks + brand card -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "JS4ACC",
    "url": "https://z3em.shop/",
    "alternateName": "z3em.shop",
    "inLanguage": "ar",
    "image": "https://z3em.shop/emp.png",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://z3em.shop/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    },
    "publisher": {
      "@type": "Organization",
      "name": "JS4ACC",
      "logo": {
        "@type": "ImageObject",
        "url": "https://z3em.shop/emp.png",
        "width": "512",
        "height": "512"
      }
    }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "JS4ACC | z3em.shop",
    "url": "https://z3em.shop/",
    "logo": "https://z3em.shop/emp.png",
    "sameAs": [
      "https://z3em.shop/"
    ]
  }
  </script>



  <!-- سكربت تثبيت الثيم مبكرًا جدًا لمنع اللمعة -->
  <script>
  (function () {
    var theme = 'dark';
    try {
      var t = localStorage.getItem('theme');
      if (!t) {
        // إذا لم يكن هناك theme في localStorage اجعله داكنًا افتراضيًا
        t = 'dark';
        try { localStorage.setItem('theme', 'dark'); } catch (_) {}
      }
      theme = (t === 'light') ? 'light' : 'dark';
    } catch (e) { theme = 'dark'; }

    var root = document.documentElement;
    root.setAttribute('data-theme', theme);

    var metaCS = document.querySelector('meta[name="color-scheme"]');
    if (!metaCS) { metaCS = document.createElement('meta'); metaCS.name = 'color-scheme'; document.head.appendChild(metaCS); }
    metaCS.setAttribute('content', theme === 'dark' ? 'dark light' : 'light dark');

    var metaTC = document.querySelector('meta[name="theme-color"]');
    if (!metaTC) { metaTC = document.createElement('meta'); metaTC.name = 'theme-color'; document.head.appendChild(metaTC); }
    metaTC.setAttribute('content', theme === 'dark' ? '#05050b' : '#f8f9fa');

    var cs = document.getElementById('critical-theme');
    if (cs) {
      cs.textContent = cs.textContent.replace(
        /color-scheme:\s*(dark|light)\s*;/,
        'color-scheme:' + (theme === 'dark' ? 'dark' : 'light') + ';'
      );
    }
  })();
  </script>



  <!-- الخطوط -->
  <!-- Load Google Fonts without blocking first paint -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet"></noscript>
  <!-- لوحة ألوان موحدة -->
  <style>
    :root{
      --font-main:'Cairo','Segoe UI Emoji','Apple Color Emoji','Noto Color Emoji','Segoe UI Symbol',sans-serif;
      --primary:#2f74e4;
      --primary-2:#3f86ff;
      --btn-bg:#2f74e4;
      --btn-bg-hover:#3f86ff;
      --accent:#1fc9ab;
      --border:rgba(63,134,255,.28);
      --card-border:#1a2235;
      --muted:#8aa4cc;
    }
    :root{
      --page-bg:#f2f3f5;
      --card-bg:#fff;
      --card-border:#d1d5db;
      --card-shadow:0 8px 24px rgba(0,0,0,.08);
      --text:#111827;
      --muted:#6b7280;
      --accent:#e11d48;
      --button-bg:#0f172a;
      --button-text:#fff;
    }
    html[data-theme="dark"]{
      --page-bg:#05070f;
      --card-bg:linear-gradient(135deg, rgba(14,20,36,.9), rgba(9,12,22,.92));
      --card-border:rgba(255,255,255,.08);
      --card-shadow:0 12px 30px rgba(0,0,0,0.5);
      --text:#e6edff;
      --muted:#9fb0c8;
      --accent:#1fc9ab;
      --button-bg:#2f74e4;
      --button-text:#fff;
    }
    .top-header{background:#0d1017;}
    .btn.primary{background:#111827;border-color:#111827;}
    .btn.ghost{border-color:var(--card-border);color:#111827;}
    .notice{background:#fff;border-color:#e5e7eb;color:#1f2937;}
    .card{border-color:var(--card-border);box-shadow:0 6px 18px rgba(15,23,42,.12);}
    .card::after{display:none;}
    .badge,.chip{color:#ef4444;}
    .filters label{color:var(--muted);}
    .transfer-modal .confirm-row{border-color:var(--card-border);}
    .settings-page{--primary:#111827;--primary-2:#1f2937;}
    .transfer-page{--t-border:#e5e7eb;--t-glow:rgba(17,24,39,.08);--t-accent:#111827;--t-primary:#111827;}
    body{background:var(--page-bg) !important;color:var(--text);font-family:var(--font-main,'Cairo','Segoe UI Emoji','Apple Color Emoji','Noto Color Emoji','Segoe UI Symbol',sans-serif);}
    /* إبقاء الشريط الجانبي باللون الأزرق الموحد في كل الصفحات */
    #sidebar{background:linear-gradient(135deg, #1f3550, #3A8BD1) !important;}
    #sidebar ul li:hover{background:rgba(255,255,255,0.2) !important;}
    #sidebar ul li i, #sidebar ul li a{color:#fff !important;}
    .search{border-color:#d1d5db !important; background:#fff !important; color:#111827 !important;}
    html[data-theme=\"dark\"] .search{border-color:#1f2937 !important; background:#0b1020 !important; color:#e6edff !important;}
    .search:focus{border-color:#111827 !important; box-shadow:0 0 0 3px rgba(17,24,39,.12) !important;}
    .support-section{background:var(--page-bg) !important;}
    .support-icon{background:var(--card-bg) !important; box-shadow:0 8px 18px rgba(0,0,0,.08) !important;}
    .support-rights a{color:var(--text) !important;}
    .footer-icons{background:#0d1017 !important;}
    .mobile-dock{background:#0d1017 !important;}
  </style>
  <style>
    #accountsWrapper{
      max-width:1180px;
      margin:0 auto 40px;
      padding:0 10px 10px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .accounts-header{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
      padding:8px 4px;
    }
    .accounts-title{
      margin:4px 0 0;
      font-size:1.3rem;
      line-height:1.4;
    }
    .accounts-groups{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .account-group{
      background:transparent;
      border:none;
      border-radius:10px;
      padding:0;
      box-shadow:none;
    }
    .account-group__header{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin:0 0 12px;
    }
    .account-group__title{
      margin:0;
      font-size:1.25rem;
      color:var(--text);
      font-weight:800;
    }
    .account-group__count{display:none;}
    .accounts-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:14px;
    }
    .account-card{
      position:relative;
      background:var(--card-bg);
      border:1px solid var(--card-border);
      border-radius:10px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      text-decoration:none;
      color:var(--text);
      box-shadow:var(--card-shadow);
      transition:transform .18s ease, box-shadow .2s ease, border-color .2s ease;
      max-width:100%;
      margin:auto;
    }
    .account-card:hover{transform:translateY(-2px);box-shadow:0 12px 28px rgba(0,0,0,0.12);border-color:#cbd5e1;}
    .account-badge{
      position:absolute;top:10px;right:10px;
      background:#ef4444;color:#fff;font-weight:800;font-size:.9rem;
      padding:6px 10px;border-radius:12px;
      box-shadow:0 8px 18px rgba(239,68,68,0.25);
    }
    .account-card:hover{
      transform:translateY(-3px);
      box-shadow:0 16px 36px rgba(0,0,0,.28);
      border-color:var(--card-border-hover, rgba(63,134,255,.4));
    }
    .account-thumb img{
      width:100%;
      max-height:240px;
      aspect-ratio:16/9;
      object-fit:cover;
      border-radius:8px;
      background:#0d1220;
      border:1px solid var(--card-border);
    }
    .account-actions{display:flex;justify-content:flex-end;}
    .account-actions .btn{
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;
      background:var(--button-bg);
      color:var(--button-text);
      padding:5px 18px;
      font-size:.9rem;
      border-radius:6px;
      cursor:pointer;
      font-weight:700;
      transition:.2s;
      text-decoration:none;
      text-align:center;
    }
    .account-actions .btn:hover{filter:brightness(0.95);}
    /* تفاصيل الحساب */
    #accountModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,7,15,0.7);backdrop-filter:blur(4px);z-index:10000;padding:16px;}
    #accountModal .modal-card{background:#0c1020;border:1px solid rgba(255,255,255,0.08);border-radius:18px;max-width:820px;width:100%;max-height:90vh;overflow:auto;padding:18px;box-shadow:0 18px 60px rgba(0,0,0,0.5);color:#e6edff;}
    html[data-theme="light"] #accountModal .modal-card{background:#fff;color:#111827;border-color:#e5e7eb;box-shadow:0 18px 60px rgba(15,23,42,0.22);}
    #accountModal .modal-head{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    #accountModal .modal-close{border:none;background:rgba(255,255,255,0.08);color:#fff;border-radius:50%;width:36px;height:36px;cursor:pointer;}
    #accountModal .modal-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:12px;}
    #accountModal .modal-grid img{width:100%;border-radius:12px;aspect-ratio:16/9;object-fit:cover;background:#0f1528;}
    #accountModal .modal-body{margin-top:10px;line-height:1.6;font-size:0.98rem;color:#cdd5e9;}
    #accountModal .price{font-weight:800;color:#1fc9ab;}
    .account-body{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .account-meta{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      color:var(--muted);
      font-size:.95rem;
      font-weight:700;
    }
    .account-cat{
      background:#fff7ed;
      color:#b45309;
      padding:4px 10px;
      border-radius:999px;
      font-size:.88rem;
      border:1px solid #fed7aa;
    }
    .account-title{
      margin:0;
      font-size:1rem;
      font-weight:800;
      text-align:center;
      color:var(--text);
    }
    .account-desc{
      margin:0;
      color:var(--muted);
      font-size:.95rem;
      line-height:1.5;
      text-align:center;
    }
    .account-contact{
      font-size:.92rem;
      color:var(--muted, #9fb0c8);
    }
    .account-price{
      color:var(--accent);
      font-weight:800;
    }
    @media(max-width:640px){
      #accountsWrapper{padding-inline:6px;}
      .accounts-grid{grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
      .accounts-title{font-size:1.1rem;}
      .account-actions{justify-content:center;}
      .account-actions .btn{
        display:inline-flex;
        width:auto;
        min-width:170px;
        max-width:220px;
        padding:5px 20px;
        font-size:.85rem;
        border-radius:8px;
        margin-inline:auto;
      }
    }
  </style>

  <!-- الأيقونات -->
  <!-- Load Font Awesome without blocking first paint -->
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" /></noscript>

  <!-- CSS -->
  <link rel="preload" href="header.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="loader.css">

  <!-- Scripts -->
  <!-- Ensure minimum 300ms loader on home (index) -->
  <script>
    (function(){
      try {
        sessionStorage.setItem('nav:loader:expected','1');
        sessionStorage.setItem('nav:loader:showAt', String(Date.now()));
      } catch (_) {}
    })();
  </script>
  <script src="header.js" defer></script>
  <script src="loader.js" defer></script>
  <script src="reviews-inline.js" defer></script>
  <script src="wallet-inline.js" defer></script>
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js" async></script>
  <script>window.ADMIN_ROUTER_BASE = 'https://js4acc.laithqarqaz1.workers.dev/';</script>
    

  <meta name="color-scheme" content="dark light">

  <style id="critical-theme">
    :root { color-scheme: light; }
    html[data-theme="dark"]  { background: #05050b; color:#f0f1ff; }
    html[data-theme="light"] { background: #f8f9fa; color:#1b1d3b; }
    html, body { margin:0; padding:0; overflow-x:hidden; }
    body { background: inherit; color: inherit; }
  </style>
  
  <!-- Styles for inline-loaded pages: auto ribbon, premium cards -->
  <style>
  /* Auto ribbon like FREEFIREINBUT */
  a.card.auto{position:relative;overflow:hidden}
  a.card.auto::before {
    content: "تلقائي";
    position: absolute;
    top: 12px;
    right: -50px;
    width: 160px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: .9rem;
    color: #fff;
    background:
      linear-gradient(180deg, rgba(255,255,255,.28), rgba(255,255,255,0) 60%),
      linear-gradient(135deg,#3A8BD1,#66aee9);
    transform: rotate(45deg);
    border-radius: 10px;
    text-shadow: 0 1px 1px rgba(0,0,0,.25);
    box-shadow: 0 10px 20px rgba(0,0,0,.18),
                inset 0 1px 0 rgba(255,255,255,.25),
                inset 0 -1px 0 rgba(0,0,0,.15);
    pointer-events: none;
    z-index: 3;
  }
  @keyframes ribbonShift{
    0%   { background-position: 0 0, 0% 50%; }
    50%  { background-position: 0 0, 100% 50%; }
    100% { background-position: 0 0, 0% 50%; }
  }
  @media (prefers-reduced-motion: reduce){ a.card.auto::before{ animation:none } }
  html[data-theme="dark"] a.card.auto::before{
    background:
      linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,0) 60%),
      linear-gradient(135deg,#2867A5,#3A8BD1);
    background-size:100% 100%, 200% 100%;
    background-position:0 0, 0% 50%;
  }
  /* Premium visual enhancements for .card.auto */
  a.card.auto{
    border:1.5px solid transparent;
    background:
      linear-gradient(var(--card-bg),var(--card-bg)) padding-box,
      linear-gradient(135deg,#3A8BD1,#66aee9) border-box;
    box-shadow:0 8px 22px rgba(0,0,0,.12), 0 1px 0 rgba(255,255,255,.04) inset;
    transition:transform .25s ease, box-shadow .35s ease, filter .25s ease;
    animation:none;
  }
  html[data-theme="dark"] a.card.auto{
    background:
      linear-gradient(var(--card-bg),var(--card-bg)) padding-box,
      linear-gradient(135deg,#2867A5,#3A8BD1) border-box;
    box-shadow:0 10px 26px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.04) inset;
  }
  @keyframes luxPulse{
    0%,100%{box-shadow:0 8px 22px rgba(0,0,0,.12), 0 0 0 0 rgba(250,204,21,.0)}
    50%{box-shadow:0 12px 34px rgba(0,0,0,.16), 0 0 24px 0 rgba(250,204,21,.18)}
  }
  a.card.auto img{transition:transform .45s ease, filter .35s ease; will-change:transform}
  a.card.auto:hover img{transform:scale(1.06) translateY(-2px); filter:saturate(1.08) contrast(1.05)}
  a.card.auto:not(.pending-state):not(.maintenance)::after{
    content:""; position:absolute; inset:-20% -120% -20% -120%;
    background:linear-gradient(115deg, transparent 45%, rgba(255,255,255,.38) 50%, transparent 55%);
    transform:translateX(-20%) rotate(12deg);
    pointer-events:none; z-index:1;
    opacity:0;
    animation:none;
    transition:opacity .35s ease;
  }
  @keyframes luxSweep{ 0%{transform:translateX(-20%) rotate(12deg)} 100%{transform:translateX(120%) rotate(12deg)} }
  @media (hover:hover){
    a.card.auto:hover,
    a.card.auto:focus-visible{
      animation:luxPulse 3.6s ease-in-out infinite;
    }
    a.card.auto:hover:not(.pending-state):not(.maintenance)::after,
    a.card.auto:focus-visible:not(.pending-state):not(.maintenance)::after{
      opacity:1;
      animation:luxSweep 2.2s linear forwards;
    }
  }
  @media (hover:none){
    a.card.auto:active:not(.pending-state):not(.maintenance)::after{
      opacity:1;
      animation:luxSweep 2.2s linear forwards;
    }
  }
  @media (prefers-reduced-motion: reduce){
    a.card.auto::after{animation:none}
    a.card.auto:hover,
    a.card.auto:focus-visible{ animation:none; }
  }
  a.card.auto:hover{ transform:translateY(-4px) scale(1.01); box-shadow:0 16px 36px rgba(0,0,0,.18), 0 0 28px rgba(250,204,21,.16) }
  @media (max-width: 600px){
    a.card.auto::before{
      width: 120px;
      height: 26px;
      top: 10px;
      right: -38px;
      font-size: .72rem;
      border-radius: 8px;
    }
  }

  /* Inline page chrome */
  #inlinePage{margin-top:10px}
  /* toolbar disabled per request */
  .inline-toolbar{display:none}
  .inline-back{display:none}
  .inline-title{display:none}
  </style>

  <!-- Reviews page inline styles -->
  <style>
    .reviews-page{padding:0 16px 48px;}
    .reviews-page .reviews-spacer{height:70px;}
    @media(max-width:720px){.reviews-page .reviews-spacer{height:54px;}}
    .reviews-page *{box-sizing:border-box;}
    .reviews-page main{max-width:960px;margin:30px auto;background:#fff;border-radius:10px;padding:30px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
    @media(max-width:720px){.reviews-page main{margin:20px 15px;padding:20px;}}
    .reviews-page .review-form{margin-bottom:40px;position:relative;}
    .reviews-page .user-name{font-weight:bold;margin-bottom:10px;color:#2867A5;}
    .reviews-page .stars{display:flex;justify-content:flex-start;gap:0;font-size:30px;cursor:pointer;color:#ccc;user-select:none;}
    .reviews-page .stars .selected{color:#ffb400;text-shadow:0 0 5px #ffb400aa;}
    .reviews-page textarea{width:100%;min-height:100px;padding:12px 15px;font-size:16px;border-radius:8px;border:1px solid #ddd;margin-top:15px;resize:vertical;transition:border-color .3s ease;}
    .reviews-page textarea:focus{outline:none;border-color:#2867A5;box-shadow:0 0 8px #2867A544;}
    .reviews-page .code-preview{position:absolute;bottom:-30px;right:0;left:0;background-color:rgba(0,123,255,.1);padding:8px 15px;border-radius:8px;color:#555;font-size:14px;opacity:.7;transition:opacity .3s;pointer-events:none;display:none;}
    .reviews-page button{margin-top:20px;background-color:#2867A5;color:#fff;padding:12px 25px;font-size:18px;border:none;border-radius:8px;cursor:pointer;transition:background-color .3s ease;display:block;width:100%;}
    .reviews-page button:disabled{background-color:#9fb6ce;cursor:not-allowed;}
    .reviews-page button:hover:not(:disabled){background-color:#2867A5;}
    .reviews-page .rating-filters{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;}
    .reviews-page .rating-filter{background:#f0f2f5;border:1px solid #ddd;border-radius:20px;padding:8px 15px;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:5px;}
    .reviews-page .rating-filter:hover{background:#e0e3e7;}
    .reviews-page .rating-filter.active{background:#2867A5;color:#fff;border-color:#2867A5;}
    .reviews-page .rating-filter .stars{font-size:16px;gap:0;color:inherit;}
    .reviews-page .rating-filter .count{font-size:14px;opacity:.8;}
    .reviews-page .reviews-list{max-height:800px;overflow-y:auto;padding-right:10px;}
    .reviews-page .review-item{position:relative;border-bottom:1px solid #eee;padding:12px 0;display:block;}
    .reviews-page .review-item:last-child{border-bottom:none;}
    .reviews-page .header-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#3A8BD1,#9dc5e8);color:#fff;font-weight:800;display:inline-flex;align-items:center;justify-content:center;user-select:none;flex:0 0 28px;margin-inline-end:6px;}
    .reviews-page .header-avatar.small{width:22px;height:22px;font-size:12px;flex:0 0 22px;}
    .reviews-page .review-main{min-width:0;}
    .reviews-page .review-header{display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap;}
    .reviews-page .review-header .username{font-weight:800;color:#2867A5;}
    .reviews-page .review-header .time{font-size:12px;color:#7a8694;}
    .reviews-page .review-header .sep{opacity:.6;}
    .reviews-page .mini-stars{display:inline-flex;gap:2px;margin-inline-start:6px;}
    .reviews-page .mini-stars i{font-size:12px;color:#ffb400;}
    .reviews-page .review-user,
    .reviews-page .review-code,
    .reviews-page .review-stars{display:none;}
    .reviews-page .review-text{font-size:17px;line-height:1.5;white-space:pre-wrap;color:#444;}
    .reviews-page .review-date{font-size:13px;color:#999;margin-top:6px;}
    .reviews-page .review-actions{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap;}
    .reviews-page .vote-btn{display:inline-flex!important;align-items:center;gap:6px;padding:4px 10px;border-radius:18px;border:1px solid #ddd;background:#f7f8fa!important;cursor:pointer;font-size:13px;line-height:1;width:auto!important;box-shadow:none!important;}
    .reviews-page .vote-btn i{color:#64748b;font-size:14px;}
    .reviews-page .vote-btn.active{background:#e6f4ff;border-color:#eef0ff;}
    .reviews-page .vote-count{font-weight:700;color:#2867A5;}
    .reviews-page .vote-btn.reply .reply-label{margin-inline-start:4px;}
    .reviews-page .reply-box{display:none;margin-top:8px;flex-basis:100%;width:100%;background:linear-gradient(180deg,#f9fcff,#f1f7ff);border:1px solid #eceeff;border-radius:14px;padding:14px 16px;box-shadow:0 4px 14px rgba(91,143,194,0.12);flex-direction:column;gap:10px;transition:box-shadow .2s ease,border-color .2s ease;}
    .reviews-page .reply-box.open{display:flex;}
    .reviews-page .reply-box .reply-input{width:100%;background:#fff;color:#111827;border:1px solid #cbd5e1;border-radius:12px;padding:12px 14px;outline:none;transition:border-color .2s ease,box-shadow .2s ease;min-height:120px;resize:vertical;font-size:15px;line-height:1.6;}
    .reviews-page .reply-box .reply-input:focus{border-color:#3A8BD1;box-shadow:0 0 0 3px rgba(91,143,194,.20);}
    .reviews-page .reply-box .reply-input::placeholder{color:#5b8fc2;}
    .reviews-page .reply-box .send-reply{margin-top:8px;width:auto!important;display:inline-flex!important;padding:10px 16px;font-size:15px;background:linear-gradient(135deg,#3A8BD1,#2867A5);color:#fff;border:none;border-radius:12px;cursor:pointer;box-shadow:0 4px 12px rgba(2,132,199,.25);transition:transform .15s ease,filter .15s ease,box-shadow .2s ease;align-self:flex-start;}
    .reviews-page .reply-box .send-reply:hover{filter:brightness(1.05);transform:translateY(-1px);}
    .reviews-page .reply-box .send-reply:active{transform:translateY(0);}
    .reviews-page .reply-box .cancel-reply{margin-top:8px;width:auto!important;display:inline-flex!important;padding:10px 16px;font-size:14px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;color:#475569;cursor:pointer;}
    .reviews-page .replies{margin-top:10px;background:transparent;border:0;padding:0;}
    .reviews-page .replies.collapsed{display:none;}
    .reviews-page .replies-list{margin-top:8px;margin-inline-start:16px;padding-inline-start:14px;border-inline-start:2px solid #e5e7eb;}
    .reviews-page .reply-item{margin-top:10px;}
    .reviews-page .reply-meta{font-size:12px;color:#666;}
    .reviews-page .reply-actions{display:flex;align-items:center;gap:14px;margin-top:6px;}
    .reviews-page .reply-link{background:transparent!important;border:0!important;padding:0!important;margin:0!important;color:#2867A5!important;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;line-height:1;width:auto!important;box-shadow:none!important;border-radius:0!important;}
    .reviews-page .reply-link:hover{text-decoration:underline;}
    .reviews-page .reply-text{white-space:pre-wrap;color:#333;}
    .reviews-page .reviews-list .vote-btn,
    .reviews-page .reviews-list .send-reply,
    .reviews-page .reviews-list .cancel-reply{width:auto!important;display:inline-flex!important;}
    .reviews-page .reviews-list .review-actions .vote-btn:empty{display:none!important;}
    .reviews-page .reviews-list .review-actions .vote-btn.reply i{font-size:14px;}
    .reviews-page .reviews-list::-webkit-scrollbar{width:8px;}
    @media (max-width: 720px){
      .reviews-page main{margin:26px 0 32px;padding:22px;border-radius:14px;}
      .reviews-page .reviews-spacer{height:54px;}
      .reviews-page .review-form{margin-bottom:30px;}
      .reviews-page textarea{min-height:120px;}
      .reviews-page .rating-filters{margin-bottom:16px;overflow-x:auto;gap:8px;scrollbar-width:none;}
      .reviews-page .rating-filters::-webkit-scrollbar{display:none;}
      .reviews-page .rating-filter{flex:0 0 auto;}
      .reviews-page .reviews-list{max-height:none;padding-right:0;}
      .reviews-page .review-item{padding:14px 0;}
      .reviews-page .review-header{gap:6px;}
    }
    @media (max-width: 540px){
      .reviews-page main{margin:20px 0 28px;padding:20px;}
      .reviews-page .reviews-spacer{height:42px;}
      .reviews-page .stars{font-size:26px;}
      .reviews-page textarea{font-size:15px;}
      .reviews-page button{font-size:16px;padding:11px 20px;}
      .reviews-page .rating-filter{padding:7px 12px;font-size:13px;}
      .reviews-page .rating-filter .count{font-size:12px;}
      .reviews-page .review-item{padding:12px 0;border-bottom:1px solid #eceff7;margin:0;}
      .reviews-page .review-item:last-child{border-bottom:none;}
      .reviews-page .review-header{flex-direction:column;align-items:flex-start;gap:4px;}
      .reviews-page .review-text{font-size:15px;line-height:1.55;}
      .reviews-page .review-actions{gap:6px;}
      .reviews-page .vote-btn{padding:6px 10px;font-size:12px;}
      .reviews-page .vote-btn i{font-size:12px;}
      .reviews-page .vote-count{font-size:12px;}
      .reviews-page .review-date{font-size:12px;}
    }
    .reviews-page .reviews-list::-webkit-scrollbar-track{background:#f1f1f1;border-radius:4px;}
    .reviews-page .reviews-list::-webkit-scrollbar-thumb{background:#2867A5;border-radius:4px;}
    body.dark-mode .reviews-page main{background:#0f1024;box-shadow:0 6px 18px rgba(0,0,0,.45);color:#f0f1ff;}
    body.dark-mode .reviews-page .user-name,
    body.dark-mode .reviews-page .review-user{color:#66aee9;}
    body.dark-mode .reviews-page .stars{color:#64748b;}
    body.dark-mode .reviews-page .stars .selected,
    body.dark-mode .reviews-page .review-stars{color:#fbbf24;text-shadow:0 0 6px #fbbf2499;}
    body.dark-mode .reviews-page textarea{background:#05050b;color:#f0f1ff;border-color:#2b2d52;}
    body.dark-mode .reviews-page textarea:focus{border-color:#9dc5e8;box-shadow:0 0 8px #9dc5e855;}
    body.dark-mode .reviews-page button{background:linear-gradient(135deg,#3A8BD1,#2867A5);color:#f0f1ff;}
    body.dark-mode .reviews-page button:hover:not(:disabled){background:#2867A5;}
    body.dark-mode .reviews-page button:disabled{background-color:#1f3550;}
    body.dark-mode .reviews-page .rating-filter{background:#0e1623;border-color:#2b2d52;color:#f0f1ff;}
    body.dark-mode .reviews-page .rating-filter:hover{background:#0c1420;}
    body.dark-mode .reviews-page .rating-filter.active{background:#3A8BD1;border-color:#3A8BD1;color:#05050b;}
    body.dark-mode .reviews-page .review-text{color:#dbe2ea;}
    body.dark-mode .reviews-page .review-date{color:#5b8fc2;}
    body.dark-mode .reviews-page .review-header .username{color:#66aee9;}
    body.dark-mode .reviews-page .review-header .time{color:#9fb0c5;}
    body.dark-mode .reviews-page .vote-btn{background:#0e1623!important;border-color:#2b2d52;color:#f0f1ff;}
    body.dark-mode .reviews-page .vote-btn i{color:#9aa9bc;}
    body.dark-mode .reviews-page .vote-btn.active{background:#1c1d38;border-color:#414391;}
    body.dark-mode .reviews-page .reply-box{background:#05050b;border-color:#2b2d52;box-shadow:0 4px 14px rgba(0,0,0,.45);}
    body.dark-mode .reviews-page .reply-box .reply-input{background:#0e1623;color:#f0f1ff;border-color:#2b2d52;}
    @media (max-width: 540px){
      body.dark-mode .reviews-page .review-item{background:transparent;border-bottom-color:#20294a;}
    }
    body.dark-mode .reviews-page .reply-box .reply-input:focus{border-color:#9dc5e8;box-shadow:0 0 0 3px rgba(56,189,248,.25);}
    body.dark-mode .reviews-page .reply-box .cancel-reply{background:#0e1623;color:#cbd5e1;border-color:#2b2d52;}
    body.dark-mode .reviews-page .replies{background:transparent;border-color:transparent;}
    body.dark-mode .reviews-page .replies-list{border-inline-start-color:#2b2d52;}
    body.dark-mode .reviews-page .reply-text{color:#dbe2ea;}
    body.dark-mode .reviews-page .reviews-list::-webkit-scrollbar-track{background:#05050b;}
    body.dark-mode .reviews-page .reviews-list::-webkit-scrollbar-thumb{background:#3A8BD1;}
  </style>

  <!-- Wallet page inline styles -->
  <style>
    .wallet-page{padding:0 16px 56px;}
    .wallet-page .wallet-spacer{height:72px;}
    @media(max-width:720px){.wallet-page .wallet-spacer{height:54px;}}
    .wallet-page main{
      max-width:980px;
      margin:32px auto;
      background:#ffffff;
      border-radius:22px;
      padding:32px;
      border:1px solid rgba(148,163,184,.28);
      box-shadow:0 24px 60px rgba(15,23,42,.12);
    }
    @media(max-width:720px){.wallet-page main{margin:20px 12px;padding:22px;}}
    .wallet-page h2{
      margin:0 0 18px;
      font-size:1.7rem;
      color:#2563eb;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .wallet-page .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;}
    .wallet-page .chip{
      padding:7px 14px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:#fff;
      cursor:pointer;
      font-weight:700;
      transition:.2s;
    }
    .wallet-page .chip.active{box-shadow:0 0 0 2px rgba(59,130,246,.18);}
    .wallet-page .chip[data-filter="all"].active{background:#e6f4ff;border-color:#3A8BD1;color:#1e3a8a;}
    .wallet-page .chip[data-filter="pending"]{background:#fff7ed;border-color:#fed7aa;color:#7c2d12;}
    .wallet-page .chip[data-filter="pending"].active{background:#fde7c7;border-color:#fb923c;}
    .wallet-page .chip[data-filter="approved"]{background:#dcfce7;border-color:#86efac;color:#065f46;}
    .wallet-page .chip[data-filter="approved"].active{background:#bbf7d0;border-color:#22c55e;}
    .wallet-page .chip[data-filter="rejected"]{background:#fee2e2;border-color:#fecaca;color:#7f1d1d;}
    .wallet-page .chip[data-filter="rejected"].active{background:#fecaca;border-color:#ef4444;}
    .wallet-page .list{display:flex;flex-direction:column;gap:18px;margin-top:16px;}
    .wallet-page .card{
      position:relative;
      background:linear-gradient(135deg,rgba(248,249,255,.95),rgba(255,255,255,.92));
      border:1px solid rgba(148,163,184,.18);
      border-radius:22px;
      padding:22px 24px;
      display:flex;
      flex-direction:column;
      gap:18px;
      box-shadow:0 18px 48px rgba(15,23,42,.08);
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      overflow:hidden;
    }
    .wallet-page .card:hover{transform:translateY(-4px);box-shadow:0 24px 58px rgba(15,23,42,.12);}
    .wallet-page .card.selected{border-color:#3A8BD1;box-shadow:0 0 0 2px rgba(59,130,246,.18),0 24px 60px rgba(59,130,246,.12);}
    .wallet-page .txn-body{display:flex;align-items:flex-start;gap:20px;}
    .wallet-page .txn-amount{min-width:150px;}
    .wallet-page .txn-value{
      display:flex;
      align-items:baseline;
      gap:6px;
      font-weight:800;
      font-size:1.52rem;
      color:#111827;
    }
    .wallet-page .txn-amount.positive .txn-value{color:#15803d;}
    .wallet-page .txn-amount.negative .txn-value{color:#dc2626;}
    .wallet-page .txn-value .currency{font-size:.95rem;font-weight:600;opacity:.85;}
    .wallet-page .txn-balances{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.85rem;
      font-weight:600;
    }
    .wallet-page .balance-after{color:#16a34a;}
    .wallet-page .balance-before{color:#dc2626;text-decoration:line-through;}
    .wallet-page .txn-middle{flex:1;display:flex;flex-direction:column;gap:10px;}
    .wallet-page .txn-title-row{display:flex;flex-wrap:wrap;align-items:center;gap:10px;}
    .wallet-page .txn-title{font-size:1.12rem;font-weight:800;color:#1f2937;}
    .wallet-page .status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 12px;
      border-radius:999px;
      font-weight:700;
      font-size:.85rem;
      border:1px solid transparent;
      background:#e6f4ff;
      color:#1e4ed8;
    }
    .wallet-page .status.pending{background:#fff7ed;color:#b45309;border-color:#fdba74;}
    .wallet-page .status.approved{background:#dcfce7;color:#047857;border-color:#34d399;}
    .wallet-page .status.rejected{background:#fee2e2;color:#b91c1c;border-color:#fca5a5;}
    .wallet-page .txn-meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      color:#475569;
      font-size:.92rem;
    }
    .wallet-page .txn-meta span{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(59,130,246,.08);
      color:#1f4b99;
      font-weight:600;
    }
    .wallet-page .txn-meta span i{color:#3A8BD1;}
    .wallet-page .txn-action{
      width:48px;
      height:48px;
      border-radius:50%;
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#edf2ff;
      color:#1e4ed8;
      cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
    }
    .wallet-page .txn-action.deposit{background:rgba(34,197,94,.12);color:#047857;}
    .wallet-page .txn-action.withdraw{background:rgba(248,113,113,.16);color:#f87171;}
    .wallet-page .txn-action:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(59,130,246,.18);}
    @media(max-width:640px){
      .wallet-page .txn-body{flex-direction:column;align-items:flex-start;gap:16px;}
      .wallet-page .txn-action{align-self:flex-end;}
      .wallet-page .txn-title-row{align-items:flex-start;}
    }
    .wallet-page .code-btn{
      border:none;
      background:#e6f4ff;
      color:#1e4ed8;
      border-radius:10px;
      padding:6px 12px;
      font-weight:700;
      cursor:pointer;
      transition:.2s;
    }
    .wallet-page .code-btn:hover{background:#dbe4ff;}
    .wallet-page .code-status-btn{border:none;background:transparent;padding:0;}
    .wallet-page .txn-footer{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:center;
      font-size:.9rem;
      color:#475569;
    }
    .wallet-page .txn-footer i{color:#3A8BD1;}
    .wallet-page .txn-proof a{color:#2563eb;text-decoration:none;font-weight:700;}
    .wallet-page .empty{
      padding:26px;
      text-align:center;
      border:1px dashed rgba(148,163,184,.45);
      border-radius:18px;
      background:rgba(248,249,255,.85);
      color:#525f7f;
    }
    .wallet-page .loading{position:relative;overflow:hidden;pointer-events:none;}
    .wallet-page .loading::after{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.6),transparent);
      animation:wallet-shimmer 1.2s infinite;
    }
    @keyframes wallet-shimmer{
      0%{transform:translateX(-100%);}
      100%{transform:translateX(100%);}
    }
    body.dark-mode .wallet-page main{
      background:#0c1424;
      border-color:#1e2a44;
      box-shadow:0 32px 60px rgba(0,0,0,.55);
    }
    body.dark-mode .wallet-page .chip{background:#101b33;border-color:#1f2a44;color:#e2e8f0;}
    body.dark-mode .wallet-page .chip[data-filter="all"].active{background:#1c2746;border-color:#2867A5;color:#bcdcff;}
    body.dark-mode .wallet-page .chip[data-filter="pending"]{background:#2b2f3a;border-color:#a16207;color:#fde68a;}
    body.dark-mode .wallet-page .chip[data-filter="approved"]{background:#064e3b;border-color:#047857;color:#bbf7d0;}
    body.dark-mode .wallet-page .chip[data-filter="rejected"]{background:#3f1d1d;border-color:#7f1d1d;color:#fecaca;}
    body.dark-mode .wallet-page .card{
      background:rgba(15,23,42,.9);
      border-color:#1f2a44;
      box-shadow:0 24px 60px rgba(0,0,0,.55);
    }
    body.dark-mode .wallet-page .card:hover{box-shadow:0 30px 72px rgba(0,0,0,.6);}
    body.dark-mode .wallet-page .card.selected{border-color:#2867A5;box-shadow:0 0 0 2px rgba(59,130,246,.35);}
    body.dark-mode .wallet-page .txn-value{color:#f8fafc;}
    body.dark-mode .wallet-page .txn-amount.positive .txn-value{color:#4ade80;}
    body.dark-mode .wallet-page .txn-amount.negative .txn-value{color:#fca5a5;}
    body.dark-mode .wallet-page .balance-after{color:#34d399;}
    body.dark-mode .wallet-page .balance-before{color:#f87171;}
    body.dark-mode .wallet-page .txn-title{color:#e2e8f0;}
    body.dark-mode .wallet-page .txn-meta{color:#c7e2ff;}
    body.dark-mode .wallet-page .txn-meta span{background:rgba(59,130,246,.22);color:#c3dcf4;}
    body.dark-mode .wallet-page .txn-meta span i{color:#9dc5e8;}
    body.dark-mode .wallet-page .status{background:#1f2a44;color:#c3dcf4;border-color:#1f4b99;}
    body.dark-mode .wallet-page .status.pending{background:rgba(234,179,8,.12);color:#fde68a;border-color:#ca8a04;}
    body.dark-mode .wallet-page .status.approved{background:rgba(34,197,94,.18);color:#86efac;border-color:#22c55e;}
    body.dark-mode .wallet-page .status.rejected{background:rgba(248,113,113,.2);color:#fca5a5;border-color:#f87171;}
    body.dark-mode .wallet-page .txn-action{background:#1f2a44;color:#94a3b8;}
    body.dark-mode .wallet-page .txn-action.deposit{background:rgba(22,163,74,.28);color:#4ade80;}
    body.dark-mode .wallet-page .txn-action.withdraw{background:rgba(239,68,68,.28);color:#fca5a5;}
    body.dark-mode .wallet-page .txn-footer{color:#c7e2ff;}
    body.dark-mode .wallet-page .txn-footer i{color:#9dc5e8;}
    body.dark-mode .wallet-page .txn-proof a{color:#bcdcff;}
    body.dark-mode .wallet-page .empty{background:#121c33;border-color:#1f2a44;color:#d1e5ff;}
    .transfer-page{
      --t-bg:#060917;
      --t-card:#0d1025;
      --t-panel:#0f1634;
      --t-border:rgba(59,130,246,.26);
      --t-glow:rgba(59,130,246,.45);
      --t-text:#f7f8ff;
      --t-muted:rgba(226,232,240,.8);
      --t-accent:#6dd3ff;
      --t-primary:#2867A5;
      --t-success:#34d399;
      --t-danger:#f87171;
      padding:0 18px 86px;
      background:radial-gradient(circle at 12% -10%, rgba(109,211,255,.12), transparent 28%), radial-gradient(circle at 88% -8%, rgba(59,130,246,.14), transparent 32%);
    }
    .transfer-page .transfer-spacer{height:72px;}
    @media(max-width:720px){.transfer-page .transfer-spacer{height:54px;}}
    .transfer-page main{
      max-width:940px;
      width:100%;
      margin:32px auto;
      background:linear-gradient(150deg,#0a0f25 0%,#0d1432 40%,#0b1029 100%);
      border-radius:32px;
      border:1px solid var(--t-border);
      padding:40px 42px 46px;
      box-shadow:0 36px 80px rgba(0,0,0,.62), 0 0 0 1px rgba(255,255,255,.02);
      color:var(--t-text);
      position:relative;
      overflow:visible;
      isolation:isolate;
    }
    .transfer-page main::before,
    .transfer-page main::after{
      content:'';
      position:absolute;
      inset:auto;
      width:320px;
      height:320px;
      border-radius:50%;
      filter:blur(60px);
      opacity:.6;
      z-index:0;
      pointer-events:none;
    }
    .transfer-page main::before{right:-120px;top:-140px;background:radial-gradient(circle,rgba(109,211,255,.32),transparent 60%);}
    .transfer-page main::after{left:-140px;bottom:-180px;background:radial-gradient(circle,rgba(59,130,246,.26),transparent 60%);}
    .transfer-page main > *{position:relative;z-index:1;}
    @media(max-width:720px){
      .transfer-page main{
        margin:22px 8px;
        padding:22px;
        border-radius:32px;
        max-width:100%;
        width:100%;
        background:linear-gradient(150deg,#0a0f25 0%,#0d1432 40%,#0b1029 100%);
      }
    }
    html[data-theme="light"] .transfer-page main,
    body.light-mode .transfer-page main{
      background:#f5f7ff;
      border-color:rgba(148,163,184,.28);
      color:#0f172a;
      box-shadow:0 28px 70px rgba(15,23,42,.12);
    }
    html[data-theme="light"] .transfer-page{--t-text:#0f172a;--t-muted:#475569;--t-card:#f8fafc;--t-panel:#e6f4ff;--t-border:rgba(148,163,184,.4);}
    .transfer-page h2{
      margin:0 0 6px;
      font-size:1.95rem;
      display:flex;
      align-items:center;
      gap:10px;
      color:inherit;
      letter-spacing:.01em;
    }
    .transfer-page .transfer-subtitle{
      margin:0 0 16px;
      color:var(--t-muted);
      font-weight:600;
      letter-spacing:.01em;
    }
    .transfer-page .transfer-headline{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .transfer-page .transfer-badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 16px;
      border-radius:18px;
      font-weight:800;
      font-size:.94rem;
      background:rgba(52,211,153,.14);
      color:var(--t-success);
      box-shadow:0 12px 28px rgba(52,211,153,.16);
      border:1px solid rgba(52,211,153,.22);
    }
    .transfer-page .transfer-badge.soft{
      background:rgba(59,130,246,.18);
      color:#cde9ff;
      border-color:rgba(59,130,246,.28);
      box-shadow:0 10px 24px rgba(59,130,246,.18);
    }
    .transfer-page .transfer-hint{
      margin:0;
      font-size:1rem;
      color:var(--t-muted);
      line-height:1.7;
      flex:1;
    }
    .transfer-page .transfer-meta{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:18px;
      margin:14px 0 18px;
    }
    .transfer-page .transfer-meta .card{
      position:relative;
      overflow:hidden;
      border-radius:22px;
      padding:18px 16px 20px;
      background:var(--t-panel);
      border:1px solid rgba(109,211,255,.2);
      box-shadow:0 18px 40px rgba(0,0,0,.48), inset 0 1px 0 rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      gap:12px;
      transition:transform .2s ease, box-shadow .2s ease;
      min-height:118px;
    }
    .transfer-page .transfer-meta .card:hover{transform:translateY(-6px);box-shadow:0 24px 52px rgba(0,0,0,.55);}
    .transfer-page .transfer-meta .card .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 16px;
      border-radius:14px;
      border:1px solid rgba(109,211,255,.2);
      background:rgba(255,255,255,.03);
      backdrop-filter:blur(4px);
    }
    .transfer-page .transfer-meta .card .title{
      font-size:1rem;
      color:var(--t-muted);
      font-weight:800;
      letter-spacing:.04em;
    }
    .transfer-page .transfer-meta .card .value{
      font-size:1.42rem;
      font-weight:900;
      color:var(--t-text);
      text-align:center;
      letter-spacing:.025em;
      padding:12px 12px 8px;
    }
    .transfer-page .transfer-meta .card .code{font-family:monospace;letter-spacing:.04em;}
    .transfer-page .copy-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 12px;
      border-radius:12px;
      background:rgba(109,211,255,.14);
      color:var(--t-text);
      border:1px solid rgba(109,211,255,.35);
      font-weight:800;
      font-size:.85rem;
      cursor:pointer;
      transition:transform .15s ease, box-shadow .15s ease, opacity .15s ease;
    }
    .transfer-page .copy-chip:hover{transform:translateY(-1px);box-shadow:0 10px 24px rgba(109,211,255,.32);}
    .transfer-page .copy-chip:active{transform:translateY(0);}
    .transfer-recipient{
      display:flex;
      align-items:flex-start;
      gap:14px;
      background:var(--t-panel);
      border:1px solid rgba(109,211,255,.32);
      border-radius:20px;
      padding:14px 16px;
      margin:14px 0 10px;
      box-shadow:0 22px 45px rgba(4,7,18,.58);
    }
    html[data-theme="light"] .transfer-recipient{background:#e6f4ff;border-color:rgba(109,123,255,.32);box-shadow:0 18px 40px rgba(15,23,42,.08);}
    .transfer-recipient .recipient-badge{
      background:rgba(52,211,153,.18);
      color:var(--t-success);
      padding:6px 10px;
      border-radius:10px;
      font-weight:800;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .transfer-recipient .recipient-body{flex:1;min-width:0;}
    .transfer-recipient .recipient-name{
      margin:0 0 6px;
      font-weight:800;
      font-size:1.05rem;
      color:var(--t-text);
    }
    .transfer-recipient .recipient-hint{
      margin:0;
      font-weight:600;
      color:var(--t-muted);
    }
    .transfer-recipient[data-state="loading"] .recipient-name{color:#c7e2ff;}
    .transfer-recipient[data-state="error"]{border-color:rgba(248,113,113,.45);background:rgba(127,29,29,.28);}
    html[data-theme="light"] .transfer-recipient[data-state="error"]{background:#fef2f2;border-color:rgba(248,113,113,.55);}
    .transfer-recipient .recipient-refresh{
      border:none;
      background:rgba(109,211,255,.16);
      color:var(--t-text);
      border-radius:12px;
      padding:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 8px 22px rgba(5,8,20,.4);
    }
    .transfer-recipient .recipient-refresh:disabled{opacity:.6;cursor:not-allowed;}
    .transfer-guidelines{
      list-style:none;
      margin:6px 0 22px;
      padding:0;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:12px;
    }
    .transfer-guidelines li{
      display:flex;
      gap:12px;
      align-items:flex-start;
      background:var(--t-panel);
      border:1px solid var(--t-border);
      border-radius:18px;
      padding:14px 18px;
      font-weight:600;
      color:var(--t-text);
      box-shadow:0 14px 28px rgba(5,8,20,.5);
    }
    .transfer-guidelines i{
      color:var(--t-primary);
      font-size:1.1rem;
      margin-top:4px;
    }
    html[data-theme="light"] .transfer-guidelines li{
      background:#f8fafc;
      border-color:rgba(148,163,184,.4);
      color:#1f2937;
      box-shadow:0 12px 22px rgba(15,23,42,.08);
    }
    .transfer-form{display:flex;flex-direction:column;gap:22px;}
    .transfer-field{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:18px 20px;
      border-radius:22px;
      background:linear-gradient(140deg,rgba(13,18,40,.9),rgba(13,18,40,.7));
      border:1px solid var(--t-border);
      box-shadow:0 26px 45px rgba(4,7,18,.65), inset 0 1px 0 rgba(255,255,255,.03);
      backdrop-filter:blur(18px);
    }
    html[data-theme="light"] .transfer-field{
      background:rgba(255,255,255,.96);
      border-color:rgba(148,163,184,.38);
      box-shadow:0 26px 38px rgba(15,23,42,.12), inset 0 1px 0 rgba(255,255,255,.8);
    }
    .transfer-field span{
      font-weight:800;
      color:var(--t-muted);
      font-size:.88rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      opacity:.9;
    }
    .transfer-field input,
    .transfer-field textarea{
      border:1.5px solid rgba(59,130,246,.32);
      background:linear-gradient(140deg,rgba(17,25,54,.9),rgba(10,14,32,.9));
      border-radius:16px;
      padding:16px 18px;
      color:var(--t-text);
      font-size:1.05rem;
      font-weight:700;
      outline:none;
      transition:border-color .25s ease, box-shadow .25s ease, transform .18s ease;
      resize:none;
      min-height:56px;
      width:100%;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.05);
    }
    html[data-theme="light"] .transfer-field input,
    html[data-theme="light"] .transfer-field textarea{
      background:linear-gradient(140deg,#fefefe,#f2f6ff);
      border-color:rgba(148,163,184,.55);
      color:#0f172a;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.85);
    }
    .transfer-field input:focus,
    .transfer-field textarea:focus{
      border-color:var(--t-primary);
      box-shadow:0 0 0 3px rgba(59,130,246,.32), inset 0 1px 0 rgba(255,255,255,.12);
      transform:translateY(-2px);
    }
    .transfer-field textarea{min-height:86px;}
    .transfer-field input::placeholder,
    .transfer-field textarea::placeholder{color:rgba(255,255,255,.45);font-weight:600;letter-spacing:.03em;}
    html[data-theme="light"] .transfer-field input::placeholder,
    html[data-theme="light"] .transfer-field textarea::placeholder{color:#94a3b8;}
    .transfer-helper{
      font-size:.95rem;
      font-weight:600;
      color:var(--t-muted);
    }
    .transfer-helper.warn{color:var(--t-danger);}
    .transfer-status{
      min-height:34px;
      border-radius:14px;
      padding:12px 16px;
      font-weight:700;
      display:none;
    }
    .transfer-status.show{display:block;}
    .transfer-status.success{background:rgba(52,211,153,.18);color:var(--t-success);}
    .transfer-status.error{background:rgba(248,113,113,.18);color:#fecaca;}
    .transfer-status.info{background:rgba(59,130,246,.15);color:#c3dcf4;}
    .transfer-actions{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:12px;flex-wrap:wrap;}
    .transfer-actions .transfer-footnote{margin:0;font-size:.9rem;color:var(--t-muted);}
    .transfer-actions button{
      border:none;
      border-radius:16px;
      padding:14px 24px;
      font-size:1rem;
      font-weight:800;
      background:linear-gradient(135deg,#22d3ee,#2867A5);
      color:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:opacity .2s ease, transform .2s ease, box-shadow .2s ease;
      box-shadow:0 18px 38px rgba(59,130,246,.3);
    }
    .transfer-actions button:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;}
    .transfer-actions button:not(:disabled):hover{transform:translateY(-2px);}
    .transfer-turnstile{display:none;margin-top:10px;}
    .transfer-turnstile.active{display:block;}
    body.transfer-modal-open, html.transfer-modal-open{overflow:hidden;}
    .transfer-modal-backdrop{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(6,10,26,.78);backdrop-filter:blur(10px);z-index:9999;padding:16px;
    }
    .transfer-modal-backdrop.show{display:flex;}
    .transfer-modal{
      width:100%;max-width:520px;background:#0d142e;border:1px solid rgba(120,133,255,.25);
      border-radius:22px;box-shadow:0 35px 80px rgba(0,0,0,.55);padding:22px;position:relative;
      color:#f8fafc;
    }
    html[data-theme="light"] .transfer-modal{background:#ffffff;color:#0f172a;box-shadow:0 30px 70px rgba(15,23,42,.14);border-color:rgba(148,163,184,.35);}
    .transfer-modal h3{margin:0 0 10px;font-size:1.35rem;display:flex;align-items:center;gap:8px;}
    .transfer-modal .confirm-body{display:flex;flex-direction:column;gap:12px;}
    .transfer-modal .confirm-row{display:flex;justify-content:space-between;gap:12px;border:1px dashed rgba(59,130,246,.3);padding:12px 14px;border-radius:12px;}
    html[data-theme="light"] .transfer-modal .confirm-row{border-color:rgba(148,163,184,.5);}
    .transfer-modal .confirm-label{font-weight:800;color:rgba(255,255,255,.7);text-transform:uppercase;letter-spacing:.05em;font-size:.82rem;}
    html[data-theme="light"] .transfer-modal .confirm-label{color:#475569;}
    .transfer-modal .confirm-value{font-weight:800;font-size:1.05rem;}
    .transfer-modal .confirm-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:16px;}
    .transfer-modal button{border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;}
    .transfer-modal .btn-ghost{background:transparent;color:#c7e2ff;border:1px solid rgba(148,163,184,.35);}
    html[data-theme="light"] .transfer-modal .btn-ghost{color:#475569;}
    .transfer-modal .btn-primary{background:linear-gradient(135deg,#3A8BD1,#2867A5);color:#fff;box-shadow:0 18px 38px rgba(59,130,246,.28);}
    @media(max-width:540px){
      .transfer-page .transfer-meta{grid-template-columns:1fr;}
      .transfer-actions{flex-direction:column;align-items:stretch;}
      .transfer-actions button{width:100%;justify-content:center;}
      .transfer-recipient{flex-direction:column;}
      .transfer-recipient .recipient-refresh{width:100%;}
    }
  </style>
  <!-- Settings page inline styles -->
  <style>
    .settings-page{
      --primary:#3A8BD1;
      --primary-2:#2867A5;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#1b1d3b;
      --muted:#4f6fa8;
      --border:rgba(91,143,194,.25);
      --shadow:0 12px 35px rgba(91,143,194,.15);
      --radius:16px;
      --ring:0 0 0 3px rgba(91,143,194,.25);
      --success:#16a34a;
      --danger:#ef4444;
      color:var(--text);
      background:transparent;
      padding:0 16px 48px;
    }
    html[data-theme="dark"] .settings-page{
      --bg:#0f1024;
      --card:#111827;
      --text:#f0f1ff;
      --muted:#5b8fc2;
      --border:rgba(156,158,222,.25);
      --shadow:0 12px 35px rgba(0,0,0,.55);
      --ring:0 0 0 3px rgba(156,158,222,.25);
    }
    .settings-page .settings-spacer{height:70px}
    @media(max-width:720px){
      .settings-page .settings-spacer{height:54px}
    }
    .settings-page .main-content{padding:28px 0;display:flex;justify-content:center}
    .settings-page .container{
      width:100%;
      max-width:900px;
      margin:0 auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:28px;
    }
    .settings-page h2{margin:0 0 10px;color:var(--primary);font-size:1.6rem;text-align:center}
    .settings-page .sub{text-align:center;color:var(--muted);margin-bottom:22px}
    .settings-page .info-list{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:16px;
      margin-bottom:24px;
    }
    .settings-page .col-6{grid-column:span 6}
    .settings-page .col-12{grid-column:span 12}
    @media(max-width:720px){
      .settings-page .col-6,
      .settings-page .col-12{grid-column:span 12}
      .settings-page .info-card{
        display:grid;
        grid-template-columns:auto minmax(0,1fr);
        align-items:center;
        gap:6px 12px;
        padding:12px 14px;
      }
      .settings-page .label{
        justify-content:flex-start;
        text-align:right;
      }
      .settings-page .value{
        width:100%;
      }
    }
    .settings-page .info-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px 18px;
      display:grid;
      grid-template-columns:auto minmax(0,1fr);
      align-items:center;
      gap:8px 14px;
      transition:.18s;
      color:var(--text);
      direction:rtl;
    }
    html[data-theme="dark"] .settings-page .info-card{background:#1a2234;border-color:var(--border)}
    .settings-page .info-card:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(91,143,194,.15);
      border-color:var(--primary);
    }
    .settings-page .label{color:var(--muted);font-weight:700;display:flex;flex-wrap:wrap;gap:8px;align-items:center;line-height:1.4}
    .settings-page .label i{color:var(--primary)}
    .settings-page .value{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:nowrap;
      min-width:0;
      width:100%;
      line-height:1.5;
      direction:ltr;
      text-align:left;
      justify-content:flex-start;
      white-space:nowrap;
    }
    .settings-page .badge{
      background:#e6f7ff;
      border:1px dashed var(--primary);
      padding:3px 10px;
      border-radius:999px;
      font-weight:700;
      color:var(--primary-2);
    }
    html[data-theme="dark"] .settings-page .badge{
      background:#1f3550;
      border-color:var(--primary);
      color:#9dc5e8;
    }
    .settings-page .copyable{
      font-weight:700;
      cursor:pointer;
      padding:2px 8px;
      border-radius:8px;
      transition:.15s;
      position:relative;
      white-space:nowrap;
      max-width:none;
      overflow:visible;
    }
    .settings-page .copyable:hover{background:#e6f7ff;color:var(--primary-2)}
    html[data-theme="dark"] .settings-page .copyable:hover{background:#1f3550;color:var(--text)}
    .settings-page .copyable.copied{box-shadow:var(--ring)}
    .settings-page .copyable.copied::after{
      content:"✓";
      position:absolute;
      right:-16px;
      top:-6px;
      background:var(--success);
      color:#fff;
      width:18px;
      height:18px;
      border-radius:50%;
      display:grid;
      place-items:center;
      font-size:.75rem;
    }
    @media(max-width:560px){
      .settings-page .info-card{padding:14px 16px}
      .settings-page .label{text-align:right}
      .settings-page .value{justify-content:flex-start}
    }
    .settings-page #resetBtn{
      width:100%;
      padding:12px;
      margin-top:22px;
      background:linear-gradient(135deg,#3A8BD1,#2867A5);
      color:#fff;
      border:none;
      border-radius:12px;
      font-size:1rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:.2s;
      box-shadow:0 10px 25px rgba(91,143,194,.25);
    }
    html[data-theme="dark"] .settings-page #resetBtn{background:linear-gradient(135deg,#66aee9,#66aee9)}
    .settings-page #resetBtn:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 32px rgba(91,143,194,.3);
    }
    .settings-page #resetBtn:disabled{opacity:.6;cursor:not-allowed}
    .settings-page #msg{
      margin-top:12px;
      text-align:center;
      color:var(--success);
      min-height:1em;
    }
    .settings-page .theme-toggle{
      width:100%;
      margin-top:16px;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
      transition:.2s;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    html[data-theme="dark"] .settings-page .theme-toggle{background:#1a2234;border-color:#1f3550}
    .settings-page .theme-toggle:hover{
      border-color:var(--primary);
      box-shadow:var(--ring);
    }
    .settings-page .hint{margin-top:8px;color:var(--muted);font-size:.9rem;text-align:center}
    .toast{
      position:fixed;
      left:50%;
      top:18px;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      padding:10px 14px;
      border-radius:12px;
      box-shadow:0 12px 28px rgba(0,0,0,.18);
      font-size:.95rem;
      z-index:9999;
    }
    html[data-theme="dark"] .toast{background:#0e1525;color:#f0f1ff}
    @media(max-width:560px){
      .toast{top:auto;bottom:16px}
      .settings-page{padding:0 12px 40px}
      .settings-page .container{padding:24px 20px}
    }
  </style>
  
  <!-- بانر علوي: تنسيق بسيط + سلايدر -->
  <style>
    .page-hero{ max-width:1000px; margin:10px auto 12px; padding:0 }
    .page-hero img{ width:100%; height:auto; display:block; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,.12) }

    /* سلايدر الهيدر */
    .hero-slider{ position:relative; overflow:hidden; border-radius:12px; touch-action: pan-y }
    .hero-track{ display:flex; transform:translateX(0); transition:transform .6s ease; will-change:transform; direction:ltr }
    .hero-slide{ flex:0 0 100%; min-width:100% }
    .hero-slider.dragging .hero-track{ transition:none; cursor:grabbing }
    .hero-slide img{ display:block; width:100%; height:auto; -webkit-user-drag:none; user-select:none }
  </style>

  <!-- Theme tokens -->
  <style>
  :root {
    --bg:#f8f9fa; --text:#1b1d3b; --muted:#4f6fa8;
    --card-bg:#f9f9ff; --card-text:var(--text); --card-border:#d9dbff;
    --card-gradient:linear-gradient(160deg, rgba(91,143,194,.16) 0%, rgba(249,250,255,.96) 100%);
    --card-border-strong:rgba(91,143,194,.32);
    --card-border-hover:rgba(91,143,194,.45);
    --card-shadow:0 12px 28px rgba(32,34,79,.14);
    --card-shadow-hover:0 16px 36px rgba(32,34,79,.2);
    --elev-shadow:0 2px 8px rgba(20,23,61,.08);
    --input-bg:#ffffff; --input-text:var(--text); --input-border:#3A8BD1; --input-border-focus:#2867A5; --input-focus-glow:rgba(91,143,194,.32);
    --btn-bg:#3A8BD1; --btn-bg-hover:#2867A5; --btn-text:#fff;
    --balance-bg:#ffffff; --balance-text:#2867A5; --balance-shadow:0 5px 15px rgba(20,23,61,.12);
    --modal-bg:#ffffff; --modal-text:var(--text); --modal-shadow:0 5px 15px rgba(20,23,61,.14);
    --warn-bg:#fff3cd; --warn-text:#7a5d00; --warn-border:#ffe69c;
    --skeleton:#eceeff; --shimmer-stripe:rgba(255,255,255,.58); --border-strong:#d9dbff;
    /* اجعل خلفية الجسم تعتمد على لون الدعم */
    --bg-app: #f8f9fa;
  }
  html[data-theme="dark"] {
    --bg:#05060f; --text:#f0f1ff; --muted:#8aa4cc;
    --card-bg:#0c0f1f; --card-text:#f0f1ff; --card-border:#1f2438;
    --card-gradient:linear-gradient(170deg, rgba(63,134,255,.08) 0%, rgba(10,12,24,.94) 100%);
    --card-border-strong:rgba(63,134,255,.28);
    --card-border-hover:rgba(63,134,255,.45);
    --card-shadow:0 10px 28px rgba(2,3,10,.65);
    --card-shadow-hover:0 14px 36px rgba(2,3,12,.72);
    --elev-shadow:0 3px 14px rgba(2,3,10,.6);
    --input-bg:#05060f; --input-text:#f0f1ff; --input-border:#1f2438; --input-border-focus:#3f86ff; --input-focus-glow:rgba(63,134,255,.32);
    --btn-bg:#2f74e4; --btn-bg-hover:#3f86ff; --btn-text:#fff;
    --balance-bg:#0c0f1c; --balance-text:#5c9aff; --balance-shadow:0 7px 20px rgba(2,3,10,.55);
    --modal-bg:#090a16; --modal-text:#f0f1ff; --modal-shadow:0 12px 34px rgba(2,3,10,.68);
    --warn-bg:#171829; --warn-text:#facc15; --warn-border:#2b2d52;
    --skeleton:#0d0e1d; --shimmer-stripe:rgba(255,255,255,.12); --border-strong:#1f2438;
    /* خلفية الجسم مطابقة لقسم الدعم */
    --bg-app: #05060f;
  }
  </style>

  <style>
/* Modal */
.modal{position:fixed;inset:0;background-color:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal-content{background:var(--modal-bg);color:var(--modal-text);padding:30px;border-radius:10px;max-width:400px;width:100%;box-shadow:var(--modal-shadow);text-align:center}

/* Base */
body{font-family:'Cairo','Segoe UI Emoji','Apple Color Emoji','Noto Color Emoji','Segoe UI Symbol',sans-serif;margin:0;direction:rtl}
  html[data-theme="dark"]  body,
  html[data-theme="light"] body{background:var(--bg-app, var(--bg));color:var(--text)}

/* Search */
  /* شريط البحث بنفس شكل شريط النص المتحرك */
  .search-container{
    margin:10px auto 10px;
    max-width:1000px;
    display:flex;
    justify-content:center;
    padding:0;
    background:var(--input-bg);
    border:2px solid var(--input-border);
    border-radius:25px;
    box-shadow:0 6px 14px rgba(0,0,0,.06);
  }
  html[data-theme="dark"] .search-container{
    box-shadow:0 8px 20px rgba(0,0,0,.35);
  }
  .search-container input[type="text"]{
    flex:1;
    padding:12px 15px;
    background:transparent;
    color:var(--input-text);
    border:none;
    border-radius:25px;
    font-size:1rem;
    line-height:1.2;
    outline:none;
  }
  .search-container:focus-within{
    box-shadow:0 0 6px var(--input-focus-glow);
    border-color:var(--input-border-focus);
  }
.search-container button{background:var(--btn-bg);border:none;padding:12px 20px;border-radius:25px;color:var(--btn-text);font-size:1rem;cursor:pointer;transition:.3s}
.search-container button:hover{background:var(--btn-bg-hover)}
.home-cta-row{margin:8px auto 14px;max-width:1000px;display:flex;gap:8px;justify-content:center;flex-wrap:nowrap;padding:0 6px}
.home-cta-row a{flex:1 1 0;min-width:0;text-align:center;text-decoration:none;color:#fff;font-weight:700;font-size:0.95rem;border-radius:12px;padding:10px 14px;background-image:linear-gradient(135deg,#2563eb,#1e40af);box-shadow:0 10px 22px rgba(0,0,0,0.24);border:1px solid rgba(255,255,255,.06);white-space:nowrap}
.home-cta-row a:hover{filter:brightness(1.05)}

main{max-width:1200px;margin:20px auto;padding:0 15px}

/* Grid */
.categories{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,max-content));gap:20px;justify-content:start;max-width:1000px;margin:auto}

/* Card */
.card{
  position:relative;
  background:var(--card-gradient);
  color:var(--card-text);
  border:1px solid var(--card-border-strong);
  border-radius:14px;
  box-shadow:var(--card-shadow);
  text-align:center;
  padding:16px;
  text-decoration:none;
  transition:transform .3s ease, box-shadow .3s ease, border-color .3s ease;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:hidden;
}
.card::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  background:radial-gradient(circle at top right, rgba(255,255,255,.32), rgba(255,255,255,0) 55%);
  opacity:.65;
}
.card:hover{
  transform:translateY(-5px);
  box-shadow:var(--card-shadow-hover);
  border-color:var(--card-border-hover);
}
html[data-theme="dark"] .card{
  background:var(--card-gradient);
  color:var(--card-text);
  border-color:var(--card-border-strong);
  box-shadow:var(--card-shadow);
}
html[data-theme="dark"] .card::after{
  background:radial-gradient(circle at top right, rgba(156,158,222,.18), rgba(0,0,0,0) 60%);
  opacity:.4;
}
.card h2{font-weight:700;font-size:1rem;margin:0;line-height:1.4;word-break:break-word}

/* Image */
.card img{width:100%;aspect-ratio:1/1;height:auto;object-fit:cover;object-position:center;border-radius:8px;user-select:none;background-color:var(--skeleton);display:block;margin:0 auto}

/* Show image even while pending (لو حصل تضارب مع .loading) */
.card.pending-state img{visibility:visible}
.card.maintenance{
  background:var(--card-bg)!important;
  color:var(--muted)!important;
  border-color:var(--card-border);
  box-shadow:none;
  pointer-events:none;
  opacity:.7;
}
.card.maintenance h2{color:#a00;}
.card.maintenance img{filter:grayscale(100%);}
.card.maintenance::after{display:none;}

/* No results */
.no-results{text-align:center;font-size:1.2rem;color:var(--muted);margin-top:30px}

/* Balance */
#userBalance{margin:20px auto;max-width:600px;text-align:center;font-weight:700;font-size:1.3rem;color:var(--text);background:var(--balance-bg);border-radius:20px;padding:20px;display:flex;align-items:center;justify-content:center;box-shadow:var(--balance-shadow);position:relative;border:1px solid var(--card-border)}
.balance-content{display:flex;align-items:center;justify-content:center}
#balanceText{margin-right:10px;color:var(--balance-text)}
.loading-spinner{border:4px solid #ece7ff;border-top:4px solid var(--btn-bg);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;display:none}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
#userBalance img{width:30px;height:30px;margin-left:10px}

/* Auth buttons */
button#loginBtn,button#logoutBtn{position:fixed;top:5px;border:none;padding:10px 18px;border-radius:25px;font-size:1rem;cursor:pointer;z-index:9999;transition:.3s}
button#loginBtn{left:20px;background:var(--btn-bg);color:var(--btn-text);visibility:visible}
button#loginBtn:hover{background:var(--btn-bg-hover)}
button#logoutBtn{left:160px;background:#cc0000;color:#fff;visibility:hidden}
button#logoutBtn:hover{background:#990000}

/* Login modal fields */
.login-modal .modal-content input{padding:10px;background:var(--input-bg);color:var(--input-text);border:1px solid var(--card-border);border-radius:6px;font-size:1rem}
.login-modal .modal-content button{padding:10px;background:var(--btn-bg);color:var(--btn-text);border:none;border-radius:6px;cursor:pointer}
.login-modal .modal-content button:hover{background:var(--btn-bg-hover)}
.modal-content .close{position:absolute;top:10px;left:20px;cursor:pointer;font-size:1.2rem}

/* Maintenance / Loading / Pending */
.card.pending-state{pointer-events:none;opacity:.7;position:relative;overflow:hidden}
.card.pending-state::after{content:'';position:absolute;top:0;right:-150px;width:100px;height:100%;background:linear-gradient(90deg,transparent,var(--shimmer-stripe),transparent);animation:shimmer 1.2s infinite;border-radius:12px;z-index:2}
@keyframes shimmer{0%{right:-150px}100%{right:100%}}

.card.loading{position:relative;background:var(--skeleton);overflow:hidden;pointer-events:none}
.card.loading img,.card.loading h2{visibility:visible}
.card.loading::after{content:'';position:absolute;top:0;right:-150px;width:100px;height:100%;background:linear-gradient(90deg,transparent,var(--shimmer-stripe),transparent);animation:shimmer 1.2s infinite}

/* Responsive */
@media (max-width:480px){.categories{grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:14px}.card{padding:12px;gap:10px}.card h2{font-size:.95rem}}
@media (max-width:768px){.categories{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}}
@media (max-width:992px){.categories{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}}

.card.loading{pointer-events:none;opacity:.7}

/* Fixed grid overrides */
.categories{grid-template-columns:repeat(5,minmax(0,1fr))!important;gap:20px;justify-content:center}
@media (max-width:768px){.categories{grid-template-columns:repeat(3,minmax(0,1fr))!important;gap:12px}.card{padding:12px!important}.card h2{font-size:.9rem!important}}
@media (max-width:480px){.categories{grid-template-columns:repeat(3,minmax(0,1fr))!important;gap:10px}.card{padding:10px!important}.card h2{font-size:.85rem!important}}
  hr{border-color:var(--border-strong)}
  </style>
  
  <!-- توافق شريط الإشعار + البحث للهواتف -->
  <style>
    @media (max-width: 600px){
      /* تقليل المسافة داخل النسخة الواحدة بدلًا من إضافة فجوة بين النسختين */
      .notice-ticker .ticker-copy{ gap:24px }
      .notice-ticker span{ font-size:1rem }
      .search-container{ margin:8px 8px 10px; padding:0 }
      .page-hero{ margin:8px 8px 10px; padding:0 }
      .page-hero img{ border-radius:10px }
      .search-container input[type="text"]{ font-size:1rem; padding:10px 12px }
      .search-container button{ padding:10px 16px }
    }
  </style>


  <!-- Preload/Warm important game images for seamless navigation -->
  <script>
    (function preloadGameImages(){
      // Key images used in games.html and its branches
      var images = [
        // Games categories (from games.html)

      ];

      function warm(u){
        try {
          var img = new Image();
          img.decoding = 'async';
          img.referrerPolicy = 'no-referrer';
          img.src = u;
        } catch(_) {}
      }

      // Warm after the page is interactive/idle
      var run = function(){ images.forEach(warm); };
      if (window.requestIdleCallback) {
        requestIdleCallback(run, { timeout: 2000 });
      } else {
        setTimeout(run, 1200);
      }
    })();
  </script>

  <!-- وضع علامة الملاحة مبكرًا جدًا لمنع إعادة التوجيه الخاطئة عند النقر بسرعة -->
  <script>
  (function(){
    function ensureAllow(a){
      try{
        var url = new URL(a.getAttribute('href'), location.href);
        if (!url.searchParams.has('allow')) {
          url.searchParams.set('allow','1');
          a.setAttribute('href', url.pathname + url.search + url.hash);
        }
      }catch(_){}
    }
    function mark(e){
      try{
        var t = e.target;
        var a = t && t.closest ? t.closest('a[href$=".html"]') : null;
        if (!a) return;
        sessionStorage.setItem('nav:fromHome','1');
        ensureAllow(a);
      }catch(_){}
    }
    document.addEventListener('pointerdown', mark, true);
    document.addEventListener('auxclick',    mark, true);
    document.addEventListener('click',       mark, true);
  })();
  </script>
  
  <!-- شريط إشعار متحرك (CSS) -->
  <style>
    .notice-ticker {
      max-width: 1000px;
      margin: 12px auto 10px;
      background: var(--input-bg);
      --nt-bg: var(--input-bg); /* للتلاشي الجانبي */
      --fadeWidth: 40px; /* عرض طبقة التلاشي على الأطراف (سطح المكتب) */
      color: var(--input-text);
      border: 2px solid var(--input-border);
      border-radius: 25px; /* مثل حقل البحث */
      padding: 12px 15px; /* مثل حقل البحث */
      font-size: 1rem; /* مطابق لحقل البحث */
      line-height: 1.2;
      display: flex;
      align-items: center;
      overflow: hidden;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
      position: relative;
      direction: rtl; /* بداية السطر من اليمين */
    }
    html[data-theme="dark"] .notice-ticker {
      background: var(--input-bg);
      --nt-bg: var(--input-bg);
      border-color: var(--input-border);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      color: var(--input-text);
    }
    /* تلاشي الأطراف لإخفاء أي حواف بداية/نهاية */
    .notice-ticker::before,
    .notice-ticker::after{
      content: '';
      position: absolute;
      top: 0; bottom: 0;
      width: var(--fadeWidth, 40px);
      pointer-events: none;
      z-index: 2;
    }
    .notice-ticker::before{ right:0; background: linear-gradient(270deg, var(--nt-bg) 0%, rgba(0,0,0,0) 70%); }
    .notice-ticker::after { left:0;  background: linear-gradient(90deg,  var(--nt-bg) 0%, rgba(0,0,0,0) 70%); }

    .notice-ticker .ticker-track {
      display: inline-flex;
      align-items: center;
      gap: 0; /* لا فجوة بين النسخ */
      white-space: nowrap;
      will-change: transform;
      animation: marquee-single var(--dur, 18s) linear infinite;
    }
    .notice-ticker .ticker-copy {
      display: inline-flex;
      align-items: center;
      gap: 48px; /* المسافة داخل النسخة الواحدة */
      flex-shrink: 0; /* لا تنكمش لتبقى قيمة القياس ثابتة */
    }
    /* استخدم نسخة مرئية واحدة فقط ليتحقق الاختفاء التام بين الدورات */
    .notice-ticker .ticker-copy[aria-hidden="true"]{ display: none !important; }
    .notice-ticker span { font-weight: 700; font-size: 1rem; }
    /* عدم إيقاف الحركة عند التحويم/التحديد */
    .notice-ticker .ticker-track:hover { animation-play-state: running; }
    @media (prefers-reduced-motion: reduce){
      .notice-ticker .ticker-track{ animation: none; transform: none; }
    }
    /* مسار واحد: يبدأ من خارج الحافة، يعبر، يخرج بالكامل، ثم يعاود من البداية */
    /* اجعل الاتجاه قابلاً للعكس عبر --dir (1 أو -1) */
    #homeTicker { --dir: 1; } /* 1 = يبدأ من اليمين ويتجه لليسار، -1 = يبدأ من اليسار */
    @media (max-width: 767px){
      /* على الهاتف: الجهة المعاكسة */
      #homeTicker { --dir: -1; }
    }
    @media (min-width: 768px){
      /* على الكمبيوتر: نفس اتجاه الهاتف (الجهة المعاكسة) */
      #homeTicker { --dir: -1 !important; }
    }
    
    /* Mobile override to fully match search bar */
    @media (max-width: 600px){
      #homeTicker.notice-ticker{
        margin:8px 8px 10px;
        padding:10px 12px;
        border-radius:25px;
        border:2px solid var(--input-border);
        background: var(--input-bg);
        color: var(--input-text);
        font-size:1rem;
        line-height:1.2;
        --fadeWidth: 28px;
      }
      #homeTicker.notice-ticker span{ font-size:1rem }
    }
    @keyframes marquee-single {
      0%   { transform: translate3d(var(--start, 100%), 0, 0); }
      5%   { transform: translate3d(var(--start, 100%), 0, 0); }
      95%  { transform: translate3d(var(--end, -100%), 0, 0); }
      100% { transform: translate3d(var(--end, -100%), 0, 0); }
    }
  </style>
</head>
  <body>

<div id="headerContainer"></div>
<div id="sidebarContainer"></div>

<!-- عنوان دلالي واضح للمحركات -->
<h1 class="sr-only">JS4ACC | متجر شراء حسابات الألعاب والاشتراكات الرقمية بسرعة وأمان</h1>

<style>
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>


<div style="height:70px;"></div>

    <div class="page-hero">
      <div class="hero-slider" id="heroSlider" aria-label="بانرات مميزة">
        <div class="hero-track">
          <div class="hero-slide"><img draggable="false" src="IMGS/in1.jpg" alt="بانر ترحيبي" loading="eager" decoding="async" fetchpriority="high"></div>
          <div class="hero-slide"><img draggable="false" src="IMGS/in2.jpg" alt="عرض 1"  decoding="async"></div>

        </div>
      </div>
    </div>

    <script>
    (function(){
      var slider = document.getElementById('heroSlider');
      if(!slider) return;
      var track = slider.querySelector('.hero-track');
      var slides = Array.prototype.slice.call(slider.querySelectorAll('.hero-slide'));
      var realCount = slides.length;
      // إنشاء نسخ للتكرار اللانهائي (آخر شريحة بالبداية، وأول شريحة بالنهاية)
      var firstClone = slides[0] && slides[0].cloneNode(true);
      var lastClone  = slides[realCount-1] && slides[realCount-1].cloneNode(true);
      if (firstClone) track.appendChild(firstClone);
      if (lastClone) track.insertBefore(lastClone, track.firstChild);
      var index = 1; // نبدأ من أول شريحة حقيقية
      var timer = null;
      var isDown = false, startX = 0, deltaX = 0, isAnimating = false;
      var pointerTracking = false;

      function go(i, animate){
        index = i;
        var w = slider.clientWidth;
        var withAnim = animate !== false;
        track.style.transition = withAnim ? 'transform .6s ease' : 'none';
        track.style.transform = 'translateX(' + (-index*w) + 'px)';
        isAnimating = withAnim;
      }
      function next(){ if(isAnimating) return; go(index+1, true); }
      function prev(){ if(isAnimating) return; go(index-1, true); }

      function start(){ stop(); timer = setInterval(prev, 7000); }
      function stop(){ if(timer){ clearInterval(timer); timer=null; } }

      function attachPointerListeners(){
        if (pointerTracking) return;
        pointerTracking = true;
        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', onUp);
        window.addEventListener('pointercancel', onUp);
      }
      function detachPointerListeners(){
        if (!pointerTracking) return;
        pointerTracking = false;
        window.removeEventListener('pointermove', onMove);
        window.removeEventListener('pointerup', onUp);
        window.removeEventListener('pointercancel', onUp);
      }

      function onDown(e){
        if(isAnimating) return; // لا تبدأ سحب أثناء الحركة
        isDown = true; deltaX = 0; slider.classList.add('dragging'); stop();
        if (e.pointerId !== undefined && slider.setPointerCapture) { try { slider.setPointerCapture(e.pointerId); } catch(_){} }
        startX = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX);
        attachPointerListeners();
      }
      function onMove(e){
        if(!isDown) return;
        var x = (e.touches && e.touches[0] ? e.touches[0].clientX : e.clientX);
        deltaX = x - startX;
        var w = slider.clientWidth;
        track.style.transition = 'none';
        track.style.transform = 'translateX(' + ((-index*w)+deltaX) + 'px)';
      }
      function onUp(){
        if(!isDown){ detachPointerListeners(); return; }
        isDown=false; slider.classList.remove('dragging');
        var w = slider.clientWidth; var threshold = Math.min(80, w*0.15);
        if(Math.abs(deltaX) > threshold){ deltaX>0 ? prev() : next(); }
        else { go(index, true); }
        start();
        detachPointerListeners();
      }

      slider.addEventListener('pointerdown', onDown);
      slider.addEventListener('pointercancel', onUp);
      slider.addEventListener('touchstart', onDown, {passive:true});
      slider.addEventListener('touchmove', onMove, {passive:true});
      slider.addEventListener('touchend', onUp);
      slider.addEventListener('touchcancel', onUp);

      // منع سحب الصورة الافتراضي
      slider.addEventListener('dragstart', function(e){ e.preventDefault(); });

      slider.addEventListener('mouseenter', stop);
      slider.addEventListener('mouseleave', start);

      // عند انتهاء التحريك، إذا كنا على نسخة مكررة، نعيد التمركز للشريحة الحقيقية بدون أن يلاحظ المستخدم
      track.addEventListener('transitionend', function(){
        isAnimating = false;
        if (index === 0) {
          track.style.transition = 'none';
          index = realCount;
          track.style.transform = 'translateX(' + (-index*slider.clientWidth) + 'px)';
          // إجبار إعادة التدفق ثم إعادة التفعيل
          void track.offsetHeight;
          track.style.transition = 'transform .6s ease';
        } else if (index === realCount + 1) {
          track.style.transition = 'none';
          index = 1;
          track.style.transform = 'translateX(' + (-index*slider.clientWidth) + 'px)';
          void track.offsetHeight;
          track.style.transition = 'transform .6s ease';
        }
      });

      // تأكيد تحميل الصور لتفادي وميض الفراغ عند السحب السريع
      try {
        slides.forEach(function(s){
          var im = s.querySelector('img');
          if (im && im.decode) { im.decode().catch(function(){/* ignore */}); }
        });
      } catch (_) {}

      // إعادة تموضع عند تغيير العرض لضمان المحاذاة بالبكسل
      window.addEventListener('resize', function(){ go(index, false); });

      go(1, false); start();
    })();
    </script>

  <!-- شريط الإشعار: يبدأ من البداية، يخرج تمامًا، ثم يعاود من البداية -->
  <div class="notice-ticker" id="homeTicker" aria-label="إعلانات الموقع">
    <div class="ticker-track" role="marquee" aria-live="polite">
      <div class="ticker-copy">
        <span>JS4ACC || بيع وشراء حسابات فري فاير كما لم يتم من قبل</span>
      </div>
    </div>
  </div>

    <!-- البحث -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="ابحث عن الحسابات أو القسم..." aria-label="بحث" />
  </div>

  <div class="home-cta-row" id="quickFloatingActions" aria-label="إجراءات سريعة">
    <a id="reviewCtaBtn" class="btn primary" href="review-request.html">عرض حساب</a>
    <a id="withdrawCtaBtn" class="btn primary" href="sahb.html">سحب رصيد</a>
  </div>


  <script>
    // حركة تبدأ من الحافة، تمر عبر الشريط، تخرج بالكامل، ثم تعاود من البداية
    (function(){
      var ticker = document.getElementById('homeTicker');
      var track  = ticker && ticker.querySelector('.ticker-track');
      var one    = track && track.querySelector('.ticker-copy');
      if(!ticker || !track || !one) return;

      var SPEED = 80; // بكسل/ثانية
      var rafId = 0;

      function parseDir(){
        var d = 1;
        try{
          var v = getComputedStyle(ticker).getPropertyValue('--dir').trim();
          if (v) d = parseFloat(v) || 1;
          d = d >= 0 ? 1 : -1;
        }catch(e){}
        return d;
      }

      function px(v){
        if (!v) return 0;
        var n = parseFloat(String(v).replace('px','').trim());
        return isFinite(n) ? n : 0;
      }

      function apply(cw, ow, dir){
        if (!cw || !ow) return;
        // خذ في الاعتبار عرض طبقة التلاشي على الأطراف، ويختلف بين الهاتف والكمبيوتر
        var styles = getComputedStyle(ticker);
        var fade   = px(styles.getPropertyValue('--fadeWidth'));
        var pad    = 2; // هامش أمان صغير لضمان الخروج الكامل
        var start  = dir * (cw + fade + pad);   // خارج الحافة في جهة البداية
        var end    = -dir * (ow + fade + pad);  // خارج الحافة في جهة النهاية
        var dist   = cw + ow + (2 * fade) + (2 * pad); // المسافة المقطوعة الفعلية
        var dur   = (dist / SPEED).toFixed(2) + 's';
        track.style.setProperty('--start', start + 'px');
        track.style.setProperty('--end',   end   + 'px');
        track.style.setProperty('--dur',   dur);
      }

      function measure(){
        cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(function(){
          // قياسات دقيقة
          var cw  = ticker.clientWidth;    // عرض الحاوية (يتبدل بين الهاتف والكمبيوتر)
          var ow  = one.scrollWidth;       // عرض المحتوى
          var dir = parseDir();
          apply(cw, ow, dir);
        });
      }

      // قياس أولي
      measure();

      // أعِد القياس بعد تحميل الخطوط/الصور لضمان ثبات العرض
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(measure).catch(function(){});
      }
      window.addEventListener('load', measure, { once:true });
      window.addEventListener('resize', measure);

      // راقب تغيّر الحجم للمحتوى نفسه
      if (typeof ResizeObserver !== 'undefined'){
        var ro = new ResizeObserver(measure);
        ro.observe(one);
      }
    })();
  </script>

<main>
  <section id="accountsWrapper" class="accounts-wrapper">
    <div class="accounts-header">
      <div>
      </div>
    </div>
    <div id="categoriesContainer" class="accounts-groups"></div>
    <p class="no-results" id="noResults" style="display:none;">عذراً، لم يتم العثور على نتائج.</p>
  </section>

  <!-- نافذة تفاصيل الحساب -->
  <div id="accountModal" role="dialog" aria-modal="true" aria-labelledby="accountModalTitle" style="display:none;">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="accountModalTitle" style="margin:0;font-size:1.2rem;"></h3>
        <button class="modal-close" aria-label="إغلاق" id="closeAccountModal">×</button>
      </div>
      <div class="muted tiny" id="accountModalCat"></div>
      <div class="price" id="accountModalPrice"></div>
      <div class="modal-body" id="accountModalDesc"></div>
      <div class="modal-grid" id="accountModalImages"></div>
    </div>
  </div>

  <!-- Inline page content container -->
  <div id="inlinePage" style="display:none"></div>
</main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script>
    (function(){
      try{ window.__SKIP_FIREBASE__ = false; }catch(_){}
    })();
  </script>
    <script>
  (function(){
    function applyCardState(card, state){
      var finalState = (state == null) ? 'on' : state;
      var titleEl = card.querySelector ? card.querySelector('h2') : null;
      var img = card.querySelector ? card.querySelector('img') : null;
      try{ card.classList.remove('loading'); }catch(_){ }
      if (finalState === 'off'){
        if (img){ try{ img.setAttribute('loading','eager'); img.setAttribute('decoding','sync'); img.setAttribute('fetchpriority','high'); }catch(_){ } }
        try{ card.classList.add('maintenance'); card.classList.remove('pending-state'); }catch(_){ }
        try{ card.removeAttribute('href'); }catch(_){ }
        if (titleEl){ try{ titleEl.textContent = '🚧 مغلق للصيانة'; }catch(_){ } }
      } else {
        try{
          if (card.dataset && card.dataset.originalHref){ card.setAttribute('href', card.dataset.originalHref); }
          card.classList.remove('maintenance','pending-state');
          if (titleEl && card.dataset && card.dataset.originalTitle){ titleEl.textContent = card.dataset.originalTitle; }
        }catch(_){ }
      }
    }
    function prepCard(card){
      try{
        if (!card.dataset.originalHref){ var href = card.getAttribute('href'); if (href) card.dataset.originalHref = href; }
        var t = card.querySelector && card.querySelector('h2');
        if (t && !card.dataset.originalTitle){ card.dataset.originalTitle = t.textContent || ''; }
      }catch(_){ }
    }
    function getPageNameFromCard(card){
      try{
        var href = (card.dataset && card.dataset.originalHref) || card.getAttribute('href') || '';
        href = href.split('?')[0].split('#')[0];
        return href.replace(/\.html$/,'');
      }catch(_){ return ''; }
    }
    var STATES_TTL_MS = 5*60*1000;
    var STATES_CACHE_KEY = 'statesCache';
    var stateHub = (function(){
      var KEY = '__CARD_STATE_HUB__';
      try{
        if (typeof window.__getCardStateHub === 'function'){
          var existing = window.__getCardStateHub();
          if (existing && typeof existing === 'object') return existing;
        }
      }catch(_){}
      try{
        var globalHub = window[KEY];
        if (globalHub && typeof globalHub === 'object'){
          globalHub.setMap = globalHub.setMap || function(map){
            this.map = (map && typeof map === 'object') ? Object.assign({}, map) : {};
            return this.map;
          };
          globalHub.mergeMap = globalHub.mergeMap || function(map){
            if (!map || typeof map !== 'object') return this.map || {};
            if (!this.map) this.map = {};
            Object.assign(this.map, map);
            return this.map;
          };
          globalHub.getMap = globalHub.getMap || function(){ return this.map; };
          globalHub.setLoading = globalHub.setLoading || function(p){ this.loading = p; };
          globalHub.clearLoading = globalHub.clearLoading || function(p){ if (this.loading === p) this.loading = null; };
          window.__getCardStateHub = window.__getCardStateHub || function(){ return globalHub; };
          return globalHub;
        }
      }catch(_){}
      var hub = {
        map: null,
        loading: null,
        setMap: function(map){
          this.map = (map && typeof map === 'object') ? Object.assign({}, map) : {};
          return this.map;
        },
        mergeMap: function(map){
          if (!map || typeof map !== 'object') return this.map || {};
          if (!this.map) this.map = {};
          Object.assign(this.map, map);
          return this.map;
        },
        getMap: function(){ return this.map; },
        setLoading: function(p){ this.loading = p; },
        clearLoading: function(p){ if (this.loading === p) this.loading = null; }
      };
      try{
        window[KEY] = hub;
        window.__getCardStateHub = function(){ return hub; };
      }catch(_){}
      return hub;
    })();
    function saveStatesCache(map){
      try{ localStorage.setItem(STATES_CACHE_KEY, JSON.stringify({ savedAt: Date.now(), map: map||{} })); }catch(_){ }
      try{
        if (stateHub && map && typeof map === 'object' && typeof stateHub.mergeMap === 'function'){
          stateHub.mergeMap(map);
        }
      }catch(_){}
    }
    function readStatesCache(ignoreTTL){
      try{
        var raw = localStorage.getItem(STATES_CACHE_KEY);
        if(!raw) return null;
        var obj; try{ obj = JSON.parse(raw); }catch(_){ obj=null; }
        if (obj && typeof obj === 'object'){
          if(!ignoreTTL){ var now = Date.now(); if(obj.savedAt && (now-obj.savedAt)>STATES_TTL_MS){ /* expired */ } }
          if (obj.map && typeof obj.map === 'object') return obj.map;
          if (typeof obj.stateJson === 'string'){ try{ var m=JSON.parse(obj.stateJson); if(m && typeof m==='object') return m; }catch(_){ } }
          var vals = Object.values(obj); if (vals.length && vals.every(function(v){return v==='on'||v==='off';})) return obj;
        }
        try{ var m2 = JSON.parse(raw); if (m2 && typeof m2==='object') return m2; }catch(_){ }
        return null;
      }catch(_){ return null; }
    }
    function parseStatesDoc(data){
      var map = {};
      try{
        if (typeof data.stateJson === 'string') { map = JSON.parse(data.stateJson)||{}; }
        else if (data.map && typeof data.map==='object'){ map = data.map; }
        else { map = data||{}; }
      }catch(_){ map = {}; }
      return map;
    }
    async function loadStatesMap(){
      try{
        if (stateHub && stateHub.loading) return stateHub.loading;
      }catch(_){}
      if (typeof firebase==='undefined' || !firebase.firestore){
        var existing = null;
        try{
          if (stateHub && typeof stateHub.getMap === 'function') existing = stateHub.getMap();
        }catch(_){ existing = null; }
        if (existing && typeof existing === 'object') return { map: existing, fromCache: true };
        var cachedOnly = null;
        try{ cachedOnly = readStatesCache(true); }catch(_){ cachedOnly = null; }
        if (cachedOnly && stateHub && typeof stateHub.setMap === 'function'){
          try{ stateHub.setMap(cachedOnly); }catch(_){}
        }
        if (cachedOnly) return { map: cachedOnly, fromCache: true };
        return null;
      }
      var promise;
      promise = (async function(){
        try{
          var ref = firebase.firestore().collection('config').doc('states');
          var snap = await ref.get({ source:'server' }).catch(function(){ return ref.get(); });
          if (!snap || !snap.exists){
            var cachedFallback = null;
            try{ cachedFallback = readStatesCache(true); }catch(_){ cachedFallback = null; }
            if (cachedFallback && stateHub && typeof stateHub.setMap === 'function'){
              try{ stateHub.setMap(cachedFallback); }catch(_){}
            }
            return { map: cachedFallback || {}, fromCache: true };
          }
          var map = parseStatesDoc(snap.data()||{});
          saveStatesCache(map);
          try{
            if (stateHub && typeof stateHub.setMap === 'function') stateHub.setMap(map);
          }catch(_){}
          return { map: map, fromCache: false };
        }catch(__){
          var fallback = null;
          try{ fallback = readStatesCache(true); }catch(_){ fallback = null; }
          if (fallback && stateHub && typeof stateHub.setMap === 'function'){
            try{ stateHub.setMap(fallback); }catch(_){}
          }
          return { map: fallback || {}, fromCache: true };
        } finally {
          try{
            if (stateHub && typeof stateHub.clearLoading === 'function') stateHub.clearLoading(promise);
            else if (stateHub && stateHub.loading === promise) stateHub.loading = null;
          }catch(_){}
        }
      })();
      try{
        if (stateHub && typeof stateHub.setLoading === 'function') stateHub.setLoading(promise);
        else if (stateHub) stateHub.loading = promise;
      }catch(_){}
      return promise;
    }
    function applyStatesToPage(){
      try{
        var cards = Array.prototype.slice.call(document.querySelectorAll('a.card, .card[href]'));
        if (!cards.length) return;
        cards.forEach(prepCard);

        var hubMap = null;
        try{
          if (stateHub && typeof stateHub.getMap === 'function') hubMap = stateHub.getMap();
        }catch(_){ hubMap = null; }

        var cached = (hubMap && typeof hubMap === 'object') ? hubMap : null;
        if (!cached){
          try { cached = readStatesCache(window.__SKIP_FIREBASE__ ? true : false); } catch(_) { cached = null; }
          if (cached && stateHub && typeof stateHub.setMap === 'function'){
            try{ stateHub.setMap(cached); hubMap = stateHub.getMap(); }catch(_){}
          }
        }
        if (!cached && hubMap && typeof hubMap === 'object') cached = hubMap;

        var hasCache = cached && typeof cached === 'object';
        var pending = [];
        var snapshot = {};

        cards.forEach(function(card){
          var name = getPageNameFromCard(card);
          if (!name) return;
          var state = null;
          if (hasCache && Object.prototype.hasOwnProperty.call(cached, name)) {
            state = cached[name];
          } else if (hubMap && typeof hubMap === 'object' && Object.prototype.hasOwnProperty.call(hubMap, name)) {
            state = hubMap[name];
          }
          if (state === 'off') {
            applyCardState(card, 'off');
            snapshot[name] = 'off';
          } else if (state === 'on') {
            applyCardState(card, 'on');
            snapshot[name] = 'on';
          } else {
            if (!card.classList.contains('pending-state')) {
              card.classList.add('pending-state');
            }
            pending.push(card);
          }
        });

        try{
          if (stateHub && typeof stateHub.mergeMap === 'function' && Object.keys(snapshot).length){
            stateHub.mergeMap(snapshot);
          }
        }catch(_){}

        if (pending.length) {
          var releasePending = function(){
            var update = {};
            pending.forEach(function(card){
              applyCardState(card, 'on');
              var name = getPageNameFromCard(card);
              if (name) update[name] = 'on';
            });
            try{
              if (stateHub && typeof stateHub.mergeMap === 'function' && Object.keys(update).length){
                stateHub.mergeMap(update);
              }
            }catch(_){}
          };
          setTimeout(releasePending, hasCache ? 1200 : 800);
        }

        if (!window.__SKIP_FIREBASE__){
          loadStatesMap().then(function(result){
            var map = (result && result.map) ? result.map : result;
            map = map || readStatesCache(false) || {};
            var normalized = {};
            cards.forEach(function(card){
              var name = getPageNameFromCard(card);
              if (!name) return;
              var s = (name && map && Object.prototype.hasOwnProperty.call(map, name)) ? map[name] : 'on';
              applyCardState(card, s);
              normalized[name] = s;
            });
            if (Object.keys(normalized).length){
              try{
                if (stateHub && typeof stateHub.mergeMap === 'function') stateHub.mergeMap(normalized);
                saveStatesCache(normalized);
              }catch(_){}
            }
          }).catch(function(){ /* تجاهل */ });
        }
      }catch(_){ }
    }
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', applyStatesToPage); else try{ applyStatesToPage(); }catch(_){ }
  })();
  </script>

  <script>
    /* ===== أدوات الحالات (بدون localStorage) ===== */
    function lockAllCards() {
      document.querySelectorAll('.card').forEach(card => {
        // خزّن href والعنوان الأصليين
        if (!card.dataset.originalHref) {
          const href = card.getAttribute('href');
          if (href) card.dataset.originalHref = href;
        }
        const titleEl = card.querySelector('h2');
        if (!card.dataset.originalTitle && titleEl) card.dataset.originalTitle = titleEl.textContent;

        // ✅ أزل أي إخفاء بصري للصور مبكرًا
        card.classList.remove('loading');

        // قفل فوري
        card.removeAttribute('href');
        card.classList.add('pending-state');
      });
    }
    function applyCardState(card, state) {
      const finalState = (state === undefined || state === null) ? 'on' : state;
      const titleEl = card.querySelector('h2');
      const img = card.querySelector('img');

      // أزل أي إخفاء بصري
      card.classList.remove('loading');

      if (finalState === 'off') {
        // ✅ اجعل صورة العناصر المغلقة تظهر فورًا
        if (img) {
          img.setAttribute('loading', 'eager');
          img.setAttribute('decoding', 'sync');
          img.setAttribute('fetchpriority', 'high');
        }
        card.classList.add('maintenance');
        card.classList.remove('pending-state');
        card.removeAttribute('href');
        if (titleEl) titleEl.textContent = '🚧 مغلق للصيانة';
      } else {
        if (card.dataset.originalHref) card.setAttribute('href', card.dataset.originalHref);
        card.classList.remove('maintenance','pending-state');
        if (titleEl && card.dataset.originalTitle) titleEl.textContent = card.dataset.originalTitle;
      }
    }

    function generateAuthKey() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let key = '';
      for (let i = 0; i < 36; i++) key += chars.charAt(Math.floor(Math.random() * chars.length));
      return key;
    }

    // Firebase
    const firebaseConfig = {
          apiKey: "AIzaSyBD4zpvsUdygm7KxRYXPDHbotwvf9Y7pOQ",
          authDomain: "js4accweb.firebaseapp.com",
          projectId: "js4accweb",
          storageBucket: "js4accweb.firebasestorage.app",
          messagingSenderId: "635891162580",
          appId: "1:635891162580:web:1ee495e5b51f96ab16ca41",
          measurementId: "G-0Y3LMPBEWJ"
        };
    try { window.__FIREBASE_CONFIG__ = firebaseConfig; } catch(_){ }
    let auth = null;
    let db = null;
    let firebaseReady = typeof firebase !== 'undefined' && firebase && typeof firebase.initializeApp === 'function';

    if (firebaseReady) {
      try {
        if (!firebase.apps || !firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
        } else {
          firebase.app();
        }
        auth = typeof firebase.auth === 'function' ? firebase.auth() : null;
        db = typeof firebase.firestore === 'function' ? firebase.firestore() : null;
      } catch (e) {
        console.warn('تعذر تهيئة Firebase، سيتم متابعة العرض بدون اتصال.', e);
        firebaseReady = false;
        auth = null;
        db = null;
      }
    } else {
      console.warn('مكتبة Firebase غير متوفرة، سيتم متابعة العرض بدون اتصال.');
    }

    const firebaseAvailable = firebaseReady && !!auth && !!db;

    // ===== حارس طلبات Firebase: منع القراءة عند إعادة التحميل السريع =====
    (function(){
      try { window.__SKIP_FIREBASE__ = false; } catch(_){}
    })();
    if (!firebaseAvailable) { window.__SKIP_FIREBASE__ = true; }

    function closeResetModal() { resetModal.style.display = 'none'; }

    if (!window.__SKIP_FIREBASE__ && firebaseAvailable && auth && typeof auth.onAuthStateChanged === "function") auth.onAuthStateChanged(user => {
      if (user) {
        //loadUserBalance(user.uid);
      } else {
        const el = document.getElementById('balanceAmount');
        if (el) el.textContent = 'يجب تسجيل الدخول اولا';
      }
    });

    if (!window.__SKIP_FIREBASE__ && firebaseAvailable && auth && typeof auth.onAuthStateChanged === "function") auth.onAuthStateChanged(async (user) => {
      if (user) {
        const userRef = db.collection('users').doc(user.uid);
        const docSnap = await userRef.get();

        if (docSnap.exists) {
          const data = docSnap.data();

          // تم تعطيل التحقق من الحظر لتحسين سرعة التجربة وإزالة الحواجز

          if (!data.authkey) {
            const authkey = generateAuthKey();
            await userRef.set({ authkey }, { merge: true });
          }

          // تمت إزالة مطالبة رقم الهاتف
        }
      } else {
        const el = document.getElementById('balanceAmount');
        if (el) el.textContent = 'يجب تسجيل الدخول اولا';
      }
    });

    /* ===== تسريع ومنع النافذة الزمنية للدخول ===== */
    // حمل خريطة الحالات من وثيقة واحدة بصيغة JSON لتقليل القراءات
    const STATES_TTL_MS = 5 * 60 * 1000; // مدة صلاحية الكاش العادي (5 دقائق)
    const STATES_CACHE_KEY = 'statesCache';
    const stateHub = (() => {
      try {
        if (typeof window.__getCardStateHub === 'function') {
          const hub = window.__getCardStateHub();
          if (hub && typeof hub === 'object') return hub;
        }
      } catch (_) {}
      try {
        const existing = window.__CARD_STATE_HUB__;
        if (existing && typeof existing === 'object') {
          if (typeof existing.setMap !== 'function') {
            existing.setMap = function(map){
              this.map = (map && typeof map === 'object') ? Object.assign({}, map) : {};
              return this.map;
            };
          }
          if (typeof existing.mergeMap !== 'function') {
            existing.mergeMap = function(map){
              if (!map || typeof map !== 'object') return this.map || {};
              if (!this.map) this.map = {};
              Object.assign(this.map, map);
              return this.map;
            };
          }
          if (typeof existing.getMap !== 'function') {
            existing.getMap = function(){ return this.map; };
          }
          if (typeof existing.setLoading !== 'function') {
            existing.setLoading = function(p){ this.loading = p; };
          }
          if (typeof existing.clearLoading !== 'function') {
            existing.clearLoading = function(p){ if (this.loading === p) this.loading = null; };
          }
          if (typeof window.__getCardStateHub !== 'function') {
            window.__getCardStateHub = () => existing;
          }
          return existing;
        }
      } catch (_) {}
      const hub = {
        map: null,
        loading: null,
        setMap(map){
          this.map = (map && typeof map === 'object') ? Object.assign({}, map) : {};
          return this.map;
        },
        mergeMap(map){
          if (!map || typeof map !== 'object') return this.map || {};
          if (!this.map) this.map = {};
          Object.assign(this.map, map);
          return this.map;
        },
        getMap(){ return this.map; },
        setLoading(p){ this.loading = p; },
        clearLoading(p){ if (this.loading === p) this.loading = null; }
      };
      try {
        window.__CARD_STATE_HUB__ = hub;
        window.__getCardStateHub = () => hub;
      } catch (_) {}
      return hub;
    })();

    function saveStatesCache(map){
      try { localStorage.setItem(STATES_CACHE_KEY, JSON.stringify({ savedAt: Date.now(), map: map||{} })); } catch(_){}
      try {
        if (stateHub && map && typeof map === 'object' && typeof stateHub.mergeMap === 'function') {
          stateHub.mergeMap(map);
        }
      } catch (_) {}
    }
    function readStatesCache(ignoreTTL){
      try{
        const raw = localStorage.getItem(STATES_CACHE_KEY);
        if(!raw) return null;
        let obj;
        try { obj = JSON.parse(raw); } catch(_) { obj = null; }
        // دعم صيغ قديمة/متنوعة
        if (obj && typeof obj === 'object'){
          // التحقق من مهلة الكاش إن لزم
          if(!ignoreTTL){
            const now = Date.now();
            if(obj.savedAt && (now - obj.savedAt) > STATES_TTL_MS){ /* منتهي */ }
          }
          if (obj.map && typeof obj.map === 'object') return obj.map;
          if (typeof obj.stateJson === 'string'){
            try{ const m = JSON.parse(obj.stateJson); if(m && typeof m==='object') return m; }catch(_){ }
          }
          // إذا كان الكائن نفسه يبدو خريطة حالات (قيم on/off)
          const vals = Object.values(obj);
          if (vals.length && vals.every(v => v === 'on' || v === 'off')) return obj;
        }
        // ربما خزّن كنص للخريطة مباشرة
        try{
          const m2 = JSON.parse(raw);
          if (m2 && typeof m2 === 'object') return m2;
        }catch(_){ }
        return null;
      }catch(_){ return null; }
    }
    async function loadStatesMap() {
      if (!firebaseAvailable || !db || typeof db.collection !== 'function') {
        let existing = null;
        try {
          if (stateHub && typeof stateHub.getMap === 'function') existing = stateHub.getMap();
        } catch (_) { existing = null; }
        if (existing && typeof existing === 'object') return { map: existing, fromCache: true };
        let cachedOnly = null;
        try { cachedOnly = readStatesCache(true); } catch(_) { cachedOnly = null; }
        if (cachedOnly && stateHub && typeof stateHub.setMap === 'function') {
          try { stateHub.setMap(cachedOnly); } catch(_) {}
        }
        return { map: cachedOnly || {}, fromCache: true };
      }
      try {
        if (stateHub && stateHub.loading) return stateHub.loading;
      } catch (_) {}
      const ref = db.collection('config').doc('states');
      const tryGet = async () => {
        try { return await ref.get({ source: 'server' }); } catch(_) { return await ref.get(); }
      };
      let promise;
      promise = (async () => {
        try {
          let doc = await tryGet();
          if (!doc || !doc.exists) {
            let cachedFallback = null;
            try { cachedFallback = readStatesCache(true); } catch(_) { cachedFallback = null; }
            if (cachedFallback && stateHub && typeof stateHub.setMap === 'function') {
              try { stateHub.setMap(cachedFallback); } catch(_) {}
            }
            return { map: cachedFallback || {}, fromCache: true };
          }
          const data = doc.data() || {};
          let map = {};
          if (typeof data.stateJson === 'string') {
            try { map = JSON.parse(data.stateJson); } catch(_) { map = {}; }
          } else if (data.map && typeof data.map === 'object') {
            map = data.map;
          } else {
            map = data;
          }
          saveStatesCache(map);
          try {
            if (stateHub && typeof stateHub.setMap === 'function') stateHub.setMap(map);
          } catch (_) {}
          return { map, fromCache: false };
        } catch (e) {
          try {
            var ENABLE_ANON = false; // عطِّل افتراضيًا لتجنّب أخطاء 400
            if (ENABLE_ANON && e && e.code === 'permission-denied' && auth && !auth.currentUser && auth.signInAnonymously) {
              await auth.signInAnonymously();
              const doc = await tryGet();
              if (doc && doc.exists) {
                const data = doc.data() || {};
                let map = {};
                if (typeof data.stateJson === 'string') { try { map = JSON.parse(data.stateJson); } catch(_) { map = {}; } }
                else if (data.map && typeof data.map === 'object') { map = data.map; }
                else { map = data; }
                saveStatesCache(map);
                try {
                  if (stateHub && typeof stateHub.setMap === 'function') stateHub.setMap(map);
                } catch (_) {}
                return { map, fromCache: false };
              }
            }
          } catch(_) { /* تجاهل */ }
          let fallback = null;
          try { fallback = readStatesCache(true); } catch(_) { fallback = null; }
          if (fallback && stateHub && typeof stateHub.setMap === 'function') {
            try { stateHub.setMap(fallback); } catch(_) {}
          }
          return { map: fallback || {}, fromCache: true };
        } finally {
          try {
            if (stateHub && typeof stateHub.clearLoading === 'function') stateHub.clearLoading(promise);
            else if (stateHub && stateHub.loading === promise) stateHub.loading = null;
          } catch (_) {}
        }
      })();
      try {
        if (stateHub && typeof stateHub.setLoading === 'function') stateHub.setLoading(promise);
        else if (stateHub) stateHub.loading = promise;
      } catch (_) {}
      return promise;
    }

    function cardStateKey(card) {
      try {
        if (card && card.dataset) {
          if (card.dataset.stateKey) return card.dataset.stateKey;
          if (card.dataset.originalStateKey) return card.dataset.originalStateKey;
        }
        var href = (card.dataset && card.dataset.originalHref) || card.getAttribute('href') || '';
        href = href.split('?')[0].split('#')[0];
        return href.replace(/\.html$/,'');
      } catch(_) {
        return '';
      }
    }

    function applyCardsVisibility() {
      const cards = document.querySelectorAll('.card');
      if (!cards.length) return;

      cards.forEach(card => {
        if (!card.dataset.originalHref) {
          const href = card.getAttribute('href');
          if (href) card.dataset.originalHref = href;
        }
        if (card.dataset && card.dataset.stateKey && !card.dataset.originalStateKey) {
          card.dataset.originalStateKey = card.dataset.stateKey;
        }
        const titleEl = card.querySelector('h2');
        if (!card.dataset.originalTitle && titleEl) {
          card.dataset.originalTitle = titleEl.textContent;
        }
      });

      let hubMap = null;
      try {
        if (stateHub && typeof stateHub.getMap === 'function') hubMap = stateHub.getMap();
      } catch (_) { hubMap = null; }
      let cached = (hubMap && typeof hubMap === 'object') ? hubMap : null;
      if (!cached) {
        try { cached = readStatesCache(window.__SKIP_FIREBASE__ ? true : false); } catch(_) { cached = null; }
        if (cached && stateHub && typeof stateHub.setMap === 'function') {
          try { stateHub.setMap(cached); hubMap = stateHub.getMap(); } catch(_) {}
        }
      }
      if (!cached && hubMap && typeof hubMap === 'object') cached = hubMap;

      const hasCache = cached && typeof cached === 'object';
      const pendingCards = [];
      const snapshot = {};

      cards.forEach(card => {
        const pageName = cardStateKey(card);
        if (!pageName) return;
        let state = null;
        if (hasCache && Object.prototype.hasOwnProperty.call(cached, pageName)) {
          state = cached[pageName];
        } else if (hubMap && typeof hubMap === 'object' && Object.prototype.hasOwnProperty.call(hubMap, pageName)) {
          state = hubMap[pageName];
        }

        if (state === 'off') {
          applyCardState(card, 'off');
          snapshot[pageName] = 'off';
        } else if (state === 'on') {
          applyCardState(card, 'on');
          snapshot[pageName] = 'on';
        } else {
          if (!card.classList.contains('pending-state')) {
            card.classList.add('pending-state');
          }
          pendingCards.push(card);
        }
      });

      if (stateHub && typeof stateHub.mergeMap === 'function' && Object.keys(snapshot).length) {
        try { stateHub.mergeMap(snapshot); } catch(_) {}
      }

      if (pendingCards.length) {
        const releasePending = () => {
          const update = {};
          pendingCards.forEach(card => {
            applyCardState(card, 'on');
            const pageName = cardStateKey(card);
            if (pageName) update[pageName] = 'on';
          });
          if (stateHub && typeof stateHub.mergeMap === 'function' && Object.keys(update).length) {
            try { stateHub.mergeMap(update); } catch(_) {}
          }
        };
        setTimeout(releasePending, hasCache ? 1200 : 800);
      }

      if (window.__SKIP_FIREBASE__) return;

      loadStatesMap()
        .then(result => {
          const map = (result && result.map) ? result.map : result;
          const resolved = map || readStatesCache(false) || {};
          const normalized = {};
          cards.forEach(card => {
            const pageName = cardStateKey(card);
            if (!pageName) return;
            const state = (pageName && Object.prototype.hasOwnProperty.call(resolved, pageName)) ? resolved[pageName] : 'on';
            applyCardState(card, state);
            normalized[pageName] = state;
          });
          if (Object.keys(normalized).length) {
            try {
              if (stateHub && typeof stateHub.mergeMap === 'function') stateHub.mergeMap(normalized);
              saveStatesCache(normalized);
            } catch (_) {}
          }
        })
        .catch(() => { /* تجاهل */ });
    }

    // ابدأ مباشرة دون الانتظار
    applyCardsVisibility();


    // توافق قديم للثيم
  document.addEventListener('DOMContentLoaded', function () {
    var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.body.classList.toggle('dark-mode', isDark);

      // عرض الحسابات مباشرة حسب الأقسام (حسابات ملكية / أسطورية / مميزة / أخرى)
    const input = document.getElementById('searchInput');
    const container = document.getElementById('categoriesContainer');
    const noResults = document.getElementById('noResults');
    if(!input || !container) return;

      let CATEGORY_LABELS = {};
      let CATEGORY_ORDER = [];

      const norm = s => (s||'').toString().toLowerCase()
        .replace(/[ًٌٍَُِّْـ]/g,'')
        .replace(/[إأآا]/g,'ا')
        .replace(/ى/g,'ي')
        .replace(/ة/g,'ه')
        .replace(/[^\p{L}\p{N}\s]/gu,'')
        .trim();

      let accountsData = [];

      function formatPrice(val){
        if (val == null || val === '') return 'غير محدد';
        const num = Number(val);
        if (!Number.isFinite(num)) return 'غير محدد';
        if (typeof window.formatCurrencyFromJOD === 'function'){
          try { return window.formatCurrencyFromJOD(num); } catch(_){}
        }
        return num.toFixed(2) + ' $';
      }

      function render(){
        const query = norm(input.value);
        const visible = accountsData.filter(acc => {
          const status = (acc.status || '').toLowerCase();
          if (status && status !== 'approved') return false;
          const title = acc.title || '';
          const desc = acc.description || '';
          const contact = acc.contact || '';
          const catLabel = CATEGORY_LABELS[acc.category] || acc.category || '';
          const hay = [title, desc, contact, catLabel].map(norm).join(' ');
          return query === '' || hay.includes(query);
        });

        if (!visible.length){
          container.innerHTML = '';
          if (noResults) noResults.style.display = 'block';
          return;
        }
        if (noResults) noResults.style.display = 'none';

        const grouped = visible.reduce((map, acc) => {
          const key = acc.category || 'other';
          if (!map[key]) map[key] = [];
          map[key].push(acc);
          return map;
        }, {});

        const orderedKeys = CATEGORY_ORDER.concat(Object.keys(grouped).filter(k => !CATEGORY_ORDER.includes(k)));
        const sections = orderedKeys.filter(k => grouped[k]).map(key => {
          const list = grouped[key];
          const label = CATEGORY_LABELS[key] || (key === 'other' ? 'حسابات أخرى' : key || 'حسابات أخرى');
          const cards = list.map(acc => {
            const img = (Array.isArray(acc.images) && acc.images[0]) || acc.image || 'loading.png';
            const price = formatPrice(acc.price);
            const desc = acc.description || '';
            const sold = acc.status === 'sold';
            const shortDesc = desc.length > 52 ? (desc.slice(0, 52) + '...') : desc;
            return `
              <article class="account-card" data-account-id="${acc.id || ''}">
                ${sold ? '<span class="account-badge">مباع</span>' : ''}
                <div class="account-thumb">
                  <img src="${img}" alt="${acc.title || 'حساب'}" loading="lazy" decoding="async">
                </div>
                  <div class="account-body">
                    <div class="account-meta" style="justify-content:flex-start;gap:12px;">
                    <span class="account-price" data-price-usd="${acc.price != null ? Number(acc.price) : ''}">${price}</span>
                    </div>
                    <h3 class="account-title">${acc.title || 'حساب'}</h3>
                    ${desc ? `<p class="account-desc">${shortDesc}</p>` : ''}
                    <div class="account-actions">
                    <a class="btn" href="account.html?id=${acc.id || ''}">عرض التفاصيل</a>
                    </div>
                  </div>
                </article>
            `;
          }).join('');
          return `
            <section class="account-group">
              <div class="account-group__header">
                <h2 class="account-group__title">${label}</h2>
              </div>
              <div class="accounts-grid">${cards}</div>
            </section>
          `;
        });

        container.innerHTML = sections.join('');
      }

      async function loadCategoriesDirect(){
        if (!firebaseAvailable || !db) return;
        try{
          const snap = await db.collection('categories').get();
          const list = snap.docs.map(d => ({ id: d.id, ...(d.data()||{}) }));
          if (list.length){
            const map = {};
            list.forEach(c => {
              const key = c.id || c.key || c.slug;
              const label = c.label || c.name || key;
              if (key) map[key] = label;
            });
            if (Object.keys(map).length){
              CATEGORY_LABELS = map;
              CATEGORY_ORDER = Object.keys(map);
              try { window.__CATEGORY_MAP__ = map; } catch(_) {}
            }
          }
        }catch(e){ console.warn('تعذر تحميل الأقسام', e); }
      }

      async function loadAccountsDirect(){
        accountsData = [];
        if (firebaseAvailable && db){
          try {
            const snap = await db.collection('accounts').get();
            accountsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          } catch(e){
            console.warn('تعذر تحميل الحسابات', e);
          }
        }
      }

      const KEY = 'home:q';
      const saved = localStorage.getItem(KEY) || '';
      if (saved) input.value = saved;

      (async () => { await loadCategoriesDirect(); await loadAccountsDirect(); render(); })();

      // البحث يعتمد على إدخال فوري أو Enter
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); localStorage.setItem(KEY, input.value); render(); }
      });
      let t;
      input.addEventListener('input', () => { clearTimeout(t); t = setTimeout(() => render(), 150); });
      window.addEventListener('currency:change', render);
      window.addEventListener('currency:rates:change', render);

      // علّم الملاحة أنها تمت من الرئيسية قبل الانتقال
      document.addEventListener('click', function(e){
        const a = e.target.closest('a[href$=".html"]');
        if (a) { try { sessionStorage.setItem('nav:fromHome','1'); } catch(e){} }
      });
    });
  </script>
  <!-- تمت إزالة ماسح صفحات HTML: أصبح التحميل المسبق للصور عبر Service Worker فقط -->
  
  <!-- Inline loader for games/social/software/webdev without redirect -->
  <script>
    (function(){
      var settingsRoute = (function(){
        function generateGuardToken(prefix){
          var tag = (prefix || 'guard');
          try{
            var cryptoSource = null;
            if (typeof window !== 'undefined' && window.crypto && typeof window.crypto.getRandomValues === 'function'){
              cryptoSource = window.crypto;
            } else if (typeof self !== 'undefined' && self.crypto && typeof self.crypto.getRandomValues === 'function'){
              cryptoSource = self.crypto;
            }
            if (cryptoSource){
              var buf = new Uint32Array(2);
              cryptoSource.getRandomValues(buf);
              var hex = Array.from(buf).map(function(n){ return n.toString(16).padStart(8,'0'); }).join('');
              return tag + '-' + Date.now().toString(36) + '-' + hex;
            }
          }catch(_){}
          return tag + '-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2);
        }
        var state = {
          root: null,
          refs: null,
          unsubAuth: null,
          auth: null,
          db: null,
          balanceUsd: null,
          copyBound: false,
          resetBound: false,
          themeBound: false,
          currencyBound: false,
          authRetry: 0,
          currentUid: null
        };

        function ensureRoot(){
          if (state.root) return state.root;
          var root = document.createElement('div');
          root.className = 'settings-page';
          var markup = [
            '<div class="settings-spacer" aria-hidden="true"></div>',
            '<div class="main-content">',
            '  <div class="container">',
            '    <h2>إعدادات الحساب</h2>',
            '    <div class="info-list">',
            '      <div class="info-card col-6"><div class="label"><i class="fa-regular fa-id-badge"></i> الاسم</div><div class="value"><span id="username" class="copyable">--</span></div></div>',
            '      <div class="info-card col-6"><div class="label"><i class="fa-solid fa-signal"></i> المستوى</div><div class="value"><span id="level" class="copyable badge">--</span></div></div>',
            '      <div class="info-card col-6"><div class="label"><i class="fa-regular fa-envelope"></i> البريد</div><div class="value"><span id="email" class="copyable">--</span></div></div>',
            '      <div class="info-card col-6"><div class="label"><i class="fa-solid fa-mobile-screen"></i> الهاتف</div><div class="value"><span id="phone" class="copyable">--</span></div></div>',
            '      <div class="info-card col-6"><div class="label"><i class="fa-solid fa-wallet"></i> الرصيد</div><div class="value"><span id="balance" class="copyable">--</span></div></div>',
            '      <div class="info-card col-6"><div class="label"><i class="fa-solid fa-coins"></i>الإنفاق</div><div class="value"><span id="totalspent" class="copyable">--</span><span class="badge">$</span></div></div>',
            '      <div class="info-card col-12"><div class="label"><i class="fa-regular fa-hashtag"></i> الايدي</div><div class="value"><span id="webuid" class="copyable">--</span></div></div>',
            '    </div>',
            '    <button id="resetBtn" type="button"><i class="fa-solid fa-key"></i> إعادة تعيين كلمة المرور</button>',
            '    <div id="msg"></div>',
            '    <button id="themeToggle" class="theme-toggle" type="button">🌙 الوضع الداكن</button>',
            '  </div>',
            '</div>'
          ].join('');
          root.innerHTML = markup;
          state.root = root;
          state.refs = {
            username: root.querySelector('#username'),
            level: root.querySelector('#level'),
            email: root.querySelector('#email'),
            phone: root.querySelector('#phone'),
            balance: root.querySelector('#balance'),
            totalspent: root.querySelector('#totalspent'),
            webuid: root.querySelector('#webuid'),
            resetBtn: root.querySelector('#resetBtn'),
            msg: root.querySelector('#msg'),
            themeToggle: root.querySelector('#themeToggle')
          };
          ['username','level','email','phone','balance','totalspent','webuid'].forEach(function(key){
            var el = state.refs[key];
            if (el && !el.dataset.copy){ el.dataset.copy = el.textContent || ''; }
          });
          updateMessage('', true);
          setupCopy();
          setupReset();
          bindTheme();
          ensureCurrencyListeners();
          return root;
        }

        function ensureFirebase(){
          if (typeof firebase === 'undefined') return null;
          try {
            if (window.__ORIG_FIREBASE__){
              if (window.__ORIG_FIREBASE__.auth) firebase.auth = window.__ORIG_FIREBASE__.auth;
              if (window.__ORIG_FIREBASE__.firestore) firebase.firestore = window.__ORIG_FIREBASE__.firestore;
            }
            window.__SKIP_FIREBASE__ = false;
          } catch(_){}
          try {
            if ((!firebase.apps || !firebase.apps.length) && window.__FIREBASE_CONFIG__){
              firebase.initializeApp(window.__FIREBASE_CONFIG__);
            }
          } catch(_){}
          var auth = null;
          var db = null;
          try { auth = firebase.auth(); } catch(_){}
          try { db = firebase.firestore(); } catch(_){}
          if (!auth || !db) return null;
          state.auth = auth;
          state.db = db;
          return { auth: auth, db: db };
        }

        function formatBalance(value){
          var v = Number(value || 0);
          if (typeof window.formatCurrencyFromJOD === 'function'){
            try { return window.formatCurrencyFromJOD(v); } catch(_){}
          }
          return v.toFixed(2) + ' $';
        }

        function renderBalance(value){
          state.balanceUsd = Number(value || 0);
          try { window.__BAL_BASE__ = state.balanceUsd; } catch(_){}
          var txt = formatBalance(state.balanceUsd);
          if (state.refs && state.refs.balance){
            state.refs.balance.textContent = txt;
            state.refs.balance.dataset.copy = txt;
          }
        }

        function tryRenderCachedBalance(uid){
          if (!uid) return;
          try{
            var raw = localStorage.getItem('balance:cache:' + uid);
            var val = Number(raw);
            if (Number.isFinite(val)) renderBalance(val);
          }catch(_){}
        }

        function updateField(el, value){
          if (!el) return;
          var val = value;
          if (val === undefined || val === null || (typeof val === 'string' && val.trim() === '')){
            val = '--';
          }
          el.textContent = String(val);
          el.dataset.copy = String(val);
        }

        function showToast(text, ok){
          try{
            var isError = ok === false;
            var fallback = isError ? 'حدث خطأ غير معروف' : 'تم تنفيذ العملية';
            var message = text;
            if (message == null || (typeof message === 'string' && message.trim() === '')){
              message = fallback;
            } else if (typeof message !== 'string'){
              message = String(message);
            }
            var toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = (isError ? '❌ ' : '✅ ') + message;
            document.body.appendChild(toast);
            setTimeout(function(){
              try { toast.remove(); } catch(_){ if (toast.parentNode) toast.parentNode.removeChild(toast); }
            }, 1800);
          }catch(_){}
        }
        try { window.showToast = showToast; } catch(_){}

        function copyText(text){
          var val = (text || '').trim();
          if (!val) return Promise.reject(new Error('empty'));
          if (navigator.clipboard && navigator.clipboard.writeText){
            return navigator.clipboard.writeText(val);
          }
          return new Promise(function(resolve, reject){
            try{
              var ta = document.createElement('textarea');
              ta.value = val;
              ta.style.position = 'fixed';
              ta.style.opacity = '0';
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              var ok = document.execCommand('copy');
              document.body.removeChild(ta);
              if (ok) resolve(); else reject(new Error('copy-failed'));
            }catch(err){
              reject(err);
            }
          });
        }

        function setupCopy(){
          if (state.copyBound || !state.root) return;
          state.root.addEventListener('click', function(e){
            if (!state.root) return;
            var target = e.target && e.target.closest ? e.target.closest('.copyable') : null;
            if (!target || !state.root.contains(target)) return;
            var val = (target.dataset && target.dataset.copy) ? target.dataset.copy : target.textContent;
            copyText(val).then(function(){
              try { target.classList.add('copied'); } catch(_){}
              showToast('تم النسخ', true);
              setTimeout(function(){
                try { target.classList.remove('copied'); } catch(_){}
              }, 1000);
            }).catch(function(){
              showToast('تعذر النسخ', false);
            });
          });
          state.copyBound = true;
        }

        function updateMessage(text, ok){
          if (!state.refs || !state.refs.msg) return;
          state.refs.msg.textContent = text || '';
          if (ok === false){
            state.refs.msg.style.color = 'var(--danger)';
          } else {
            state.refs.msg.style.color = 'var(--success)';
          }
        }

        function setupReset(){
          if (state.resetBound || !state.refs || !state.refs.resetBtn) return;
          state.refs.resetBtn.addEventListener('click', function(){
            var service = ensureFirebase();
            var auth = service ? service.auth : null;
            if (!auth){
              showToast('تعذر الوصول إلى الحساب', false);
              return;
            }
            var user = auth.currentUser;
            if (!user || !user.email){
              showToast('يرجى تسجيل الدخول أولاً', false);
              return;
            }
            state.refs.resetBtn.disabled = true;
            auth.sendPasswordResetEmail(user.email).then(function(){
              updateMessage('📨 تم إرسال رابط إعادة التعيين إلى بريدك.', true);
              showToast('تم إرسال البريد', true);
              state.refs.resetBtn.disabled = false;
            }).catch(function(){
              updateMessage('حدث خطأ أثناء الإرسال.', false);
              showToast('حدث خطأ أثناء الإرسال', false);
              state.refs.resetBtn.disabled = false;
            });
          });
          state.resetBound = true;
        }

        function ensureCurrencyListeners(){
          if (state.currencyBound) return;
          var rerender = function(){
            if (state.balanceUsd != null) renderBalance(state.balanceUsd);
          };
          window.addEventListener('currency:change', rerender);
          window.addEventListener('currency:rates:change', rerender);
          window.addEventListener('balance:change', function(ev){
            if (!ev || !ev.detail) return;
            var val = Number(ev.detail.value);
            if (Number.isFinite(val)) renderBalance(val);
          });
          state.currencyBound = true;
        }

        function getCurrentTheme(){
          var attr = (document.documentElement.getAttribute('data-theme') || '').toLowerCase();
          if (attr === 'dark' || attr === 'light') return attr;
          var saved = null;
          try { saved = localStorage.getItem('theme'); } catch(_){}
          return saved === 'light' ? 'light' : 'dark';
        }

        function syncBodyThemeClass(){
          var current = getCurrentTheme();
          document.body.classList.toggle('dark-mode', current === 'dark');
        }

        function setTheme(theme){
          if (!theme) return;
          document.documentElement.setAttribute('data-theme', theme);
          syncBodyThemeClass();
          try { localStorage.setItem('theme', theme); } catch(_){}
          try {
            var metaCS = document.querySelector('meta[name="color-scheme"]');
            if (metaCS) metaCS.setAttribute('content', theme === 'dark' ? 'dark light' : 'light dark');
          } catch(_){}
          try {
            var metaTC = document.querySelector('meta[name="theme-color"]');
            if (metaTC) metaTC.setAttribute('content', theme === 'dark' ? '#05050b' : '#f8f9fa');
          } catch(_){}
          try {
            var evt = new CustomEvent('theme:change', { detail: { theme: theme } });
            window.dispatchEvent(evt);
          } catch(_){}
        }

        function updateThemeToggleText(){
          if (!state.refs || !state.refs.themeToggle) return;
          var current = getCurrentTheme();
          state.refs.themeToggle.textContent = current === 'dark'
            ? '☀️ الوضع الفاتح'
            : '🌙 الوضع الداكن';
        }

        function bindTheme(){
          if (state.themeBound || !state.refs || !state.refs.themeToggle) return;
          state.refs.themeToggle.addEventListener('click', function(){
            var current = getCurrentTheme();
            var next = current === 'dark' ? 'light' : 'dark';
            setTheme(next);
            updateThemeToggleText();
          });
          state.themeBound = true;
          updateThemeToggleText();
        }

        function attachAuth(){
          if (state.unsubAuth) return;
          var services = ensureFirebase();
          if (!services || !services.auth || !services.db){
            if (state.authRetry < 6){
              state.authRetry += 1;
              setTimeout(attachAuth, 600);
            }
            return;
          }
          state.authRetry = 0;
          state.auth = services.auth;
          state.db = services.db;
          state.unsubAuth = state.auth.onAuthStateChanged(function(user){
            if (!state.refs) return;
            if (!user){
              try { window.location.href = 'login.html'; } catch(_){ }
              return;
            }
            state.currentUid = user.uid;
            updateField(state.refs.email, user.email || '--');
            tryRenderCachedBalance(user.uid);
            state.db.collection('users').doc(user.uid).get().then(function(doc){
              if (!state.refs) return;
              if (!doc || !doc.exists) return;
              var data = doc.data() || {};
              updateField(state.refs.username, data.username || '--');
              updateField(state.refs.level, data.level || '--');
              updateField(state.refs.totalspent, (data.totalspent == null ? 0 : data.totalspent).toString());
              updateField(state.refs.phone, data.phone || '--');
              updateField(state.refs.webuid, data.webuid || '--');
              renderBalance(data.balance == null ? 0 : data.balance);
              try { localStorage.setItem('balance:cache:' + user.uid, String(Number(data.balance == null ? 0 : data.balance) || 0)); } catch(_){}
            }).catch(function(){
              showToast('تعذر تحميل البيانات', false);
            });
          });
        }

        function build(){
          var root = ensureRoot();
          attachAuth();
          updateThemeToggleText();
          syncBodyThemeClass();
          var frag = document.createDocumentFragment();
          frag.appendChild(root);
          return frag;
        }

        function onShow(){
          updateThemeToggleText();
          syncBodyThemeClass();
        }

        return {
          build: build,
          onShow: onShow
        };
      })();

      var transferRoute = (function(){
        var DEFAULT_BASE = "https://js4acc.laithqarqaz1.workers.dev/";
        var DEFAULT_TURNSTILE_SITEKEY = "0x4AAAAAABmiVmi7wosqeHQT";

        function resolveTurnstileSiteKey(){
          try{
            var meta = document.querySelector('meta[name="turnstile-sitekey"]');
            var fromMeta = meta && meta.content ? meta.content.trim() : "";
            var fromWindow = (window.TURNSTILE_SITE_KEY || window.__TURNSTILE_SITE_KEY__ || "").trim();
            return fromMeta || fromWindow || DEFAULT_TURNSTILE_SITEKEY;
          }catch(_){
            return DEFAULT_TURNSTILE_SITEKEY;
          }
        }

        var state = {
          root: null,
          refs: null,
          auth: null,
          db: null,
          unsubAuth: null,
          currentUser: null,
          profile: null,
          loading: false,
          eventsBound: false,
          balanceListenerBound: false,
          turnstileSiteKey: resolveTurnstileSiteKey(),
          turnstileReady: null,
          turnstileWidgetId: null,
          turnstileToken: "",
          turnstileResolver: null,
          turnstileRejecter: null,
          recipientInfo: null,
          lookupTimer: null
        };

        function generateGuardToken(prefix){
          var tag = (prefix || "guard");
          try{
            var cryptoSource = null;
            if (typeof window !== "undefined" && window.crypto && typeof window.crypto.getRandomValues === "function"){
              cryptoSource = window.crypto;
            } else if (typeof self !== "undefined" && self.crypto && typeof self.crypto.getRandomValues === "function"){
              cryptoSource = self.crypto;
            }
            if (cryptoSource){
              var buf = new Uint32Array(2);
              cryptoSource.getRandomValues(buf);
              var hex = Array.from(buf).map(function(n){ return n.toString(16).padStart(8,"0"); }).join("");
              return tag + "-" + Date.now().toString(36) + "-" + hex;
            }
          }catch(_){}
          return tag + "-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2);
        }

        function copyText(value){
          var text = (value || "").toString();
          if (!text.trim()) return Promise.reject(new Error("empty"));
          if (navigator.clipboard && navigator.clipboard.writeText){
            return navigator.clipboard.writeText(text);
          }
          return new Promise(function(resolve, reject){
            try{
              var ta = document.createElement("textarea");
              ta.value = text;
              ta.style.position = "fixed";
              ta.style.opacity = "0";
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              var ok = document.execCommand("copy");
              document.body.removeChild(ta);
              if (ok) resolve(); else reject(new Error("copy_failed"));
            }catch(err){ reject(err); }
          });
        }

        function createError(code, message){
          var err = new Error(message || code || "transfer_error");
          err.code = code || "transfer_error";
          return err;
        }

        function parseNumber(value){
          if (value == null) return 0;
          if (typeof value === "number") return Number(value) || 0;
          if (typeof value === "string"){
            var cleaned = value.replace(/[^\d\-,.]/g, "").replace(/,/g, "");
            var num = Number(cleaned);
            return Number.isFinite(num) ? num : 0;
          }
          return 0;
        }

        function normalizeWebuid(value){
          return (value || "").toString().trim();
        }

        function formatBalance(value){
          var n = Number(value) || 0;
          if (typeof window.formatCurrencyFromJOD === "function"){
            try { return window.formatCurrencyFromJOD(n); } catch(_){}
          }
          try { return n.toFixed(3) + " $"; } catch(_){ return String(n); }
        }

        function readSessionKey(){
          try{
            var raw = localStorage.getItem("sessionKeyInfo");
            if (!raw) return "";
            var parsed = JSON.parse(raw);
            return parsed && parsed.sessionKey ? parsed.sessionKey : "";
          }catch(_){ return ""; }
        }

        function buildApiUrl(){
          var base = DEFAULT_BASE;
          try{
            var stored = localStorage.getItem("MANWAL_ROUTER_BASE");
            if (stored) base = stored;
          }catch(_){}
          try{
            var url = new URL(base);
            url.searchParams.set("game","transfers");
            return url.toString();
          }catch(_){
            return DEFAULT_BASE + (DEFAULT_BASE.indexOf("?") >= 0 ? "&" : "?") + "game=transfers";
          }
        }

        function ensureFirebase(){
          if (typeof firebase === "undefined") return;
          try{
            if (window.__ORIG_FIREBASE__){
              if (window.__ORIG_FIREBASE__.auth) firebase.auth = window.__ORIG_FIREBASE__.auth;
              if (window.__ORIG_FIREBASE__.firestore) firebase.firestore = window.__ORIG_FIREBASE__.firestore;
            }
          }catch(_){}
          try{
            if ((!firebase.apps || !firebase.apps.length) && window.__FIREBASE_CONFIG__){
              firebase.initializeApp(window.__FIREBASE_CONFIG__);
            }
          }catch(_){}
          try{
            if (!state.auth) state.auth = firebase.auth();
          }catch(_){}
          try{
            if (!state.db) state.db = firebase.firestore();
          }catch(_){}
        }

        function themeIsDark(){
          try{
            var attr = document.documentElement.getAttribute('data-theme');
            if (attr) return attr !== 'light';
            var stored = localStorage.getItem('theme');
            if (stored) return stored !== 'light';
          }catch(_){}
          return true;
        }

        function ensureRoot(){
          if (state.root) return state.root;
          var root = document.createElement("div");
          root.className = "transfer-page";
          root.innerHTML = [
            '<div class="transfer-spacer" aria-hidden="true"></div>',
            "<main>",
            '  <h2><span><i class="fa-solid fa-right-left"></i> تحويل رصيد</span></h2>',
            '  <p class="transfer-subtitle">حوّل بأمان مع تأكيد اسم المستلم قبل الإرسال.</p>',
            '  <div class="transfer-headline"></div>',
            '  <div class="transfer-meta">',
            '    <div class="card">',
            '      <div class="top">',
            '        <span class="title">رصيدك الحالي</span>',
            '      </div>',
            '      <div class="value" data-transfer-balance>--</div>',
            "    </div>",
            '    <div class="card">',
            '      <div class="top">',
            '        <span class="title">الايدي الخاص بك</span>',
            '        <button id="copyMyWebuid" type="button" class="copy-chip"><i class="fa-regular fa-copy"></i><span>نسخ</span></button>',
            '      </div>',
            '      <div class="value code" data-transfer-my-webuid>--</div>',
            "    </div>",
            "  </div>",
            '  <ul class="transfer-guidelines">',
            '    <li><i class="fa-solid fa-scale-balanced"></i><span>يمكنك مراجعة كل تحويل من سجل <strong>محفظتي</strong> مباشرة بعد التنفيذ.</span></li>',
            '    <li><i class="fa-solid fa-circle-info"></i><span>نتحقق من الاسم والمعرف قبل الإرسال، فالتحويل غير قابل للإلغاء.</span></li>',
            "  </ul>",
            '  <form id="transferForm" class="transfer-form" novalidate>',
            '    <label class="transfer-field">',
            '      <span>ايدي المستلم</span>',
            '      <input id="transferTarget" type="text" inputmode="text" autocomplete="off" maxlength="40" placeholder="مثال: ***********8454" required />',
            "    </label>",
            '    <label class="transfer-field">',
            '      <span>المبلغ بالدولار</span>',
            '      <input id="transferAmount" type="number" step="0.001" min="0.001" placeholder="0.000" required />',
            "    </label>",
            '    <div id="transferHelper" class="transfer-helper"></div>',
            '    <div id="transferStatus" class="transfer-status" role="status" aria-live="polite"></div>',
            '    <div id="transferTurnstile" class="transfer-turnstile" aria-hidden="true"></div>',
            '    <div class="transfer-actions">',
            '      <p class="transfer-footnote">لا يمكن التراجع عن التحويل نهائيا.</p>',
            '      <button id="transferSubmit" type="submit"><i class="fa-solid fa-paper-plane"></i> تأكيد التحويل</button>',
            "    </div>",
            "  </form>",
            '  <div id="transferConfirmBackdrop" class="transfer-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="transferConfirmTitle">',
            '    <div class="transfer-modal">',
            '      <h3 id="transferConfirmTitle"><i class="fa-solid fa-shield-halved"></i> تأكيد التحويل</h3>',
            '      <div class="confirm-body">',
            '        <div class="confirm-row"><span class="confirm-label">المستلم</span><span class="confirm-value" id="confirmReceiver"></span></div>',
            '        <div class="confirm-row"><span class="confirm-label">المعرف</span><span class="confirm-value" id="confirmWebuid"></span></div>',
            '        <div class="confirm-row"><span class="confirm-label">المبلغ</span><span class="confirm-value" id="confirmAmount"></span></div>',
            '      </div>',
            '      <div class="confirm-footer">',
            '        <button type="button" class="btn-ghost" id="confirmCancel">إلغاء</button>',
            '        <button type="button" class="btn-primary" id="confirmApprove"><i class="fa-solid fa-check"></i> تأكيد</button>',
            '      </div>',
            '    </div>',
            '  </div>',
            "</main>"
          ].join("");
          state.root = root;
          state.refs = {
            balance: root.querySelector('[data-transfer-balance]'),
            senderWebuid: root.querySelector('[data-transfer-my-webuid]'),
            helper: root.querySelector("#transferHelper"),
            status: root.querySelector("#transferStatus"),
            turnstile: root.querySelector("#transferTurnstile"),
            form: root.querySelector("#transferForm"),
            target: root.querySelector("#transferTarget"),
            amount: root.querySelector("#transferAmount"),
            submit: root.querySelector("#transferSubmit"),
            copyWebuid: root.querySelector("#copyMyWebuid"),
            confirmModal: root.querySelector("#transferConfirmBackdrop"),
            confirmReceiver: root.querySelector("#confirmReceiver"),
            confirmWebuid: root.querySelector("#confirmWebuid"),
            confirmAmount: root.querySelector("#confirmAmount"),
            confirmApprove: root.querySelector("#confirmApprove"),
            confirmCancel: root.querySelector("#confirmCancel")
          };
          mountConfirmModalPortal();
          bindFormEvents();
          bindBalanceListener();
          updateRecipientPreview("idle");
          updateHelperText();
          return root;
        }

        function ensureTurnstileScript(){
          if (window.turnstile) return Promise.resolve(window.turnstile);
          if (state.turnstileReady) return state.turnstileReady;
          state.turnstileReady = new Promise(function(resolve){
            var existing = document.querySelector('script[data-transfer-turnstile]');
            var resolved = false;
            var finish = function(val){
              if (resolved) return;
              resolved = true;
              resolve(val || window.turnstile || null);
            };
            if (existing){
              existing.addEventListener("load", function(){ finish(window.turnstile || null); }, { once: true });
              existing.addEventListener("error", function(){ finish(null); }, { once: true });
            } else {
              var script = document.createElement("script");
              script.src = "https://challenges.cloudflare.com/turnstile/v0/api.js?onload=__transferTurnstileInit&render=explicit";
              script.async = true;
              script.defer = true;
              script.dataset.transferTurnstile = "1";
              script.onload = function(){ finish(window.turnstile || null); };
              script.onerror = function(){ finish(null); };
              window.__transferTurnstileInit = function(){ finish(window.turnstile || null); };
              document.head.appendChild(script);
            }
            setTimeout(function(){ finish(window.turnstile || null); }, 8000);
          });
          return state.turnstileReady;
        }

        function acquireTurnstileToken(){
          return ensureTurnstileScript().then(function(turnstile){
            if (!turnstile || !state.refs || !state.refs.turnstile){
              throw createError("turnstile_unavailable","تعذر تحميل التحقق البشري، حاول تحديث الصفحة.");
            }
            var holder = state.refs.turnstile;
            holder.classList.add("active");
            if (!state.turnstileWidgetId){
              state.turnstileWidgetId = turnstile.render(holder, {
                sitekey: state.turnstileSiteKey,
                size: "invisible",
                action: "wallet-transfer",
                theme: themeIsDark() ? "dark" : "light",
                callback: function(token){
              state.turnstileToken = token || "";
              if (state.turnstileResolver) state.turnstileResolver(state.turnstileToken);
              state.turnstileResolver = null;
              state.turnstileRejecter = null;
            },
            "error-callback": function(){
              var err = createError("turnstile_failed","تعذر التحقق الأمني، جرّب مجدداً.");
              if (state.turnstileRejecter) state.turnstileRejecter(err);
              state.turnstileResolver = null;
              state.turnstileRejecter = null;
            },
            "expired-callback": function(){
              state.turnstileToken = "";
              if (state.turnstileRejecter) state.turnstileRejecter(createError("turnstile_timeout","انتهى وقت الحماية، حاول مجدداً."));
              state.turnstileResolver = null;
              state.turnstileRejecter = null;
            }
          });
        }
        return new Promise(function(resolve, reject){
          state.turnstileResolver = function(tok){
            if (state.turnstileTimer) clearTimeout(state.turnstileTimer);
            state.turnstileTimer = null;
            state.turnstileResolver = null;
            state.turnstileRejecter = null;
            if (!tok) {
              reject(createError("turnstile_failed","تعذر الحصول على رمز الحماية."));
              return;
            }
            resolve(tok);
          };
          state.turnstileRejecter = function(err){
            if (state.turnstileTimer) clearTimeout(state.turnstileTimer);
            state.turnstileTimer = null;
            state.turnstileResolver = null;
                state.turnstileRejecter = null;
                reject(err || createError("turnstile_failed","فشل الحصول على رمز الحماية."));
              };
              state.turnstileToken = "";
              try{
                turnstile.reset(state.turnstileWidgetId);
                turnstile.execute(state.turnstileWidgetId);
              }catch(err){
                state.turnstileRejecter(err);
              }
              state.turnstileTimer = setTimeout(function(){
                if (!state.turnstileToken && state.turnstileRejecter){
                  state.turnstileRejecter(createError("turnstile_timeout","انتهى وقت الحماية، حاول مجدداً."));
                }
              }, 25000);
            });
          });
        }

        function bindBalanceListener(){
          if (state.balanceListenerBound) return;
          try{
            window.addEventListener("balance:change", function(evt){
              if (!state.profile) return;
              var val = evt && evt.detail ? Number(evt.detail.value) : NaN;
              if (Number.isFinite(val)){
                state.profile.balance = val;
                updateProfileUI();
              }
            });
            state.balanceListenerBound = true;
          }catch(_){}
        }

        function mountConfirmModalPortal(){
          if (!state.refs || !state.refs.confirmModal) return;
          if (state.refs.confirmModal.dataset && state.refs.confirmModal.dataset.portaled === "1") return;
          try{
            document.body.appendChild(state.refs.confirmModal);
            if (state.refs.confirmModal.dataset) state.refs.confirmModal.dataset.portaled = "1";
          }catch(_){}
        }

        function bindFormEvents(){
          if (!state.refs || state.eventsBound) return;
          state.eventsBound = true;
          if (state.refs.form){
            state.refs.form.addEventListener("submit", handleSubmit);
          }
          if (state.refs.amount){
            state.refs.amount.addEventListener("input", updateHelperText);
          }
          if (state.refs.target){
            state.refs.target.addEventListener("input", function(){
              showStatus();
              scheduleRecipientLookup(this.value);
            });
          }
          if (state.refs.copyWebuid){
            state.refs.copyWebuid.addEventListener("click", handleCopyMyWebuid);
          }
          if (state.refs.confirmCancel){
            state.refs.confirmCancel.addEventListener("click", function(){ closeConfirmModal(false); });
          }
          if (state.refs.confirmApprove){
            state.refs.confirmApprove.addEventListener("click", function(){ closeConfirmModal(true); });
          }
          if (state.refs.confirmModal){
            state.refs.confirmModal.addEventListener("click", function(evt){
              if (evt.target === state.refs.confirmModal) closeConfirmModal(false);
            });
          }
          document.addEventListener("keydown", function(evt){
            if (evt.key === "Escape" && state.refs && state.refs.confirmModal && state.refs.confirmModal.classList.contains("show")){
              closeConfirmModal(false);
            }
          });
        }

        function handleCopyMyWebuid(){
          var val = state.profile && state.profile.webuid;
          copyText(val || "").then(function(){
            showToast("تم نسخ الايدي", true);
          }).catch(function(){
            showToast("تعذر النسخ", false);
          });
        }

        function closeConfirmModal(approved){
          if (!state.refs || !state.refs.confirmModal) return;
          state.refs.confirmModal.classList.remove("show");
          state.refs.confirmModal.setAttribute("aria-hidden","true");
          document.documentElement.classList.remove("transfer-modal-open");
          document.body.classList.remove("transfer-modal-open");
          if (state.confirmResolver){
            state.confirmResolver(!!approved);
            state.confirmResolver = null;
          }
        }

        function showConfirmModal(params){
          if (!state.refs || !state.refs.confirmModal){
            return Promise.resolve(false);
          }
          mountConfirmModalPortal();
          var receiver = params && params.receiver ? params.receiver : "--";
          var webuid = params && params.webuid ? params.webuid : "--";
          var amount = params && params.amount ? params.amount : 0;
          state.refs.confirmReceiver.textContent = receiver;
          state.refs.confirmWebuid.textContent = webuid;
          state.refs.confirmAmount.textContent = formatBalance(amount);
          state.refs.confirmModal.classList.add("show");
          state.refs.confirmModal.setAttribute("aria-hidden","false");
          document.documentElement.classList.add("transfer-modal-open");
          document.body.classList.add("transfer-modal-open");
          return new Promise(function(resolve){
            state.confirmResolver = resolve;
          });
        }

        function updateRecipientPreview(status, payload){
          var card = state.refs && state.refs.recipientCard;
          var nameEl = state.refs && state.refs.recipientName;
          var hintEl = state.refs && state.refs.recipientHint;
          if (!card || !nameEl || !hintEl) return;
          var stateName = status || "idle";
          card.setAttribute("data-state", stateName);
          if (stateName === "loading"){
            nameEl.textContent = "جارِ البحث عن المستلم...";
            hintEl.textContent = "نحتاج إلى الاسم قبل تأكيد التحويل.";
          } else if (stateName === "found"){
            var data = payload || state.recipientInfo || {};
            var username = data.username || "مستخدم بدون اسم";
            var webuid = data.webuid || "";
            nameEl.textContent = username;
            var hint = webuid ? ("المعرف: " + webuid) : "تم العثور على المستلم.";
            if (data.level) hint += " • المستوى: " + data.level;
            hintEl.textContent = hint;
          } else if (stateName === "error"){
            nameEl.textContent = "تعذر العثور على اسم المستلم.";
            hintEl.textContent = (payload && payload.message) ? payload.message : "تحقق من webuid وأعد المحاولة.";
          } else if (stateName === "need-login"){
            nameEl.textContent = "سجّل الدخول للبحث عن المستلم.";
            hintEl.textContent = "نسجّل الاسم فور تسجيل الدخول.";
          } else {
            nameEl.textContent = "أدخل webuid للتحقق من اسم المستلم.";
            hintEl.textContent = "لن نبدأ التحويل قبل ظهور الاسم.";
          }
        }

        function scheduleRecipientLookup(value, immediate){
          if (!state.refs || !state.refs.target) return;
          var next = normalizeWebuid(value != null ? value : state.refs.target.value);
          if (state.lookupTimer) clearTimeout(state.lookupTimer);
          if (state.recipientInfo && state.recipientInfo.webuid && state.recipientInfo.webuid !== next){
            state.recipientInfo = null;
          }
          if (!next){
            state.recipientInfo = null;
            updateRecipientPreview(state.currentUser ? "idle" : "need-login");
            return;
          }
          updateRecipientPreview("loading");
          var runner = function(){ lookupRecipient(next).catch(function(){}); };
          if (immediate){
            runner();
          } else {
            state.lookupTimer = setTimeout(runner, 350);
          }
        }

        function lookupRecipient(target){
          var webuid = normalizeWebuid(target);
          if (!webuid){
            state.recipientInfo = null;
            updateRecipientPreview(state.currentUser ? "idle" : "need-login");
            return Promise.resolve(null);
          }
          if (!state.currentUser){
            updateRecipientPreview("need-login");
            return Promise.resolve(null);
          }
          var sessionKey = readSessionKey();
          if (!sessionKey){
            updateRecipientPreview("error", { message: "أعد تسجيل الدخول لتجديد الجلسة." });
            return Promise.resolve(null);
          }
          updateRecipientPreview("loading");
          return state.currentUser.getIdToken().then(function(token){
            var payload = {
              action: "lookup",
              targetWebuid: webuid,
              guardToken: generateGuardToken("lookup")
            };
            return fetch(buildApiUrl(), {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token,
                "X-SessionKey": sessionKey
              },
              body: JSON.stringify(payload)
            });
          }).then(async function(res){
            var data = await res.json().catch(function(){ return {}; });
            if (!res.ok || data.success === false){
              throw createError(data.code || "lookup_failed", data.error || "تعذر العثور على المستلم.");
            }
            var info = {
              webuid: data.webuid || webuid,
              username: data.username || data.name || "",
              level: data.level || null
            };
            state.recipientInfo = info;
            updateRecipientPreview("found", info);
            return info;
          }).catch(function(err){
            state.recipientInfo = null;
            updateRecipientPreview("error", { message: err && err.message ? err.message : "تعذر العثور على المستلم." });
            return null;
          });
        }

        function bindAuth(){
          ensureFirebase();
          if (!state.auth){
            setNeedLogin();
            return;
          }
          if (state.unsubAuth) return;
          state.unsubAuth = state.auth.onAuthStateChanged(function(user){
            state.currentUser = user || null;
            if (!user){
              state.profile = null;
              updateProfileUI();
              setNeedLogin();
              return;
            }
            setFormDisabled(false);
            loadProfile(user);
          });
        }

        function setNeedLogin(){
          state.recipientInfo = null;
          setFormDisabled(true);
          showStatus("info","سجّل الدخول لاستخدام تحويل الرصيد.");
          if (state.refs && state.refs.helper){
            state.refs.helper.textContent = "تحتاج إلى تسجيل الدخول لتستطيع التحويل.";
            state.refs.helper.classList.remove("warn");
          }
          updateRecipientPreview("need-login");
        }

        function setFormDisabled(disabled){
          if (!state.refs) return;
          var keys = ["target","amount","submit"];
          keys.forEach(function(key){
            if (state.refs[key]) state.refs[key].disabled = disabled || state.loading;
          });
        }

        function loadProfile(user){
          if (!user || !state.db){
            showStatus("error","تعذر تحميل معلومات المستخدم.");
            return;
          }
          try{
            setFormDisabled(true);
            showStatus("info","جاري تحميل بياناتك...");
            state.db.collection("users").doc(user.uid).get().then(function(doc){
              if (!doc || !doc.exists){
                throw new Error("لا توجد بيانات حساب متاحة.");
              }
              var data = doc.data() || {};
              state.profile = {
                uid: user.uid,
                webuid: data.webuid || data.webUid || user.uid,
                balance: parseNumber(data.balance || data.balanceUsd || data.balanceUSD)
              };
              updateProfileUI();
              showStatus();
              setFormDisabled(false);
            }).catch(function(err){
              state.profile = null;
              updateProfileUI();
              setFormDisabled(true);
              showStatus("error", err && err.message ? err.message : "تعذر تحميل بيانات المستخدم.");
            });
          }catch(_){
            setFormDisabled(true);
            showStatus("error","تعذر الوصول لقاعدة البيانات.");
          }
        }

        function updateProfileUI(){
          if (!state.refs) return;
          if (state.profile){
            if (state.refs.balance) state.refs.balance.textContent = formatBalance(state.profile.balance);
            if (state.refs.senderWebuid) state.refs.senderWebuid.textContent = state.profile.webuid || "--";
            setFormDisabled(false);
            updateRecipientPreview("idle");
            if (state.refs.target && state.refs.target.value){
              scheduleRecipientLookup(state.refs.target.value, true);
            }
          } else {
            if (state.refs.balance) state.refs.balance.textContent = "--";
            if (state.refs.senderWebuid) state.refs.senderWebuid.textContent = "--";
            setFormDisabled(true);
            updateRecipientPreview("need-login");
          }
          updateHelperText();
        }

        function updateHelperText(){
          if (!state.refs || !state.refs.helper) return;
          var helper = state.refs.helper;
          if (!state.profile){
            helper.textContent = "أدخل بياناتك بعد تسجيل الدخول للبدء.";
            helper.classList.remove("warn");
            return;
          }
          var amount = Number(state.refs.amount && state.refs.amount.value);
          if (!Number.isFinite(amount) || amount <= 0){
            helper.textContent = "أدخل قيمة التحويل المطلوبة.";
            helper.classList.remove("warn");
            return;
          }
          var remaining = (state.profile.balance || 0) - amount;
          if (remaining < -0.0001){
            helper.textContent = "القيمة المطلوبة تتجاوز رصيدك الحالي.";
            helper.classList.add("warn");
          } else {
            helper.textContent = "الرصيد بعد التحويل: " + formatBalance(Math.max(remaining, 0));
            helper.classList.remove("warn");
          }
        }

        function showStatus(type, message){
          var box = state.refs && state.refs.status;
          if (!box) return;
          if (!message){
            box.className = "transfer-status";
            box.textContent = "";
            return;
          }
          box.className = "transfer-status show " + (type || "info");
          box.textContent = message;
        }

        function setLoading(loading, hint){
          state.loading = !!loading;
          setFormDisabled(!state.profile || state.loading);
          if (loading && hint) showStatus("info", hint);
        }

        function submitTransfer(target, amount){
          return new Promise(function(resolve, reject){
            var user = state.currentUser;
            if (!user) { reject(createError("auth_required","سجّل الدخول أولاً.")); return; }
            var sessionKey = readSessionKey();
            if (!sessionKey) { reject(createError("session_missing","يرجى إعادة تسجيل الدخول لتجديد الجلسة.")); return; }
            Promise.all([user.getIdToken(true)]).then(function(results){
              var token = results[0];
              var guardToken = generateGuardToken("transfer");
              var payload = {
                action: "transfer",
                targetWebuid: target,
                amount: Number(amount),
                guardToken: guardToken,
                turnstileToken: guardToken,
                currentUrl: window.location.href
              };
              return fetch(buildApiUrl(), {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Authorization": "Bearer " + token,
                  "X-SessionKey": sessionKey,
                  "X-Guard-Token": guardToken
                },
                body: JSON.stringify(payload)
              });
            }).then(async function(res){
              var data = await res.json().catch(function(){ return {}; });
              if (!res.ok || data.success === false || data.ok === false){
                var msg = (data && data.error) ? data.error : "فشل تنفيذ التحويل.";
                reject(createError(data && data.code, msg));
                return;
              }
              resolve({
                amount: Number(data.amount || amount),
                senderBalance: Number(data.senderBalance),
                receiverWebuid: data.receiverWebuid || target
              });
            }).catch(function(err){
              reject(createError(err && err.code, err && err.message ? err.message : "تعذر تنفيذ التحويل."));
            });
          });
        }

        function updateCachedBalance(value){
          var val = Number(value);
          if (!Number.isFinite(val)) return;
          try { window.__BAL_BASE__ = val; window.__BALANCE__ = val; } catch(_){}
          try {
            var formatted = (typeof window.formatCurrencyFromJOD === "function")
              ? window.formatCurrencyFromJOD(val)
              : (val.toFixed(2) + " $");
            var textEl = document.getElementById("headerBalanceText");
            var currencyEl = document.getElementById("headerBalanceCurrency");
            if (textEl){
              var parts = formatted.split(/\s+/);
              textEl.textContent = parts.shift() || formatted;
              if (currencyEl) currencyEl.textContent = parts.join(" ") || "—";
            }
            window.dispatchEvent(new CustomEvent("balance:change", { detail: { value: val, formatted: formatted } }));
          } catch(_){}
          var uid = state.currentUser && state.currentUser.uid;
          if (uid){
            try { localStorage.setItem("balance:cache:"+uid, String(val)); } catch(_){}
          }
        }

        async function handleSubmit(e){
          if (e && typeof e.preventDefault === "function") e.preventDefault();
          if (!state.refs || state.loading) return;
          var target = normalizeWebuid(state.refs.target && state.refs.target.value);
          var amount = Number(state.refs.amount && state.refs.amount.value);
          if (!target){
            showStatus("error","أدخل webuid المستلم.");
            updateRecipientPreview("error", { message: "أدخل webuid المستلم." });
            return;
          }
          if (!Number.isFinite(amount) || amount <= 0){
            showStatus("error","أدخل قيمة صالحة للتحويل.");
            return;
          }
          if (state.profile && amount - (state.profile.balance || 0) > 0.0001){
            showStatus("error","القيمة تتجاوز رصيدك الحالي.");
            return;
          }
          showStatus("info","جارٍ تجهيز التحويل...");
          try{
            var recipientInfo = (state.recipientInfo && state.recipientInfo.webuid === target) ? state.recipientInfo : null;
            var receiverLabel = recipientInfo && recipientInfo.username
              ? recipientInfo.username + " (" + (recipientInfo.webuid || target) + ")"
              : target;
            var approved = await showConfirmModal({
              receiver: (recipientInfo && recipientInfo.username) ? recipientInfo.username : "مستخدم",
              webuid: (recipientInfo && recipientInfo.webuid) ? recipientInfo.webuid : target,
              amount: amount
            });
            if (!approved){
              showStatus("info","تم إلغاء الطلب قبل الإرسال.");
              return;
            }
            setLoading(true, "جاري تنفيذ التحويل...");
            var result = await submitTransfer(target, amount);
            if (state.refs && state.refs.form) state.refs.form.reset();
            if (state.profile && Number.isFinite(result.senderBalance)){
              state.profile.balance = result.senderBalance;
              updateProfileUI();
              updateCachedBalance(result.senderBalance);
            } else if (state.profile){
              state.profile.balance = Math.max(0, (state.profile.balance || 0) - amount);
              updateProfileUI();
            }
            var receiverDisplay = "";
            if (result && result.receiverName){
              receiverDisplay = result.receiverName + " (" + (result.receiverWebuid || target) + ")";
            } else if (recipientInfo && recipientInfo.username){
              receiverDisplay = recipientInfo.username + " (" + (result.receiverWebuid || target) + ")";
            } else {
              receiverDisplay = (result.receiverWebuid || target);
            }
            state.recipientInfo = null;
            updateRecipientPreview("idle");
            updateHelperText();
            showStatus("success","تم تحويل " + formatBalance(result.amount || amount) + " إلى " + receiverDisplay + " .");
          } catch(err){
            showStatus("error", err && err.message ? err.message : "تعذر تنفيذ التحويل.");
          } finally {
            setLoading(false);
          }
        }

        function build(){
          var frag = document.createDocumentFragment();
          frag.appendChild(ensureRoot());
          bindAuth();
          return frag;
        }

        function onShow(){
          ensureRoot();
          bindAuth();
          if (state.currentUser && !state.profile){
            loadProfile(state.currentUser);
          }
        }

        return {
          build: build,
          onShow: onShow,
          ready: function(){ return true; }
        };
      })();

      var reviewsRoute = (function(){
        var state = {
          root: null,
          initialized: false
        };

        function ensureRoot(){
          if (state.root) return state.root;
          var root = document.createElement('div');
          root.className = 'reviews-page';
          root.innerHTML = [
            '<div class="reviews-spacer" aria-hidden="true"></div>',
            '<main>',
            '  <section class="review-form" aria-label="نموذج إضافة تقييم وتعليق">',
            '    <div class="user-name" id="currentUserName"></div>',
            '    <div class="stars" id="starRating" role="radiogroup" aria-label="اختر عدد النجوم من 1 إلى 5">',
            '      <i class="fa-regular fa-star" data-value="1" role="radio" aria-checked="false" tabindex="0" aria-label="1 نجمة"></i>',
            '      <i class="fa-regular fa-star" data-value="2" role="radio" aria-checked="false" tabindex="-1" aria-label="2 نجوم"></i>',
            '      <i class="fa-regular fa-star" data-value="3" role="radio" aria-checked="false" tabindex="-1" aria-label="3 نجوم"></i>',
            '      <i class="fa-regular fa-star" data-value="4" role="radio" aria-checked="false" tabindex="-1" aria-label="4 نجوم"></i>',
            '      <i class="fa-regular fa-star" data-value="5" role="radio" aria-checked="false" tabindex="-1" aria-label="5 نجوم"></i>',
            '    </div>',
            '    <textarea id="reviewText" placeholder="اكتب تعليقك هنا..." aria-label="نص التعليق"></textarea>',
            '    <div class="code-preview" id="codePreview"></div>',
            '    <button id="submitReview" disabled>إرسال التقييم</button>',
            '  </section>',
            '  <section class="rating-filters" id="ratingFilters">',
            '    <div class="rating-filter active" data-rating="0">الكل</div>',
            '    <div class="rating-filter" data-rating="5">',
            '      <div class="stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i></div>',
            '      <span class="count" id="count-5">0</span>',
            '    </div>',
            '    <div class="rating-filter" data-rating="4">',
            '      <div class="stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-regular fa-star"></i></div>',
            '      <span class="count" id="count-4">0</span>',
            '    </div>',
            '    <div class="rating-filter" data-rating="3">',
            '      <div class="stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i></div>',
            '      <span class="count" id="count-3">0</span>',
            '    </div>',
            '    <div class="rating-filter" data-rating="2">',
            '      <div class="stars"><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i></div>',
            '      <span class="count" id="count-2">0</span>',
            '    </div>',
            '    <div class="rating-filter" data-rating="1">',
            '      <div class="stars"><i class="fa-solid fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i></div>',
            '      <span class="count" id="count-1">0</span>',
            '    </div>',
            '  </section>',
            '  <section class="reviews-list" id="reviewsList" aria-live="polite" aria-relevant="additions"></section>',
            '</main>'
          ].join('');
          state.root = root;
          return root;
        }

        function build(){
          var frag = document.createDocumentFragment();
          frag.appendChild(ensureRoot());
          return frag;
        }

        function init(){
          if (state.initialized) return;
          if (!document.getElementById('reviewsList')) return;
          if (typeof window.__initReviewsPage === 'function'){
            window.__initReviewsPage();
            state.initialized = true;
          }
        }

        function onShow(){
          init();
          if (typeof window.__REVIEWS_REFRESH__ === 'function'){
            try { window.__REVIEWS_REFRESH__(); } catch(_){}
          }
        }

        return {
          build: build,
          onShow: onShow,
          ready: function(){ return typeof window.__initReviewsPage === 'function'; }
        };
      })();

      var walletRoute = (function(){
        var state = {
          root: null,
          initialized: false
        };

        function ensureRoot(){
          if (state.root) return state.root;
          var root = document.createElement('div');
          root.className = 'wallet-page';
          root.innerHTML = [
            '<div class="wallet-spacer" aria-hidden="true"></div>',
            '<main>',
            '  <h2><span><i class="fas fa-wallet"></i> محفظتي</span></h2>',
            '  <div class="toolbar" id="walletToolbar">',
            '    <button class="chip" data-filter="all">الكل</button>',
            '    <button class="chip" data-filter="pending">قيد المراجعة</button>',
            '    <button class="chip" data-filter="approved">مقبولة</button>',
            '    <button class="chip" data-filter="rejected">مرفوضة</button>',
            '  </div>',
            '  <div id="walletList" class="list"></div>',
            '</main>'
          ].join('');
          state.root = root;
          return root;
        }

        function build(){
          var frag = document.createDocumentFragment();
          frag.appendChild(ensureRoot());
          return frag;
        }

        function init(){
          if (state.initialized) return false;
          if (!document.getElementById('walletList')) return false;
          if (typeof window.__initWalletPage === 'function'){
            window.__initWalletPage();
            state.initialized = true;
            return true;
          }
          return false;
        }

        function onShow(ctx){
          var context = ctx || {};
          var firstInit = init();
          if (typeof window.__WALLET_REFRESH__ === 'function'){
            var opts = { skipSkeleton: !!firstInit };
            if (context.forced) opts.force = true;
            try { window.__WALLET_REFRESH__(opts); } catch(_){}
          }
        }

        return {
          build: build,
          onShow: onShow,
          ready: function(){ return typeof window.__initWalletPage === 'function'; }
        };
      })();

      var manualGamesInline = (function(){
        var DISABLED = false;
        var cache = null;
        var lastFetched = 0;
        var inflight = null;
        var DEFAULT_BASE = "https://js4acc.laithqarqaz1.workers.dev/";
        var FETCH_TTL = 2 * 60 * 1000;

        function getBase(){
          try{
            var stored = localStorage.getItem("MANWAL_ROUTER_BASE");
            if (stored) return stored;
          }catch(_){}
          return DEFAULT_BASE;
        }

        function normalizeCategory(value){
          return (value || "")
            .toString()
            .trim()
            .toLowerCase();
        }

        function matchesTarget(gameCategory, targets){
          var normalized = normalizeCategory(gameCategory);
          if (!normalized || normalized === "manual") normalized = "games";
          if (!targets || !targets.length) return normalized === "games";
          return targets.some(function(target){
            if (target === "*") return true;
            if (target === "games") return normalized === "games";
            return normalized === target;
          });
        }

        function fetchList(force){
          if (DISABLED) return Promise.resolve([]);
          var now = Date.now();
          if (!force && cache && (now - lastFetched) < FETCH_TTL) return Promise.resolve(cache);
          if (inflight) return inflight;
          var url;
          try {
            url = new URL(getBase());
          } catch {
            url = new URL(DEFAULT_BASE);
          }
          url.searchParams.set("mode", "games");
          inflight = fetch(url.toString(), {
            headers: { "X-Game": "other" },
            cache: "no-store"
          }).then(async function(res){
            if (!res.ok) throw new Error("manual_games_fetch_failed");
            var data = await res.json().catch(function(){ return {}; });
            var games = Array.isArray(data.games) ? data.games : [];
            cache = games;
            lastFetched = Date.now();
            return games;
          }).catch(function(err){
            console.error("Manual games fetch error:", err);
            return [];
          }).finally(function(){ inflight = null; });
          return inflight;
        }

        function ensureMessage(section){
          if (!section) return null;
          var msg = section.querySelector(".manual-games-empty");
          if (!msg){
            msg = document.createElement("p");
            msg.className = "manual-games-empty";
            msg.style.display = "none";
            msg.dir = "rtl";
            section.appendChild(msg);
          }
          return msg;
        }

        function fallbackImage(){
          return "IMGS/freefiremanual.jpg";
        }

        function createCard(game){
          var card = document.createElement("a");
          card.className = "card manual-card";
          card.setAttribute("data-manual-card", "1");
          card.setAttribute("data-title", game.name || game.slug || "لعبة يدوية");
          card.setAttribute("href", "manual-game.html?slug=" + encodeURIComponent(game.slug));
          card.dataset.stateKey = game.slug;
          if (game.category) {
            card.dataset.category = normalizeCategory(game.category);
          }

          var img = document.createElement("img");
          img.setAttribute("draggable", "false");
          img.setAttribute("alt", game.name || "Manual game");
          img.setAttribute("loading", "lazy");
          img.src = (game.imageUrl && game.imageUrl.trim()) ? game.imageUrl : fallbackImage();

          var title = document.createElement("h2");
          title.textContent = game.name || game.slug || "لعبة";

          card.appendChild(img);
          card.appendChild(title);
          return card;
        }

        function removeOldCards(section){
          if (!section) return;
          section.querySelectorAll('.card[data-manual-card="1"]').forEach(function(node){ node.remove(); });
        }

        function render(section, options){
          options = options || {};
          if (!section) return;
          var attr = (section.dataset && section.dataset.manualTarget) || "";
          var targets = attr.split(",").map(function(x){ return normalizeCategory(x); }).filter(Boolean);
          if (options.target) {
            var optTargets = Array.isArray(options.target) ? options.target : [options.target];
            targets = optTargets.map(function(x){ return normalizeCategory(x); }).filter(Boolean);
          }
          if (!targets.length) targets = ["games"];
          var anchor = section.querySelector("[data-manual-anchor]");
          var message = ensureMessage(section);
          if (message) message.style.display = "none";
          if (!anchor) {
            anchor = document.createElement("span");
            anchor.setAttribute("data-manual-anchor", "1");
            anchor.style.display = "none";
            section.appendChild(anchor);
          }



          fetchList(options.force === true).then(function(games){
            removeOldCards(section);
            var filtered = games.filter(function(game){
              return matchesTarget(game.category, targets);
            });
            if (!filtered.length){
              if (message) message.style.display = "";
              try { applyCardsVisibility(); } catch(_){}
              return;
            }
            var frag = document.createDocumentFragment();
            filtered.forEach(function(game){
              if (!game || !game.slug) return;
              try {
                frag.appendChild(createCard(game));
              } catch(err){
                console.warn("manual card build failed:", err);
              }
            });
            var insertBeforeNode = null;
            if (message && message.parentNode === section) {
              insertBeforeNode = message;
            } else if (anchor && anchor.parentNode === section) {
              insertBeforeNode = anchor;
            }
            if (insertBeforeNode) section.insertBefore(frag, insertBeforeNode);
            else section.appendChild(frag);
            if (message) message.style.display = "none";
            try { applyCardsVisibility(); } catch(_){}
          });
        }

        return {
          render: render,
          refresh: function(section){ return render(section, { force: true }); }
        };
      })();

      var socialBoostInline = (function(){
        var DEFAULT_API_BASE = "https://js4acc.laithqarqaz1.workers.dev/";
        var CACHE_TTL = 60 * 1000;
        var cache = [];
        var lastFetched = 0;
        var inflight = null;
        var stylesInjected = false;
        var authReadyPromise = null;

        function buildApiBase(){
          var base = DEFAULT_API_BASE;
          try{
            var stored = localStorage.getItem("MANWAL_ROUTER_BASE");
            if (stored) base = stored;
          }catch(_){}
          try{
            var url = new URL(base);
            url.searchParams.set("game", "smm");
            return url.toString();
          }catch(_){}
          try{
            var fallback = new URL(DEFAULT_API_BASE);
            fallback.searchParams.set("game", "smm");
            return fallback.toString();
          }catch(_){}
          var sep = DEFAULT_API_BASE.indexOf("?") >= 0 ? "&" : "?";
          return DEFAULT_API_BASE + sep + "game=smm";
        }

        function themeIsDark(){
          try{
            var attr = document.documentElement.getAttribute('data-theme');
            if (attr) return attr !== 'light';
            var stored = localStorage.getItem('theme');
            if (stored) return stored !== 'light';
          }catch(_){}
          return true;
        }

        function ensureStyles(){
          if (stylesInjected) return;
          stylesInjected = true;
          try{
            var css = [
              '.smm-inline-form{display:flex;flex-direction:column;gap:18px;background:linear-gradient(180deg,#081131,#0d193f);border:1px solid rgba(112,136,255,.45);border-radius:22px;padding:20px;box-shadow:0 25px 45px rgba(5,7,20,.55);font-size:.95rem;}',
              '.smm-inline-form label{display:block;font-weight:800;margin-bottom:8px;color:#e5e9ff;}',
              'html[data-theme="dark"] .smm-inline-form label, body.dark-mode .smm-inline-form label{color:#f0f3ff;}',
              '.categories[data-smm-inline="1"]{display:block!important;grid-template-columns:none!important;width:100%;max-width:min(960px,100%);margin:0 auto;padding:0;}',
              '.categories[data-smm-inline="1"] .smm-inline-form{max-width:920px;margin:0 auto;}',
              '.smm-inline-group{display:flex;flex-direction:column;}',
              '.smm-inline-group-search{margin-bottom:-10px;}',
              '.smm-inline-group-search .smm-inline-hint{margin-top:4px;}',
              '.smm-inline-search{position:relative;}',
              '.smm-inline-field{width:100%;border:1.5px solid rgba(125,150,255,.55);border-radius:16px;padding:16px 22px;font-size:1.05rem;font-weight:700;color:#e8ecff;background:linear-gradient(180deg,#101a48,#0a1231);box-shadow:0 20px 40px rgba(4,6,18,.6);outline:none;transition:border-color .2s ease,box-shadow .2s ease;}',
              '.smm-inline-field::placeholder{color:#b7c5ff;font-weight:600;}',
              '.smm-inline-field:focus{border-color:#7d96ff;box-shadow:0 24px 44px rgba(61,96,255,.45);}',
              '.smm-inline-field[disabled]{opacity:.5;cursor:not-allowed;}',
              '.smm-inline-search-input{padding-right:60px!important;}',
              '.smm-inline-search i{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:#99b7ff;}',
              '.smm-inline-select{appearance:none;-moz-appearance:none;-webkit-appearance:none;text-align:right;direction:rtl;background-image:url(\"data:image/svg+xml,%3Csvg width%3D%2714%27 height%3D%279%27 viewBox%3D%270 0 14 9%27 fill%3D%27none%27 xmlns%3D%27http://www.w3.org/2000/svg%27%3E%3Cpath d%3D%27M2 2L7 7L12 2%27 stroke%3D%27%23BBD3FF%27 stroke-width%3D%271.8%27 stroke-linecap%3D%27round%27 stroke-linejoin%3D%27round%27/%3E%3C/svg%3E\");background-repeat:no-repeat;background-position:left 26px center;background-size:14px;color-scheme:light;padding-right:22px;padding-left:60px;}',
              '.smm-inline-select:focus{border-color:#7d96ff;box-shadow:0 24px 44px rgba(61,96,255,.45);}',
              '.smm-inline-select option, .smm-inline-select optgroup{background:#0e1741;color:#f3f6ff;}',
              '.smm-select{position:relative;width:100%;font-weight:700;color:#f3f6ff;}',
              '.smm-select-trigger{width:100%;display:flex;align-items:center;justify-content:space-between;gap:12px;border:1.5px solid rgba(125,150,255,.65);border-radius:16px;padding:15px 20px;background:linear-gradient(180deg,#0d1435,#080f25);color:inherit;box-shadow:0 20px 40px rgba(4,6,18,.65);cursor:pointer;transition:border-color .2s ease,box-shadow .2s ease,transform .12s ease;}',
              '.smm-select-trigger:focus-visible{outline:2px solid rgba(125,150,255,.65);outline-offset:2px;}',
              '.smm-select.open .smm-select-trigger{border-color:#66aee9;box-shadow:0 22px 48px rgba(7,14,46,.75);}',
              '.smm-select.is-disabled .smm-select-trigger{opacity:.45;cursor:not-allowed;box-shadow:none;}',
              '.smm-select-value{flex:1;display:flex;align-items:center;gap:12px;white-space:normal;overflow:visible;text-overflow:clip;font-size:1.05rem;flex-wrap:wrap;word-break:break-word;}',
              '.smm-option-pill,.smm-value-pill{flex:0 0 auto;min-width:48px;padding:3px 10px;border-radius:12px;background:linear-gradient(135deg,rgba(91,143,194,.35),rgba(64,96,170,.45));color:#fff;font-size:.75rem;font-weight:800;letter-spacing:.02em;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(5,6,20,.55);border:1px solid rgba(255,255,255,.15);}',
              '.smm-option-pill{margin-inline-end:10px;}',
              '.smm-value-pill{margin-inline-end:8px;}',
              '.smm-option-label,.smm-value-text{flex:1;min-width:0;text-align:right;font-weight:700;white-space:normal;overflow:visible;text-overflow:clip;font-size:0.98rem;word-break:break-word;}',
              '.smm-select-value.is-placeholder{color:#7fb7ff;font-weight:600;}',
              '.smm-select-caret{color:#7fb7ff;font-size:.9rem;display:inline-flex;}',
              '.smm-select-dropdown{position:absolute;top:calc(100% + 6px);inset-inline:0;background:linear-gradient(180deg,#070b22,#0f1533);border:1px solid rgba(125,150,255,.4);border-radius:18px;box-shadow:0 28px 55px rgba(4,6,20,.75);max-height:280px;overflow:auto;opacity:0;transform:translateY(-6px);pointer-events:none;transition:opacity .15s ease,transform .15s ease;z-index:20;padding:8px 0;}',
              '.smm-select.open .smm-select-dropdown{opacity:1;transform:translateY(0);pointer-events:auto;}',
              '.smm-option{width:100%;border:0;background:transparent;color:#f3f6ff;text-align:right;padding:10px 18px;font-weight:700;display:flex;align-items:center;justify-content:space-between;gap:12px;cursor:pointer;transition:background .15s ease;border-bottom:1px solid rgba(125,150,255,.2);}',
              '.smm-option:last-of-type{border-bottom:none;}',
              '.smm-option:not(.is-disabled):hover{background:rgba(91,143,194,.22);}',              
              '.smm-option.is-selected{background:linear-gradient(135deg,rgba(91,143,194,.35),rgba(92,94,191,.35));color:#fff;}',              
              '.smm-option.is-disabled{opacity:.35;cursor:not-allowed;}',              
              '.smm-select-dropdown::-webkit-scrollbar{width:6px;}',
              '.smm-select-dropdown::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:999px;}',
              '.smm-select-dropdown::-webkit-scrollbar-thumb{background:rgba(91,143,194,.65);border-radius:999px;}',
              '.smm-select-native{position:absolute;inset:auto;opacity:0;pointer-events:none;width:0;height:0;}',
              '.smm-inline-label-row{display:flex;align-items:center;justify-content:space-between;gap:14px;}',
              '.smm-inline-label-row label{margin-bottom:0;flex:1;font-size:0.95em;}',
              '.smm-service-pill{min-width:66px;text-align:center;font-weight:800;font-size:.95rem;color:#1c2f8d;background:linear-gradient(180deg,#f4f6ff,#dfe5ff);border:1px solid rgba(76,124,255,.45);border-radius:999px;padding:7px 20px;box-shadow:0 14px 32px rgba(62,92,255,.32);transition:opacity .2s ease;}',
              '.smm-service-pill.is-empty{opacity:.45;}',
              '.smm-inline-form select:disabled{opacity:.5;cursor:not-allowed;}',
              '.smm-inline-description-body{width:100%;border:1px solid rgba(125,150,255,.55);border-radius:16px;padding:16px 22px;font-size:1.02rem;font-weight:600;color:#f5f7ff;background:linear-gradient(180deg,#101a48,#0a1231);line-height:1.7;min-height:96px;box-shadow:0 20px 40px rgba(4,6,18,.6);white-space:pre-line;word-break:break-word;transition:border-color .2s ease,box-shadow .2s ease;}',
              '.smm-inline-description-body.empty{color:#7fb7ff;}',
              '.smm-inline-hint{font-size:.88rem;color:#c0cbff;margin-top:6px;}',
              '.smm-inline-hint.error{color:#f87171;font-weight:700;}',
              '.smm-inline-hint.success{color:#34d399;font-weight:700;}',
              '.smm-inline-total{font-size:inherit;font-weight:inherit;line-height:inherit;text-align:center;font-variant-numeric:tabular-nums;}',
              '.smm-inline-row{display:flex;flex-wrap:wrap;gap:16px;}',
              '.smm-inline-row .smm-inline-group{flex:1;min-width:240px;}',
              '.smm-inline-submit{border:0;border-radius:18px;padding:14px 18px;font-weight:800;font-size:1.05rem;background:linear-gradient(135deg,#4c6ef5,#1d4ed8);color:#fff;cursor:pointer;transition:transform .2s ease,box-shadow .2s ease;}',
              '.smm-inline-submit:hover{transform:translateY(-1px);box-shadow:0 15px 35px rgba(37,99,235,.25);}',
              '.smm-inline-message{text-align:center;margin:18px 0 0;font-weight:600;}',
              'html[data-theme="light"] .smm-inline-form label, body.light-mode .smm-inline-form label{color:#1b1d3b;}',
              'html[data-theme="light"] .smm-inline-form, body.light-mode .smm-inline-form{background:linear-gradient(180deg,#ffffff,#f5f6ff);border:1px solid rgba(58,108,186,.18);box-shadow:0 24px 50px rgba(12,16,48,.08);}',
              'html[data-theme="light"] .smm-inline-field, body.light-mode .smm-inline-field{background:linear-gradient(180deg,#ffffff,#f4f5ff);color:#111540;border:1.5px solid rgba(58,108,186,.3);box-shadow:0 18px 36px rgba(27,32,72,.08);color-scheme:light;}',
              'html[data-theme="light"] .smm-inline-field::placeholder, body.light-mode .smm-inline-field::placeholder{color:#7a82a8;}',
              'html[data-theme="light"] .smm-inline-select option, html[data-theme="light"] .smm-inline-select optgroup, body.light-mode .smm-inline-select option, body.light-mode .smm-inline-select optgroup{background:#f4f6fb;color:#111540;}',
              'html[data-theme="light"] .smm-select{color:#111540;}',
              'html[data-theme="light"] .smm-select-trigger{background:linear-gradient(180deg,#ffffff,#f5f7ff);color:#111540;border-color:rgba(58,108,186,.35);box-shadow:0 16px 34px rgba(18,22,60,.12);}',
              'html[data-theme="light"] .smm-select.open .smm-select-trigger{border-color:#4c6ef5;box-shadow:0 20px 40px rgba(18,22,60,.18);}',
              'html[data-theme="light"] .smm-select-value.is-placeholder{color:#4f6fa8;}',
              'html[data-theme="light"] .smm-select-dropdown{background:linear-gradient(180deg,#ffffff,#f4f5ff);border-color:rgba(58,108,186,.25);box-shadow:0 24px 48px rgba(18,22,60,.15);}',
              'html[data-theme="light"] .smm-option{color:#1b1d3b;border-bottom:1px solid rgba(58,108,186,.18);}',
              'html[data-theme="light"] .smm-option:last-of-type{border-bottom:none;}',
              'html[data-theme="light"] .smm-option-pill, html[data-theme="light"] .smm-value-pill{background:linear-gradient(135deg,rgba(76,110,245,.22),rgba(91,143,194,.28));color:#1b1d3b;box-shadow:0 6px 16px rgba(18,22,60,.18);border-color:rgba(58,108,186,.3);}',
              'html[data-theme="light"] .smm-option.is-selected{background:linear-gradient(135deg,rgba(76,110,245,.14),rgba(91,143,194,.18));color:#1b1d3b;}',
              'html[data-theme="light"] .smm-inline-description-body, body.light-mode .smm-inline-description-body{background:linear-gradient(180deg,#ffffff,#f5f6ff);color:#111540;border:1px solid rgba(58,108,186,.2);box-shadow:0 18px 36px rgba(27,32,72,.08);}',
              'html[data-theme="light"] .smm-inline-description-body.empty, body.light-mode .smm-inline-description-body.empty{color:#6c7398;}',
              'html[data-theme="light"] .smm-inline-hint, body.light-mode .smm-inline-hint{color:#7a82a8;}',
              'html[data-theme="light"] .smm-inline-hint.success, body.light-mode .smm-inline-hint.success{color:#059669;}',
              'html[data-theme="light"] .smm-inline-total, body.light-mode .smm-inline-total{color:#111540;}',
              'html[data-theme="light"] .smm-inline-search i, body.light-mode .smm-inline-search i{color:#7c83a8;}',
              'html[data-theme=\"dark\"] .smm-inline-form{background:linear-gradient(180deg,#050b1e,#0a132f);border-color:rgba(118,139,255,.45);}',
              'html[data-theme=\"dark\"] .smm-inline-field, body.dark-mode .smm-inline-field{background:linear-gradient(180deg,#050b1e,#080f29);color:#e8ecff;border-color:rgba(125,150,255,.65);box-shadow:0 20px 36px rgba(0,0,0,.55);color-scheme:dark;}',
              'html[data-theme=\"dark\"] .smm-inline-select, body.dark-mode .smm-inline-select{background:linear-gradient(180deg,#050b1e,#080f29);color:#e8ecff;border-color:rgba(125,150,255,.65);box-shadow:0 20px 36px rgba(0,0,0,.55);color-scheme:dark;}',
              'html[data-theme=\"dark\"] .smm-inline-select option, body.dark-mode .smm-inline-select option, html[data-theme=\"dark\"] .smm-inline-select optgroup, body.dark-mode .smm-inline-select optgroup{background:#050b1e;color:#e8ecff;}',
              'html[data-theme=\"dark\"] .smm-service-pill{background:rgba(27,52,137,.8);color:#e2e8ff;border-color:rgba(76,124,255,.45);box-shadow:0 15px 32px rgba(20,30,82,.5);}',
              'html[data-theme=\"dark\"] .smm-inline-description-body, body.dark-mode .smm-inline-description-body{background:linear-gradient(180deg,#050b1e,#080f29);color:#f5f7ff;border-color:rgba(125,150,255,.65);box-shadow:0 20px 36px rgba(0,0,0,.55);}',
              'html[data-theme=\"dark\"] .smm-inline-description-body.empty, body.dark-mode .smm-inline-description-body.empty{color:#9eadf3;}',
              'html[data-theme=\"dark\"] .smm-inline-total{color:#f5f7ff;}',
            ].join('');
            var style = document.createElement('style');
            style.textContent = css;
            document.head.appendChild(style);
          }catch(_){}
        }

        function createError(code, message){
          var err = new Error(message || code || "error");
          err.code = code || "unknown_error";
          return err;
        }

        function ensureFirebaseAuth(){
          if (typeof firebase === 'undefined') return null;
          try{
            if ((!firebase.apps || !firebase.apps.length) && window.__FIREBASE_CONFIG__){
              firebase.initializeApp(window.__FIREBASE_CONFIG__);
            }
          }catch(_){}
          try { return firebase.auth(); } catch(_){ return null; }
        }

        function getLocalSessionKey(){
          try{
            var parsed = JSON.parse(localStorage.getItem("sessionKeyInfo") || "null");
            return parsed && parsed.sessionKey ? parsed.sessionKey : "";
          }catch(_){
            return "";
          }
        }

        function waitForUser(){
          var auth = ensureFirebaseAuth();
          if (!auth) return Promise.resolve(null);
          var current = auth.currentUser;
          if (current) return Promise.resolve(current);
          if (authReadyPromise) return authReadyPromise;
          authReadyPromise = new Promise(function(resolve){
            var unsubscribe = null;
            try{
              unsubscribe = auth.onAuthStateChanged(function(user){
                try{ if (unsubscribe) unsubscribe(); }catch(_){}
                authReadyPromise = null;
                resolve(user || null);
              }, function(){
                try{ if (unsubscribe) unsubscribe(); }catch(_){}
                authReadyPromise = null;
                resolve(null);
              });
            }catch(_){
              authReadyPromise = null;
              resolve(null);
            }
          });
          return authReadyPromise;
        }

        function fetchServices(force){
          var now = Date.now();
          if (!force && cache && cache.length && (now - lastFetched) < CACHE_TTL) return Promise.resolve(cache);
          if (inflight) return inflight;

          inflight = Promise.resolve().then(function(){
            var url = new URL(buildApiBase());
            url.searchParams.set("mode", "services");
            return waitForUser().then(function(user){
              if (!user) return { headers: {} };
              var sessionKey = getLocalSessionKey();
              var headers = {};
              if (sessionKey) headers["X-SessionKey"] = sessionKey;
              return user.getIdToken(true).then(function(token){
                headers["Authorization"] = "Bearer " + token;
                return { headers: headers };
              }).catch(function(){ return { headers: headers }; });
            }).catch(function(){ return { headers: {} }; }).then(function(auth){
              var opts = { method: "GET", cache: "no-store" };
              if (auth && auth.headers && Object.keys(auth.headers).length){
                opts.headers = auth.headers;
              }
              return fetch(url.toString(), opts);
            });
          }).then(async function(res){
            var data = await res.json().catch(function(){ return {}; });
            if (!res.ok || data.success === false){
              throw createError(data.code || "fetch_failed", data.error || "تعذر تحميل قائمة الخدمات");
            }
            var list = Array.isArray(data.services) ? data.services : [];
            cache = list;
            lastFetched = Date.now();
            return list;
          }).catch(function(err){
            if (!(err instanceof Error)) err = createError("fetch_failed", "تعذر تحميل القائمة");
            throw err;
          }).finally(function(){ inflight = null; });
          return inflight;
        }

        function ensureMessage(section){
          if (!section) return null;
          var msg = section.__smmMessage;
          if (msg && msg.parentNode) return msg;
          msg = document.createElement('p');
          msg.className = 'smm-inline-message';
          msg.setAttribute('data-smm-message', '1');
          msg.dir = 'rtl';
          msg.style.display = 'none';
          if (section.parentNode) section.parentNode.insertBefore(msg, section.nextSibling);
          else section.appendChild(msg);
          section.__smmMessage = msg;
          return msg;
        }

        function setMessage(section, text, tone){
          var node = ensureMessage(section);
          if (!node) return;
          if (!text){
            node.style.display = 'none';
            return;
          }
          node.textContent = text;
          node.style.display = '';
          if (tone === 'error') node.style.color = '#f87171';
          else if (tone === 'warning') node.style.color = '#fbbf24';
          else if (tone === 'success') node.style.color = '#34d399';
          else node.style.color = '#94a3b8';
        }

        function showInlineResultOverlay(options){
          options = options || {};
          var success = options.success !== false;
          var manual = options.manualForward === true;
          var orderCode = options.orderCode || options.orderId || '';
          var message = options.message || (success
            ? (manual ? 'تم تحويل الطلب للتنفيذ اليدوي' : 'تم تسجيل الطلب بنجاح')
            : 'تعذر تنفيذ الطلب');
          var details = options.details;
          var existing = document.getElementById('smm-inline-result');
          if (existing && existing.parentNode) existing.parentNode.removeChild(existing);

          var overlay = document.createElement('div');
          overlay.id = 'smm-inline-result';
          overlay.className = 'smm-inline-result-overlay';
          overlay.setAttribute('role', 'dialog');
          overlay.setAttribute('aria-modal', 'true');
          overlay.dir = 'rtl';
          overlay.style.cssText = 'position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;padding:18px;background:rgba(5,7,20,.65);backdrop-filter:blur(5px);';

          var card = document.createElement('div');
          card.className = 'smm-inline-result-card';
          card.style.cssText = 'width:min(520px,95vw);border-radius:24px;padding:34px 28px;text-align:center;position:relative;box-shadow:0 30px 90px rgba(5,5,20,.45);';
          var dark = themeIsDark();
          overlay.style.background = dark ? 'rgba(5,7,20,.75)' : 'rgba(9,12,32,.55)';
          card.style.background = dark ? '#0b1225' : '#ffffff';
          card.style.color = dark ? '#e2e8f0' : '#111827';

          var accent = success ? '#22c55e' : '#ef4444';
          var accentBg = success ? 'rgba(34,197,94,.16)' : 'rgba(239,68,68,.16)';

          var closeBtn = document.createElement('button');
          closeBtn.type = 'button';
          closeBtn.textContent = '×';
          closeBtn.setAttribute('aria-label', 'إغلاق');
          closeBtn.style.cssText = 'position:absolute;top:14px;inset-inline-start:18px;width:38px;height:38px;border-radius:50%;border:0;font-size:22px;font-weight:700;cursor:pointer;';
          closeBtn.style.background = dark ? 'rgba(255,255,255,.08)' : 'rgba(15,23,42,.08)';
          closeBtn.style.color = dark ? '#f8fafc' : '#0f172a';

          var icon = document.createElement('div');
          icon.textContent = success ? '✅' : '⚠️';
          icon.style.cssText = 'width:96px;height:96px;border-radius:50%;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;font-size:44px;font-weight:700;';
          icon.style.background = accentBg;
          icon.style.color = accent;
          icon.style.border = '2px solid ' + accent;

          var title = document.createElement('h3');
          title.textContent = success
            ? (manual ? 'الطلب قيد المراجعة اليدوية' : 'تم تسجيل الطلب بنجاح')
            : 'تعذر تنفيذ الطلب';
          title.style.cssText = 'font-size:26px;margin:6px 0 10px;font-weight:800;';

          var msg = document.createElement('p');
          msg.textContent = message;
          msg.style.cssText = 'margin:0 0 10px;line-height:1.7;';
          msg.style.color = dark ? '#c7e2ff' : '#4a4f68';

          var detail = null;
          var detailText = details;
          if (!detailText){
            detailText = success
              ? 'يمكنك متابعة حالة الطلب من صفحة الطلبات.'
              : 'تحقق من البيانات وحاول مرة أخرى. إذا استمرت المشكلة يرجى التواصل مع الدعم.';
          }
          detail = document.createElement('p');
          detail.textContent = detailText;
          detail.style.cssText = 'margin:0 0 12px;font-size:15px;line-height:1.6;';
          detail.style.color = dark ? '#9fb4ff' : '#64748b';

          var codeLine = null;
          if (orderCode){
            codeLine = document.createElement('p');
            codeLine.innerHTML = '🆔 كود الطلب: <strong>' + orderCode + '</strong>';
            codeLine.style.cssText = 'margin:12px 0 6px;font-weight:700;';
          }

          var actions = document.createElement('div');
          actions.style.cssText = 'display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:18px;';

          if (success){
            var ordersBtn = document.createElement('a');
            ordersBtn.href = 'talabat.html';
            ordersBtn.textContent = 'عرض طلباتي';
            ordersBtn.style.cssText = 'text-decoration:none;padding:12px 26px;border-radius:18px;font-weight:800;';
            ordersBtn.style.background = accent;
            ordersBtn.style.color = '#0f172a';
            actions.appendChild(ordersBtn);
          }

          var closeAction = document.createElement('button');
          closeAction.type = 'button';
          closeAction.textContent = success ? 'إغلاق' : 'محاولة مجدداً';
          closeAction.style.cssText = 'padding:12px 22px;border-radius:18px;font-weight:800;border:0;cursor:pointer;';
          closeAction.style.background = dark ? '#1e293b' : '#e2e8f0';
          closeAction.style.color = dark ? '#e2e8f0' : '#111827';
          actions.appendChild(closeAction);

          function cleanup(){
            document.removeEventListener('keydown', escHandler);
            if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
          }

          function escHandler(ev){
            if (ev && (ev.key === 'Escape' || ev.key === 'Esc')) cleanup();
          }

          closeBtn.addEventListener('click', cleanup);
          closeAction.addEventListener('click', cleanup);
          overlay.addEventListener('click', function(e){
            if (e.target === overlay) cleanup();
          });
          document.addEventListener('keydown', escHandler);

          var nodes = [closeBtn, icon, title, msg];
          if (codeLine) nodes.push(codeLine);
          nodes.push(detail, actions);
          card.append.apply(card, nodes);
          overlay.appendChild(card);
          document.body.appendChild(overlay);

          try {
            var audio = new Audio(success ? 'success.mp3' : 'error.mp3');
            audio.play().catch(function(){});
          } catch(_){}
        }

        function normalizeText(value){
          return (value == null ? '' : String(value))
            .toLowerCase()
            .replace(/[ًٌٍَُِّْـ]/g,'')
            .replace(/[إأآا]/g,'ا')
            .replace(/ى/g,'ي')
            .replace(/ة/g,'ه')
            .replace(/\s+/g,' ')
            .trim();
        }

        var uiState = {
          services: [],
          categories: [],
          selectedCategory: '',
          selectedServiceId: ''
        };

        var uiRefs = null;
        var qtyUserEdited = false;

        var urlRegex = /https?:\/\/[^\s<>\"']+/gi;

        var CATEGORY_ICON_RULES = [
          { icon: '🤖', keywords: ['gpt', 'شات gpt', 'بريميوم'] },
          { icon: '🎵', keywords: ['تيك توك', 'tiktok'] },
          { icon: '📘', keywords: ['فيسبوك', 'facebook'] },
          { icon: '📸', keywords: ['انستجرام', 'انستا', 'instagram'] },
          { icon: '▶️', keywords: ['يوتيوب', 'youtube'] },
          { icon: '✈️', keywords: ['تيليجرام', 'تيلجرام', 'تليجرام', 'telegram'] },
          { icon: '🟢', keywords: ['واتس', 'whatsapp'] },
          { icon: '👻', keywords: ['سناب', 'snap'] },
          { icon: '🐦', keywords: ['تويتر', 'twitter', 'ريتويت'] },
          { icon: '💼', keywords: ['لينكد', 'linkedin'] },
          { icon: '🎧', keywords: ['سبوتيفاي', 'spotify'] },
          { icon: '🎮', keywords: ['بلاستيشن', 'بلايستيشن', 'playstation', ' ps', 'ps5', 'psn', 'تويتش', 'twitch'] },
          { icon: '💳', keywords: ['visa', 'فيزا'] },
          { icon: '🏆', keywords: ['vip', 'نجوم', 'premium'] },
          { icon: '✅', keywords: ['توثيق', 'verified'] },
          { icon: '📰', keywords: ['جرايد', 'جريدة', 'google', 'جوجل'] },
          { icon: '🕹️', keywords: ['كيك', 'kick', 'بيغو', 'bigo'] },
          { icon: '🎯', keywords: ['رشق', 'خدمات'] },
          { icon: '🌐', keywords: ['قنوات', 'قناة', 'channel'] },
          { icon: '📈', keywords: ['ساعات', 'minutes', 'مشاهدات', 'views'] },
          { icon: '📱', keywords: ['kwai', 'كواى', 'كواي'] },
          { icon: '💬', keywords: ['تعليقات', 'comments'] },
          { icon: '💖', keywords: ['لايك', 'likes'] },
          { icon: '👥', keywords: ['متابعين', 'followers', 'اعضاء'] }
        ];

        function getCategoryIcon(label){
          var text = (label || '').toLowerCase();
          for (var i = 0; i < CATEGORY_ICON_RULES.length; i++){
            var rule = CATEGORY_ICON_RULES[i];
            for (var j = 0; j < rule.keywords.length; j++){
              if (text.indexOf(rule.keywords[j]) !== -1){
                return rule.icon;
              }
            }
          }
          return '🏷️';
        }

        function formatCategoryLabel(label){
          if (!label) return label || '';
          return getCategoryIcon(label) + ' ' + label;
        }

        var customSelectInstances = [];
        var customSelectOpen = null;

        function closeCustomSelect(instance){
          if (!instance) return;
          instance.wrapper.classList.remove('open');
          instance.trigger.setAttribute('aria-expanded', 'false');
          if (customSelectOpen === instance) customSelectOpen = null;
        }

        function openCustomSelect(instance){
          if (!instance || instance.select.disabled) return;
          if (customSelectOpen && customSelectOpen !== instance){
            closeCustomSelect(customSelectOpen);
          }
          instance.wrapper.classList.add('open');
          instance.trigger.setAttribute('aria-expanded', 'true');
          customSelectOpen = instance;
        }

        document.addEventListener('click', function(e){
          if (!customSelectOpen) return;
          if (!customSelectOpen.wrapper.contains(e.target)){
            closeCustomSelect(customSelectOpen);
          }
        }, true);

        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && customSelectOpen){
            closeCustomSelect(customSelectOpen);
          }
        });

        function createCustomSelect(select){
          if (!select || select.__customSelect) return select && select.__customSelect;
          var wrapper = document.createElement('div');
          wrapper.className = 'smm-select';
          var trigger = document.createElement('button');
          trigger.type = 'button';
          trigger.className = 'smm-select-trigger';
          trigger.setAttribute('aria-haspopup', 'listbox');
          trigger.setAttribute('aria-expanded', 'false');
          if (select.id) trigger.setAttribute('aria-labelledby', select.id);
          var valueNode = document.createElement('span');
          valueNode.className = 'smm-select-value is-placeholder';
          valueNode.textContent = '—';
          var caret = document.createElement('span');
          caret.className = 'smm-select-caret';
          caret.innerHTML = '<i class="fa-solid fa-chevron-down" aria-hidden="true"></i>';
          trigger.appendChild(valueNode);
          trigger.appendChild(caret);
          var dropdown = document.createElement('div');
          dropdown.className = 'smm-select-dropdown';
          dropdown.setAttribute('role', 'listbox');
          if (select.id) dropdown.id = select.id + '__dropdown';

          var parent = select.parentNode;
          if (parent){
            parent.insertBefore(wrapper, select);
          }
          wrapper.appendChild(trigger);
          wrapper.appendChild(dropdown);
          wrapper.appendChild(select);
          select.classList.add('smm-select-native');
          select.setAttribute('aria-hidden', 'true');
          select.tabIndex = -1;

          var instance = {
            select: select,
            wrapper: wrapper,
            trigger: trigger,
            dropdown: dropdown,
            valueNode: valueNode
          };
          select.__customSelect = instance;
          customSelectInstances.push(instance);

          trigger.addEventListener('click', function(ev){
            ev.preventDefault();
            if (instance.wrapper.classList.contains('open')) closeCustomSelect(instance);
            else openCustomSelect(instance);
          });

          select.addEventListener('change', function(){
            updateCustomSelectValue(select);
          });

          return instance;
        }

        function ensureCustomSelect(select){
          if (!select) return null;
          return select.__customSelect || createCustomSelect(select);
        }

        function setValueNodeContent(instance, label, pill, isPlaceholder){
          if (!instance || !instance.valueNode) return;
          var node = instance.valueNode;
          node.innerHTML = '';
          node.classList.toggle('is-placeholder', !!isPlaceholder);
          if (pill){
            var pillEl = document.createElement('span');
            pillEl.className = 'smm-value-pill';
            pillEl.textContent = pill;
            node.appendChild(pillEl);
          }
          var textEl = document.createElement('span');
          textEl.className = 'smm-value-text';
          textEl.textContent = label || '—';
          node.appendChild(textEl);
        }

        function updateCustomSelectValue(select){
          if (!select || !select.__customSelect) return;
          var instance = select.__customSelect;
          var selectedOption = select.options[select.selectedIndex] || null;
          var label = '';
          var badge = '';
          if (selectedOption){
            label = selectedOption.textContent || selectedOption.value || '';
            badge = (selectedOption.dataset && selectedOption.dataset.serviceId) || '';
          }
          if (!label){
            label = select.dataset.placeholder || '—';
          }
          var isPlaceholder = !selectedOption || selectedOption.disabled;
          setValueNodeContent(instance, label, isPlaceholder ? '' : badge, isPlaceholder);

          var currentValue = selectedOption ? selectedOption.value : '';
          Array.prototype.forEach.call(instance.dropdown.children, function(btn){
            if (!btn || !btn.dataset) return;
            var isSelected = btn.dataset.value === currentValue;
            btn.classList.toggle('is-selected', isSelected);
            btn.setAttribute('aria-selected', isSelected ? 'true' : 'false');
          });

          instance.wrapper.classList.toggle('is-disabled', !!select.disabled);
          instance.trigger.disabled = !!select.disabled;
          if (select.disabled && instance.wrapper.classList.contains('open')){
            closeCustomSelect(instance);
          }
        }

        function syncCustomSelect(select){
          var instance = ensureCustomSelect(select);
          if (!instance) return;
          instance.dropdown.innerHTML = '';
          Array.prototype.forEach.call(select.options || [], function(option){
            if (!option || String(option.tagName).toUpperCase() !== 'OPTION') return;
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'smm-option';
            btn.dataset.value = option.value;
            btn.setAttribute('role', 'option');
            var label = option.textContent || option.value || '—';
            var badge = (option.dataset && option.dataset.serviceId) || '';
            if (badge){
              var pill = document.createElement('span');
              pill.className = 'smm-option-pill';
              pill.textContent = badge;
              btn.appendChild(pill);
            }
            var textSpan = document.createElement('span');
            textSpan.className = 'smm-option-label';
            textSpan.textContent = label;
            btn.appendChild(textSpan);
            if (option.disabled){
              btn.classList.add('is-disabled');
              btn.setAttribute('aria-disabled', 'true');
            }
            btn.addEventListener('click', function(e){
              e.preventDefault();
              if (option.disabled || select.disabled) return;
              if (select.value !== option.value){
                select.value = option.value;
                select.dispatchEvent(new Event('change', { bubbles: true }));
              }
              closeCustomSelect(instance);
            });
            instance.dropdown.appendChild(btn);
          });
          updateCustomSelectValue(select);
        }

        function applyQtyWarning(message){
          if (!uiRefs || !uiRefs.qtyHint) return;
          var base = uiRefs.qtyHint.dataset.baseHint || uiRefs.qtyHint.textContent || '';
          if (message){
            uiRefs.qtyHint.textContent = message;
            uiRefs.qtyHint.classList.add('error');
          } else {
            uiRefs.qtyHint.textContent = base;
            uiRefs.qtyHint.classList.remove('error');
          }
        }

        function normalizeDigits(value){
          var map = { '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9' };
          return String(value == null ? '' : value).replace(/[٠-٩]/g, function(ch){ return map[ch] || ch; });
        }

        function setSearchStatus(message, type){
          if (!uiRefs || !uiRefs.searchStatus) return;
          var base = uiRefs.searchStatus.dataset.baseText;
          if (!base){
            base = uiRefs.searchStatus.textContent || '';
            uiRefs.searchStatus.dataset.baseText = base;
          }
          var text = message || base;
          uiRefs.searchStatus.textContent = text;
          uiRefs.searchStatus.classList.remove('error','success');
          if (type === 'error') uiRefs.searchStatus.classList.add('error');
          else if (type === 'success') uiRefs.searchStatus.classList.add('success');
        }

        function enforceQtyBounds(){
          if (!uiRefs || !uiRefs.qty) return;
          var service = getSelectedService();
          if (!service){
            applyQtyWarning('');
            return;
          }
          var raw = (uiRefs.qty.value || '').trim();
          if (!raw){
            applyQtyWarning('');
            return;
          }
          var qty = Number(raw);
          if (!Number.isFinite(qty)){
            applyQtyWarning('الكمية يجب أن تكون أرقامًا صحيحة فقط');
            return;
          }
          var min = Number(service.min) || 0;
          var max = Number(service.max) || 0;
          var message = '';
          if (min && qty < min){
            message = 'الحد الأدنى للكمية هو ' + min;
          } else if (max && max > 0 && qty > max){
            message = 'الحد الأقصى للكمية هو ' + max;
          }
          applyQtyWarning(message);
        }

        function normalizeDescriptionValue(value){
          if (value == null) return '';
          if (typeof value === 'string') return value.trim();
          if (typeof value === 'number' && isFinite(value)) return String(value);
          return '';
        }

        function extractDescription(service){
          if (!service || typeof service !== 'object') return '';
          var primaryKeys = [
            'description','desc','details','detail','info','note','notes','extra',
            'Description','Desc','Details','Detail','Info','Note','Notes','Extra',
            'description_ar','descriptionAr','Description_ar','DescriptionAr'
          ];
          for (var i = 0; i < primaryKeys.length; i++){
            var key = primaryKeys[i];
            if (Object.prototype.hasOwnProperty.call(service, key)){
              var val = normalizeDescriptionValue(service[key]);
              if (val) return val;
            }
          }
          var regex = /(desc|note|info|detail|شرح|وصف|تعليم)/i;
          for (var prop in service){
            if (!Object.prototype.hasOwnProperty.call(service, prop)) continue;
            if (!regex.test(prop)) continue;
            var text = normalizeDescriptionValue(service[prop]);
            if (text) return text;
          }
          return '';
        }

        function normalizeService(service){
          if (!service) return null;
          var id = service.id != null ? String(service.id) : '';
          if (!id) return null;
          var name = service.name || ('خدمة #' + id);
          var category = service.category || name;
          var description = extractDescription(service);
          return {
            id: id,
            name: name,
            category: category,
            categoryKey: normalizeText(category) || 'misc',
            description: description,
            normalizedName: normalizeText(name),
            normalizedDescription: normalizeText(description),
            min: service.min || 0,
            max: service.max || 0,
            rate: service.rate != null ? Number(service.rate) : null,
            unit: Number(service.unit) || 1000,
            raw: service
          };
        }

        function buildDescriptionFragment(text){
          var frag = document.createDocumentFragment();
          if (text == null) return frag;
          var value = String(text);
          if (!value){
            frag.appendChild(document.createTextNode(''));
            return frag;
          }
          var normalized = value.replace(/\r\n?/g, '\n');
          var lines = normalized.split('\n');
          lines.forEach(function(line, lineIndex){
            if (lineIndex > 0) frag.appendChild(document.createElement('br'));
            var lastIndex = 0;
            var match;
            urlRegex.lastIndex = 0;
            while ((match = urlRegex.exec(line)) !== null){
              if (match.index > lastIndex){
                frag.appendChild(document.createTextNode(line.slice(lastIndex, match.index)));
              }
              var url = match[0];
              var anchor = document.createElement('a');
              anchor.href = url;
              anchor.target = '_blank';
              anchor.rel = 'noopener noreferrer';
              anchor.textContent = url;
              frag.appendChild(anchor);
              lastIndex = match.index + url.length;
            }
            if (lastIndex < line.length){
              frag.appendChild(document.createTextNode(line.slice(lastIndex)));
            }
          });
          return frag;
        }

        function buildCategories(list){
          var map = {};
          var out = [];
          list.forEach(function(item){
            if (!item) return;
            if (!map[item.categoryKey]){
              map[item.categoryKey] = true;
              out.push({ key: item.categoryKey, label: item.category });
            }
          });
          return out;
        }

        function getFilteredServices(){
          var cat = uiState.selectedCategory;
          return uiState.services.filter(function(service){
            if (cat && service.categoryKey !== cat) return false;
            return true;
          });
        }

        function findServiceByIdFragment(fragment){
          if (!fragment) return null;
          var digits = normalizeDigits(fragment).replace(/\D/g,'').trim();
          if (!digits) return null;
          var exact = uiState.services.find(function(service){
            return String(service.id) === digits;
          });
          return exact || null;
        }

        function focusServiceByIdFragment(fragment){
          var service = findServiceByIdFragment(fragment);
          if (!service) return null;
          uiState.selectedCategory = service.categoryKey || uiState.selectedCategory || '';
          renderCategories();
          uiState.selectedServiceId = service.id;
          renderServices();
          return service;
        }

        function renderCategories(){
          if (!uiRefs || !uiRefs.category) return;
          var select = uiRefs.category;
          select.innerHTML = '';
          if (!uiState.categories.length){
            var placeholder = document.createElement('option');
            placeholder.textContent = 'لا توجد فئات متاحة حالياً';
            placeholder.disabled = true;
            placeholder.selected = true;
            select.appendChild(placeholder);
            select.disabled = true;
            syncCustomSelect(select);
            return;
          }
          select.disabled = false;
          if (!uiState.selectedCategory){
            uiState.selectedCategory = uiState.categories[0].key;
          }
          uiState.categories.forEach(function(cat){
            var opt = document.createElement('option');
            opt.value = cat.key;
            opt.textContent = formatCategoryLabel(cat.label);
            if (cat.key === uiState.selectedCategory) opt.selected = true;
            select.appendChild(opt);
          });
          syncCustomSelect(select);
        }

        function renderServices(){
          if (!uiRefs || !uiRefs.service) return;
          var select = uiRefs.service;
          select.innerHTML = '';
          var filtered = getFilteredServices();
          if (!filtered.length){
            var placeholder = document.createElement('option');
            placeholder.textContent = uiState.selectedCategory ? 'لا توجد خدمات مطابقة' : 'اختر الفئة أولاً';
            placeholder.disabled = true;
            placeholder.selected = true;
            select.appendChild(placeholder);
            select.disabled = true;
            if (uiRefs.serviceEmpty){
              uiRefs.serviceEmpty.textContent = placeholder.textContent;
              uiRefs.serviceEmpty.style.display = 'block';
            }
            uiState.selectedServiceId = '';
            qtyUserEdited = false;
            updateDetails();
            syncCustomSelect(select);
            return;
          }
          select.disabled = false;
          if (uiRefs.serviceEmpty) uiRefs.serviceEmpty.style.display = 'none';
          var hasSelected = filtered.some(function(item){ return item.id === uiState.selectedServiceId; });
          if (!hasSelected){
            uiState.selectedServiceId = filtered[0].id;
            qtyUserEdited = false;
          }
          filtered.forEach(function(service){
            var opt = document.createElement('option');
            opt.value = service.id;
            opt.textContent = service.name || ('خدمة ' + service.id);
            opt.dataset.serviceId = service.id;
            if (service.id === uiState.selectedServiceId) opt.selected = true;
            select.appendChild(opt);
          });
          updateDetails();
          enforceQtyBounds();
          syncCustomSelect(select);
        }

        function ensureForm(section){
          if (uiRefs && uiRefs.section === section) return uiRefs;
          if (!section) return null;
          section.innerHTML = '';
          var form = document.createElement('div');
          form.className = 'smm-inline-form';
          form.innerHTML = [
              '<div class="smm-inline-group smm-inline-group-search">',
              '<label>ابحث برقم الخدمة</label>',
              '<div class="smm-inline-search">',
                '<input type="text" data-smm-search class="smm-inline-field smm-inline-search-input" placeholder="أدخل رقم الخدمة..." inputmode="numeric" autocomplete="off">',
                '<i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>',
              '</div>',
              '<p class="smm-inline-hint" data-smm-search-status></p>',
            '</div>',
            '<div class="smm-inline-group">',
              '<label for="smmInlineCategory">الفئة</label>',
              '<select id="smmInlineCategory" data-smm-category class="smm-inline-field smm-inline-select"></select>',
            '</div>',
            '<div class="smm-inline-group">',
              '<label for="smmInlineService" data-smm-service-label>الخدمة</label>',
              '<select id="smmInlineService" data-smm-service class="smm-inline-field smm-inline-select"></select>',
              '<p class="smm-inline-hint" data-smm-service-empty>اختر فئة لعرض الخدمات.</p>',
            '</div>',
            '<div class="smm-inline-group">',
              '<label>الوصف</label>',
              '<div class="smm-inline-description-body empty" data-smm-description>اختر خدمة لعرض تفاصيلها والتعليمات.</div>',
            '</div>',
            '<div class="smm-inline-group">',
              '<label for="smmInlineLink">الرابط أو رقم الهاتف</label>',
              '<input id="smmInlineLink" type="text" data-smm-link class="smm-inline-field" placeholder="أدخل الرابط أو رقم الهاتف المطلوب" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">',
            '</div>',
            '<div class="smm-inline-row">',
              '<div class="smm-inline-group">',
                '<label for="smmInlineQty">الكمية</label>',
                '<input id="smmInlineQty" type="number" step="1" data-smm-qty class="smm-inline-field" placeholder="أدخل الكمية المطلوبة">',
                '<div class="smm-inline-hint" data-smm-qty-hint>الحد الأدنى - الحد الأقصى سيتم عرضه بعد اختيار الخدمة.</div>',
              '</div>',
              '<div class="smm-inline-group">',
                '<label for="smmInlineTotal">السعر</label>',
                '<input id="smmInlineTotal" type="text" data-smm-total class="smm-inline-field smm-inline-total" value="—" readonly>',
              '</div>',
            '</div>',
            '<button type="button" class="smm-inline-submit" data-smm-submit>تنفيذ الطلب</button>'
          ].join('');
          section.appendChild(form);
          uiRefs = {
            section: section,
            form: form,
            search: form.querySelector('[data-smm-search]'),
            searchStatus: form.querySelector('[data-smm-search-status]'),
            category: form.querySelector('[data-smm-category]'),
            service: form.querySelector('[data-smm-service]'),
            serviceEmpty: form.querySelector('[data-smm-service-empty]'),
            serviceLabel: form.querySelector('[data-smm-service-label]'),
            description: form.querySelector('[data-smm-description]'),
            link: form.querySelector('[data-smm-link]'),
            qty: form.querySelector('[data-smm-qty]'),
            qtyHint: form.querySelector('[data-smm-qty-hint]'),
            total: form.querySelector('[data-smm-total]'),
            submit: form.querySelector('[data-smm-submit]')
          };
          if (uiRefs.category) uiRefs.category.dataset.placeholder = 'اختر الفئة';
          if (uiRefs.service) uiRefs.service.dataset.placeholder = 'اختر الخدمة';
          if (uiRefs.search){
            uiRefs.search.addEventListener('input', function(e){
              var raw = e.target.value || '';
              var digits = normalizeDigits(raw).replace(/\D/g,'');
              if (digits !== raw) e.target.value = digits;
              if (!digits){
                setSearchStatus('', '');
                return;
              }
              if (!uiState.services.length){
                setSearchStatus('لم يتم تحميل الخدمات بعد.', 'error');
                return;
              }
              var matched = focusServiceByIdFragment(digits);
              if (matched){
                setSearchStatus('تم تحديد الخدمة #' + matched.id, 'success');
              } else {
                setSearchStatus('لا توجد خدمة بهذا الرقم.', 'error');
              }
            });
          }
          if (uiRefs.category){
            uiRefs.category.addEventListener('change', function(e){
              uiState.selectedCategory = e.target.value || '';
              uiState.selectedServiceId = '';
              renderServices();
            });
          }
          if (uiRefs.service){
            uiRefs.service.addEventListener('change', function(e){
              uiState.selectedServiceId = e.target.value || '';
              qtyUserEdited = false;
              updateDetails();
              enforceQtyBounds();
            });
          }
          if (uiRefs.qty){
            uiRefs.qty.addEventListener('keydown', function(e){
              if (e.key === ' ') e.preventDefault();
            });
            uiRefs.qty.addEventListener('input', function(){
              var sanitized = (this.value || '').replace(/\D/g,'');
              if (sanitized !== this.value) this.value = sanitized;
              qtyUserEdited = true;
              enforceQtyBounds();
              updateTotal();
            });
          }
          if (uiRefs.submit){
            uiRefs.submit.addEventListener('click', handleSubmit);
          }
          if (uiRefs.category) syncCustomSelect(uiRefs.category);
          if (uiRefs.service) syncCustomSelect(uiRefs.service);
          return uiRefs;
        }

        function setInlineLoading(isLoading, text){
          if (!uiRefs || !uiRefs.submit) return;
          uiRefs.submit.disabled = !!isLoading;
          uiRefs.submit.textContent = isLoading ? (text || 'جاري التنفيذ...') : 'تنفيذ الطلب';
        }

        function createSmmGuardToken(prefix){
          var tag = prefix || 'smm';
          try {
            var source = (typeof window !== 'undefined' && window.crypto && typeof window.crypto.getRandomValues === 'function')
              ? window.crypto
              : (typeof self !== 'undefined' && self.crypto && typeof self.crypto.getRandomValues === 'function'
                ? self.crypto
                : null);
            if (source){
              var buf = new Uint32Array(2);
              source.getRandomValues(buf);
              var hex = Array.from(buf).map(function(n){ return n.toString(16).padStart(8,'0'); }).join('');
              return tag + '-' + Date.now().toString(36) + '-' + hex;
            }
          } catch(_){}
          return tag + '-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2);
        }

        function getTurnstileToken(){
          return Promise.resolve(createSmmGuardToken('smm'));
        }

        function placeInlineOrder(service, link, qty){
          var currentUser = null;
          var sessionKey = null;
          return waitForUser().then(function(user){
            if (!user) throw createError('login_required','سجّل الدخول لتنفيذ الطلب.');
            currentUser = user;
            sessionKey = getLocalSessionKey();
            if (!sessionKey) throw createError('session_missing','انتهت صلاحية الجلسة، يرجى إعادة تسجيل الدخول.');
            return Promise.all([currentUser.getIdToken(true), getTurnstileToken()]);
          }).then(function(results){
            var idToken = results[0];
            var guardToken = results[1];
            var url = new URL(buildApiBase());
            url.searchParams.set('mode','order');
            var payload = {
              action: 'order',
              serviceId: service.id,
              quantity: qty,
              link: link,
              guardToken: guardToken,
              turnstileToken: guardToken,
              currentUrl: window.location.href
            };
            return fetch(url.toString(), {
              method: 'POST',
              headers: {
                'Content-Type':'application/json',
                'Authorization':'Bearer ' + idToken,
                'X-SessionKey': sessionKey
              },
              body: JSON.stringify(payload)
            });
          }).then(async function(res){
            var data = await res.json().catch(function(){ return {}; });
            if (!res.ok || data.success === false){
              throw createError(data.code || 'order_failed', data.error || 'تعذر تنفيذ الطلب');
            }
            return data;
          });
        }

        function getSelectedService(){
          if (!uiState.selectedServiceId) return null;
          return uiState.services.find(function(s){ return s.id === uiState.selectedServiceId; }) || null;
        }

        function updateDetails(){
          var service = getSelectedService();
          if (uiRefs && uiRefs.description){
            if (!service){
              uiRefs.description.textContent = 'اختر خدمة لعرض تفاصيلها والتعليمات.';
              uiRefs.description.classList.add('empty');
            } else if (service.description){
              uiRefs.description.innerHTML = '';
              uiRefs.description.appendChild(buildDescriptionFragment(service.description));
              uiRefs.description.classList.remove('empty');
            } else {
              uiRefs.description.textContent = 'لا يوجد وصف متاح لهذه الخدمة.';
              uiRefs.description.classList.add('empty');
            }
          }
          if (uiRefs && uiRefs.serviceLabel){
            uiRefs.serviceLabel.textContent = 'الخدمة';
          }
          syncQuantityLimits(service);
          updateTotal();
        }

        function syncQuantityLimits(service){
          if (!uiRefs || !uiRefs.qty) return;
          if (!service){
            uiRefs.qty.value = '';
            if (uiRefs.qtyHint){
              uiRefs.qtyHint.dataset.baseHint = 'الحد الأدنى - الحد الأقصى سيتم عرضه بعد اختيار الخدمة.';
              uiRefs.qtyHint.textContent = uiRefs.qtyHint.dataset.baseHint;
              uiRefs.qtyHint.classList.remove('error');
            }
            qtyUserEdited = false;
            applyQtyWarning('');
            return;
          }
          var min = Number(service.min) || 0;
          var max = Number(service.max) || 0;
          if (uiRefs.qtyHint){
            var base = (min ? ('الحد الأدنى ' + min) : 'بدون حد أدنى') + ' - ' + (max ? ('الحد الأقصى ' + max) : 'بدون حد أقصى');
            uiRefs.qtyHint.dataset.baseHint = base;
            uiRefs.qtyHint.textContent = base;
            uiRefs.qtyHint.classList.remove('error');
          }
          applyQtyWarning('');
          if (!qtyUserEdited){
            uiRefs.qty.value = min ? String(min) : '';
          }
          enforceQtyBounds();
        }

        function clampQuantity(){
          if (!uiRefs || !uiRefs.qty) return;
          var service = getSelectedService();
          if (!service) return;
          var min = Number(service.min) || 0;
          var max = Number(service.max) || 0;
          var value = Number(uiRefs.qty.value);
          if (!Number.isFinite(value)) return;
          if (min && value < min) value = min;
          if (max && max > 0 && value > max) value = max;
          uiRefs.qty.value = value;
        }

        function updateTotal(){
          if (!uiRefs || !uiRefs.total) return;
          var service = getSelectedService();
          if (!service){
            uiRefs.total.value = '—';
            return;
          }
          var qty = Number(uiRefs.qty && uiRefs.qty.value);
          if (!Number.isFinite(qty) || qty <= 0){
            uiRefs.total.value = '—';
            return;
          }
          var unit = Number(service.unit) || 1000;
          var ratePerUnit = null;
          if (service.rate != null && Number.isFinite(Number(service.rate))){
            ratePerUnit = Number(service.rate);
          }
          if (ratePerUnit == null || !Number.isFinite(ratePerUnit)){
            uiRefs.total.value = '—';
            return;
          }
          var total = ratePerUnit * qty;
          uiRefs.total.value = total.toFixed(3) + ' $';
        }

        function quantizeMoney(value){
          var num = Number(value);
          if (!Number.isFinite(num)) return null;
          return Math.round((num + Number.EPSILON) * 100) / 100;
        }

        function calculateOrderCost(service, qty){
          if (!service) return null;
          var ratePerUnit = Number(service.rate);
          var quantity = Number(qty);
          if (!Number.isFinite(ratePerUnit) || !Number.isFinite(quantity) || quantity <= 0) return null;
          return quantizeMoney(ratePerUnit * quantity);
        }

        function getCachedSessionUid(){
          try{
            var parsed = JSON.parse(localStorage.getItem("sessionKeyInfo") || "null");
            return parsed && parsed.uid ? parsed.uid : "";
          }catch(_){
            return "";
          }
        }

        function getCachedWalletBalance(){
          if (typeof window !== "undefined" && window.__BAL_BASE__ != null){
            var baseVal = Number(window.__BAL_BASE__);
            if (Number.isFinite(baseVal)) return baseVal;
          }
          var uid = getCachedSessionUid();
          if (!uid) return null;
          try{
            var raw = localStorage.getItem("balance:cache:" + uid);
            if (raw == null) return null;
            var val = Number(raw);
            if (Number.isFinite(val)) return val;
          }catch(_){}
          return null;
        }

        function adjustCachedWalletBalance(delta){
          if (!Number.isFinite(delta) || delta === 0) return;
          var uid = getCachedSessionUid();
          var current = getCachedWalletBalance();
          if (current == null) current = 0;
          var updated = quantizeMoney(current + delta);
          if (updated == null) return;
          try { window.__BAL_BASE__ = updated; } catch(_){}
          if (uid){
            try { localStorage.setItem("balance:cache:" + uid, String(updated)); } catch(_){}
          }
          try {
            var evt = new CustomEvent("balance:change", { detail: { value: updated } });
            window.dispatchEvent(evt);
          } catch(_){}
        }

        function submitInlineOrder(service, link, qty){
          if (!uiRefs || !uiRefs.section) return;
          setInlineLoading(true);
          setMessage(uiRefs.section, 'جاري تنفيذ الطلب...', 'info');
          placeInlineOrder(service, link, qty).then(function(result){
            var orderIdentifier = '';
            if (result && (result.orderCode || result.orderId)){
              orderIdentifier = String(result.orderCode || result.orderId);
            }
            var suffix = orderIdentifier ? (' #' + orderIdentifier) : '';
            var manual = !!(result && result.manualForward);
            var successMessage = manual
              ? 'تم تحويل الطلب للتنفيذ اليدوي'
              : 'تم تسجيل الطلب وجاري تنفيذه';
            setMessage(uiRefs.section, successMessage + suffix, 'success');
            showInlineResultOverlay({
              success: true,
              orderCode: orderIdentifier,
              manualForward: manual,
              message: manual
                ? 'تمت إحالة طلبك للفريق اليدوي وسيتم التواصل معك فور التنفيذ.'
                : 'يمكنك متابعة حالة الطلب من صفحة الطلبات.',
              details: manual
                ? 'يُرجى متابعة إشعاراتك، وسيتم تنفيذ الطلب خلال وقت قصير.'
                : ''
            });
            if (result && result.estimatedCharge != null){
              var chargeVal = Number(result.estimatedCharge);
              if (Number.isFinite(chargeVal) && chargeVal > 0){
                adjustCachedWalletBalance(-chargeVal);
              }
            }
            showToast('تم تسجيل الطلب' + suffix, true);
            try{
              if (uiRefs.link) uiRefs.link.value = '';
              if (uiRefs.qty) uiRefs.qty.value = '';
            }catch(_){}
          }).catch(function(err){
            var raw = err && (err.message || err.error || err.hint);
            var msg = (typeof raw === 'string' && raw.trim()) ? raw : 'تعذر تنفيذ الطلب';
            setMessage(uiRefs.section, msg, 'error');
            showInlineResultOverlay({
              success: false,
              message: msg,
              details: err && err.code ? ('رمز الخطأ: ' + err.code) : ''
            });
            showToast(msg, false);
          }).finally(function(){
            setInlineLoading(false);
          });
        }

        function handleSubmit(){
          var service = getSelectedService();
          if (!service){
            showToast('اختر الخدمة أولاً', false);
            return;
          }
          var link = (uiRefs.link && uiRefs.link.value || '').trim();
          if (!link){
            showToast('يرجى إدخال الرابط أو رقم الهاتف المطلوب', false);
            return;
          }
          var qtyRaw = (uiRefs.qty && uiRefs.qty.value || '').trim();
          var qty = qtyRaw ? parseInt(qtyRaw, 10) : NaN;
          if (!Number.isFinite(qty) || qty <= 0){
            showToast('يرجى إدخال كمية صحيحة', false);
            return;
          }
          uiRefs.qty.value = String(qty);
          var min = Number(service.min) || 0;
          var max = Number(service.max) || 0;
          if (min && qty < min){
            showToast('الحد الأدنى للطلب هو ' + min, false);
            return;
          }
          if (max && max > 0 && qty > max){
            showToast('الحد الأقصى للطلب هو ' + max, false);
            return;
          }
          applyQtyWarning('');
          var estimatedCost = calculateOrderCost(service, qty);
          var cachedBalance = getCachedWalletBalance();
          if (estimatedCost != null && cachedBalance != null && (cachedBalance + 1e-9) < estimatedCost){
            var warn = 'رصيدك غير كافٍ لإتمام هذا الطلب.';
            if (Number.isFinite(estimatedCost) && Number.isFinite(cachedBalance)){
              warn += ' التكلفة المتوقعة ' + estimatedCost.toFixed(2) + ' $ مقابل رصيد متاح قدره ' + cachedBalance.toFixed(2) + ' $.';
            }
            setMessage(uiRefs.section, warn, 'error');
            showToast(warn, false);
            showInlineResultOverlay({
              success: false,
              message: warn,
              details: Number.isFinite(cachedBalance) ? ('رصيدك الحالي: ' + cachedBalance.toFixed(2) + ' $') : ''
            });
            return;
          }
          submitInlineOrder(service, link, qty);
        }

        function clearStaticCards(section){
          if (!section || section.dataset.smmPrepared === '1') return;
          section.dataset.smmPrepared = '1';
          Array.prototype.slice.call(section.querySelectorAll('.card')).forEach(function(node){
            if (!node || node.dataset.smmCard === '1') return;
            try { node.remove(); } catch(_){ if (node.parentNode) node.parentNode.removeChild(node); }
          });
        }

        function render(section, options){
          options = options || {};
          ensureStyles();
          if (!section) return Promise.resolve();
          clearStaticCards(section);
          setMessage(section, 'جاري تحميل خدمات...', 'info');
          var form = ensureForm(section);
          if (!form){
            setMessage(section, 'تعذر تحضير نموذج الخدمات.', 'error');
            return Promise.resolve();
          }
          return fetchServices(options.force === true).then(function(list){
            var normalized = list.map(normalizeService).filter(Boolean);
            uiState.services = normalized;
            uiState.categories = buildCategories(normalized);
            var hasCat = uiState.categories.some(function(cat){ return cat.key === uiState.selectedCategory; });
            if (!hasCat) uiState.selectedCategory = uiState.categories[0] ? uiState.categories[0].key : '';
            uiState.selectedServiceId = '';
            if (!uiState.categories.length){
              setMessage(section, 'لا توجد خدمات متاحة حالياً.', 'warning');
              renderCategories();
              renderServices();
              return;
            }
            renderCategories();
            renderServices();
            setMessage(section, '', '');
          }).catch(function(err){
            var code = err && err.code;
            if (code === 'login_required') setMessage(section, err.message || 'سجّل الدخول للاطلاع على الخدمات.', 'warning');
            else if (code === 'session_missing') setMessage(section, err.message || 'يرجى إعادة تسجيل الدخول لتحديث الجلسة.', 'warning');
            else setMessage(section, err && err.message ? err.message : 'تعذر تحميل خدمات الرشق.', 'error');
          }).finally(function(){
            try { applyCardsVisibility(); } catch(_){}
          });
        }

        return {
          render: render,
          refresh: function(section){ return render(section, { force: true }); }
        };
      })();

      var routes = {
        'social': {
          url: 'social.html',
          title: 'تواصل اجتماعي',
          onShow: function(){
            var attempts = 0;
            (function waitAndRender(){
              try{
                var section = inlineBox ? inlineBox.querySelector('.categories') : null;
                if (!section && attempts < 5){
                  attempts++;
                  setTimeout(waitAndRender, 120);
                  return;
                }
                socialBoostInline.render(section);
              } catch(err){
                console.warn("social render failed:", err);
              }
            })();
          }
        },
        'software':      { url: 'software.html',      title: 'اشتراكات ' },
        'freefireinbut': { url: 'freefireinbut.html', title: 'فري فاير' },
        'settings':      { title: 'إعدادات الحساب', build: settingsRoute.build, onShow: settingsRoute.onShow },
        'reviews':       { title: 'التقييمات', build: reviewsRoute.build, onShow: reviewsRoute.onShow, ready: reviewsRoute.ready },
        'transfer':      { title: 'تحويل رصيد', build: transferRoute.build, onShow: transferRoute.onShow, ready: transferRoute.ready },
        'wallet':        { title: 'محفظتي', build: walletRoute.build, onShow: walletRoute.onShow, ready: walletRoute.ready }
      };

      var home = {
        hero: function(){ return document.querySelector('.page-hero'); },
        ticker: function(){ return document.getElementById('homeTicker'); },
        homeSearch: function(){ return document.querySelector('body > .search-container'); },
        grid: function(){ return document.getElementById('accountsWrapper'); },
        noResults: function(){ return document.getElementById('noResults'); },
        support: function(){ return document.querySelector('.support-section'); },
        rights: function(){ return document.querySelector('.support-rights'); }
      };
      var inlineBox = document.getElementById('inlinePage');

      function show(el, v){ if(!el) return; el.style.display = v ? '' : 'none'; }
      function clear(el){ if(!el) return; while(el.firstChild) el.removeChild(el.firstChild); }
      function scrollTop(){ try{ window.scrollTo({ top:0, behavior:'smooth' }); }catch(_){ window.scrollTo(0,0); } }

      function buildToolbar(title){
        var bar = document.createElement('div');
        bar.className = 'inline-toolbar';
        var back = document.createElement('button'); back.className='inline-back'; back.textContent='رجوع'; back.addEventListener('click', function(){ navigateHome(); });
        var t = document.createElement('div'); t.className='inline-title'; t.textContent = title||'';
        bar.appendChild(back); bar.appendChild(t);
        return bar;
      }

      function extractContent(html){
        var doc = new DOMParser().parseFromString(html, 'text/html');
        var sc = doc.querySelector('.search-container');
        var main = doc.querySelector('main');
        var cats = main ? main.querySelector('.categories') : null;
        var frag = document.createDocumentFragment();
        if (sc) frag.appendChild(sc.cloneNode(true));
        if (cats){
          var wrap = document.createElement('div');
          wrap.appendChild(cats.cloneNode(true));
          var p = document.createElement('p'); p.className='no-results'; p.id='inlineNoResults'; p.textContent='عذراً، لم يتم العثور على نتائج.'; p.style.display='none';
          wrap.appendChild(p);
          frag.appendChild(wrap);
          return frag;
        }
        if (main){
          Array.prototype.forEach.call(main.childNodes, function(n){ frag.appendChild(n.cloneNode(true)); });
          return frag;
        }
        var body = doc.body;
        if (body){ Array.prototype.forEach.call(body.childNodes, function(n){ frag.appendChild(n.cloneNode(true)); }); }
        return frag;
      }

      function attachSearchBehavior(container){
        try{
          var input = container.querySelector('.search-container input');
          var grid = container.querySelector('.categories');
          var noResults = container.querySelector('#inlineNoResults');
          if(!input || !grid) return;
          var cards = Array.prototype.slice.call(grid.querySelectorAll('.card'));
          function norm(s){ return (s||'').toString().toLowerCase()
            .replace(/[ًٌٍَُِّْـ]/g,'')
            .replace(/[إأآا]/g,'ا')
            .replace(/ى/g,'ي')
            .replace(/ة/g,'ه')
            .replace(/[^\p{L}\p{N}\s]/gu,'')
            .trim(); }
          function apply(q){
            var nq = norm(q), shown = 0;
            cards.forEach(function(card){
              var titleEl = card.querySelector('h2');
              var title = (card.dataset && card.dataset.title) || (titleEl ? titleEl.textContent : '') || '';
              var ok = nq === '' || norm(title).includes(nq);
              card.style.display = ok ? '' : 'none';
              if (ok) shown++;
            });
            if (noResults) noResults.style.display = shown ? 'none' : 'block';
          }
          input.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); apply(input.value); } });
          var t; input.addEventListener('input', function(){ clearTimeout(t); t=setTimeout(function(){ apply(input.value); }, 150); });
        }catch(_){ }
      }

      function updateViewForInline(showInline){
        show(home.hero(), !showInline);
        show(home.ticker(), !showInline);
        show(home.homeSearch(), !showInline);
        show(home.grid(), !showInline);
        show(home.noResults(), false);
        show(inlineBox, showInline);
        // Keep footer (support + rights) visible even in inline view
        show(home.support(), true);
        show(home.rights(), true);
      }

      // Fallback templates in case fetch fails (kept minimal to avoid duplication)
      var TEMPLATES = {
        social:
          '<section class="categories" data-smm-inline="1">\n' +
            '<div class="smm-inline-form">\n' +
              '<div class="smm-inline-group smm-inline-group-search">\n' +
                '<label>ابحث برقم الخدمة</label>\n' +
                '<div class="smm-inline-search">\n' +
                  '<input type="text" placeholder="أدخل رقم الخدمة..." inputmode="numeric">\n' +
                  '<i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>\n' +
                '</div>\n' +
                '<p class="smm-inline-hint"></p>\n' +
              '</div>\n' +
              '<div class="smm-inline-group">\n' +
                '<label>الفئة</label>\n' +
                '<select disabled><option>جاري التحميل...</option></select>\n' +
              '</div>\n' +
              '<div class="smm-inline-group">\n' +
                '<label>الخدمة</label>\n' +
                '<select disabled><option>جاري التحميل...</option></select>\n' +
                '<p class="smm-inline-hint">سيتم عرض الخدمات بعد تسجيل الدخول.</p>\n' +
              '</div>\n' +
              '<div class="smm-inline-group">\n' +
                '<label>الوصف</label>\n' +
                '<div class="smm-inline-description-body empty">اختر خدمة لعرض تفاصيلها.</div>\n' +
              '</div>\n' +
              '<div class="smm-inline-group">\n' +
                '<label>الرابط أو رقم الهاتف</label>\n' +
                '<input type="text" placeholder="أدخل الرابط أو رقم الهاتف المطلوب" disabled>\n' +
              '</div>\n' +
              '<div class="smm-inline-row">\n' +
                '<div class="smm-inline-group">\n' +
                  '<label>الكمية</label>\n' +
                  '<input type="number" disabled>\n' +
                  '<div class="smm-inline-hint">سيتم تحديد الحدود بعد اختيار الخدمة.</div>\n' +
                '</div>\n' +
                '<div class="smm-inline-group">\n' +
                  '<label>السعر</label>\n' +
                  '<input type="text" class="smm-inline-field smm-inline-total" value="—" disabled>\n' +
                '</div>\n' +
              '</div>\n' +
              '<button type="button" class="smm-inline-submit" disabled>تنفيذ الطلب</button>\n' +
            '</div>\n' +
          '</section>',
        software:
          '<div class="search-container">\n' +
            '<input type="text" placeholder="ابحث عن الخدمات أو التصنيفات..." aria-label="بحث" />\n' +
          '</div>\n' +
          '<section class="categories">\n' +
            '<a href="canva.html" class="card" data-title="كانفا">\n' +
              '<img draggable="false" src="IMGS/canva.jpg" alt="كانفا"/>\n' +
              '<h2>كانفا</h2>\n' +
            '</a>\n' +
            '<a href="netflix.html" class="card" data-title="نتفلكس">\n' +
              '<img draggable="false" src="IMGS/netflix.jpg" alt="نتفلكس"/>\n' +
              '<h2>نتفلكس</h2>\n' +
            '</a>\n' +
              '<a href="capcut.html" class="card" data-title="كاب كات">\n' +
              '<img draggable="false" src="IMGS/capcut.jpg" alt="كاب كات"/>\n' +
              '<h2>كاب كات</h2>\n' +
            '</a>\n' +
            '<a href="chatgpt.html" class="card" data-title="ChatGPT">\n' +
              '<img draggable="false" src="IMGS/chatgpt.jpg" alt="ChatGPT"/>\n' +
              '<h2>ChatGPT</h2>\n' +
            '</a>\n' +
          '</section>',
        freefireinbut:
          '<div class="search-container">\n' +
            '<input type="text" placeholder="ابحث عن الخدمات أو التصنيفات..." aria-label="بحث" />\n' +
          '</div>\n' +
          '<section class="categories">\n' +
            '<a href="freefireauto.html" class="card auto featured" data-title="فري فاير تلقائي">\n' +
              '<img draggable="false" src="IMGS/frefireauto.jpg" alt="فري فاير تلقائي"/>\n' +
              '<h2>فري فاير تلقائي</h2>\n' +
            '</a>\n' +

                        '<a href="freefireauto2.html" class="card auto featured" data-title="فري فاير عضويات">\n' +
              '<img draggable="false" src="IMGS/frefireauto.jpg" alt="فري فاير عضويات"/>\n' +
              '<h2>فري فاير تلقائي 2</h2>\n' +
            '</a>\n' +

            '<a href="freefireN.html" class="card" data-title="فري فاير نيجيري">\n' +
              '<img draggable="false" src="IMGS/freefiren.jpg" alt="فري فاير نيجيري"/>\n' +
              '<h2>فري فاير نيجيري</h2>\n' +
            '</a>\n' +
             '<a href="freefire.html" class="card" data-title="فري فاير يدوي">\n' +
              '<img draggable="false" src="IMGS/freefiremanual.jpg" alt="فري فاير يدوي"/>\n' +
              '<h2>فري فاير يدوي</h2>\n' +
            '</a>\n' +
            '<a href="freefiremembership.html" class="card" data-title="فري فاير عضويات">\n' +
              '<img draggable="false" src="IMGS/freefiremanual.jpg" alt="فري فاير عضويات"/>\n' +
              '<h2>فري فاير عضويات</h2>\n' +
            '</a>\n' +
          '</section>',
        webdev:
          '<div class="search-container">\n' +
            '<input type="text" placeholder="ابحث عن الخدمات أو التصنيفات..." aria-label="بحث" />\n' +
          '</div>\n' +
          '<section class="categories">\n' +
            '</a>\n' +
          '</section>'
      };

      function renderFromTemplate(key){
        var html = TEMPLATES[key];
        if (!html) return null;
        var wrapper = document.createElement('div');
        wrapper.innerHTML = html;
        var frag = document.createDocumentFragment();
        // move children to frag to avoid extra wrapper
        while(wrapper.firstChild){ frag.appendChild(wrapper.firstChild); }
        // add no-results placeholder
        var p = document.createElement('p'); p.className='no-results'; p.id='inlineNoResults'; p.textContent='عذراً، لم يتم العثور على نتائج.'; p.style.display='none';
        frag.appendChild(p);
        return frag;
      }

      async function loadInline(key){
        var r = routes[key]; if(!r) return;
        updateViewForInline(true);
        scrollTop();
        clear(inlineBox);
        // Load inline templates directly (external list files were removed)
        var content = null;
        if (r && typeof r.build === 'function') {
          try { content = r.build(); } catch(_){ content = null; }
        }
        if (!content) {
          content = renderFromTemplate(key);
        }
        if (content) {
          inlineBox.appendChild(content);
          if (r && typeof r.onShow === 'function') {
            try { r.onShow(); } catch(_){ }
          }
          try{ if (typeof applyCardsVisibility === 'function') applyCardsVisibility(); }catch(_){ }
          try{ attachSearchBehavior(inlineBox); }catch(_){ }
          // Hide the page loader after inline content is ready (hash navigation)
          // Ensure minimum 300ms visibility from when it was shown
          try {
            var started = 0;
            try { started = Number(sessionStorage.getItem('nav:loader:showAt')||0) || 0; } catch(_){ started = 0; }
            // Clear flags so global guards don’t block hiding
            try { sessionStorage.removeItem('nav:loader:expected'); sessionStorage.removeItem('nav:loader:showAt'); } catch(_){ }
            var elapsed = started ? (Date.now() - started) : Infinity;
            var remain = 300 - elapsed;
            function doHide(){
              try {
                requestAnimationFrame(function(){ requestAnimationFrame(function(){
                  if (typeof hidePageLoader === 'function') hidePageLoader();
                }); });
              } catch(_){ if (typeof hidePageLoader === 'function') hidePageLoader(); }
            }
            if (remain > 0 && remain < 5000) { setTimeout(doHide, remain); } else { doHide(); }
          } catch(_){ if (typeof hidePageLoader === 'function') hidePageLoader(); }
        } else {
          var err = document.createElement('div'); err.textContent = 'لا يوجد محتوى متاح حالياً.'; inlineBox.appendChild(err);
          // Ensure loader never gets stuck even on failure
          try {
            var startedF = 0; try { startedF = Number(sessionStorage.getItem('nav:loader:showAt')||0) || 0; } catch(_){ startedF = 0; }
            try { sessionStorage.removeItem('nav:loader:expected'); sessionStorage.removeItem('nav:loader:showAt'); } catch(_){ }
            var elapsedF = startedF ? (Date.now() - startedF) : Infinity;
            var remainF = 300 - elapsedF;
            function doHideF(){ try { if (typeof hidePageLoader === 'function') hidePageLoader(); } catch(_){ } }
            if (remainF > 0 && remainF < 5000) { setTimeout(doHideF, remainF); } else { doHideF(); }
          } catch(_){ try { if (typeof hidePageLoader === 'function') hidePageLoader(); } catch(__){} }
        }
      }

      function navigate(key){
        if(!routes[key]) return;
        if (location.hash !== '#/'+key) { history.pushState({key:key}, '', '#/'+key); }
        try { if (typeof showPageLoader === 'function') showPageLoader(); } catch(_){ }
        try { window.__INLINE_FORCE_ROUTE__ = key; } catch(_){}
        try {
          loadInline(key);
        } finally {
          try { window.__INLINE_FORCE_ROUTE__ = null; } catch(_){}
        }
      }
      window.__reloadInlineRoute = function(key){
        try{
          if (!key) return;
          var normalized = String(key).replace(/^#\//,'').replace(/^\/+/,'');
          if (!normalized || !routes[normalized]) return;
          try {
            loadInline(normalized);
          } finally {
            try { window.__INLINE_FORCE_ROUTE__ = null; }catch(_){}
          }
        }catch(_){ }
      };
      function navigateHome(){
        history.pushState({}, '', '#/');
        updateViewForInline(false);
        clear(inlineBox);
        scrollTop();
      }

      function initFromHash(){
        var h = (location.hash||'').replace(/^#\/?/, '');
        if (h === 'games') { navigateHome(); return; }
        if (!h || h === '/') { updateViewForInline(false); return; }
        if (routes[h]) {
          try { window.__INLINE_FORCE_ROUTE__ = h; } catch(_){}
          try { loadInline(h); }
          finally { try { window.__INLINE_FORCE_ROUTE__ = null; } catch(_){ } }
        }
        else { updateViewForInline(false); }
      }

      window.addEventListener('hashchange', initFromHash);
      window.addEventListener('popstate', initFromHash);

      // Intercept clicks on home cards (handle ?allow=1, hashes, etc.)
      function handleCardNavEvent(e){
        if (e.type === 'pointerdown') {
          if (typeof e.pointerType === 'string' && e.pointerType.toLowerCase() === 'touch') { return; }
          if (typeof e.button === 'number' && e.button !== 0) { return; }
        }
        var a = e.target && e.target.closest ? e.target.closest('a.card') : null;
        if (!a) return;
        var href = (a.getAttribute('href')||'').toLowerCase();
        var path = href.split('#')[0].split('?')[0];
        if (path.endsWith('social.html'))         { e.preventDefault(); e.stopPropagation(); try{ e.stopImmediatePropagation(); }catch(_){} navigate('social'); return; }
        if (path.endsWith('software.html'))       { e.preventDefault(); e.stopPropagation(); try{ e.stopImmediatePropagation(); }catch(_){} navigate('software'); return; }
        if (path.endsWith('webdev.html'))         { e.preventDefault(); e.stopPropagation(); try{ e.stopImmediatePropagation(); }catch(_){} navigate('webdev'); return; }
        if (path.endsWith('freefireinbut.html'))  { e.preventDefault(); e.stopPropagation(); try{ e.stopImmediatePropagation(); }catch(_){} navigate('freefireinbut'); return; }
        if (path.endsWith('reviews.html'))        { e.preventDefault(); e.stopPropagation(); try{ e.stopImmediatePropagation(); }catch(_){} navigate('reviews'); return; }
        if (path.endsWith('wallet.html'))         { e.preventDefault(); e.stopPropagation(); try{ e.stopImmediatePropagation(); }catch(_){} navigate('wallet'); return; }
        if (path.endsWith('transfer.html'))       { e.preventDefault(); e.stopPropagation(); try{ e.stopImmediatePropagation(); }catch(_){} navigate('transfer'); return; }
        if (path.endsWith('settings.html'))       { e.preventDefault(); e.stopPropagation(); try{ e.stopImmediatePropagation(); }catch(_){} navigate('settings'); return; }
      }
      document.addEventListener('pointerdown', handleCardNavEvent, true);
      document.addEventListener('click', handleCardNavEvent, true);

      // Boot from hash once dependent scripts (deferred) are guaranteed to be ready
      if (document.readyState === 'complete') {
        initFromHash();
      } else {
        document.addEventListener('DOMContentLoaded', initFromHash, { once: true });
      }

      // Expose for back button in toolbar
      window.navigateHome = navigateHome;

      // Public helper to reload states with loading animation
      try {
        window.reloadCardsStates = function () {
          try { applyCardsVisibility(); } catch(_){}
          try { applyStatesToPage(); } catch(_){}
        };
      } catch(_){}
    })();
  </script>

  <style>
    #wa-join-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;background-color:rgba(6,8,20,.58);backdrop-filter:blur(2px);z-index:10000}
    #wa-join-modal .wa-modal-content{position:relative;direction:rtl;text-align:right;width:min(440px,94vw);border-radius:24px;padding:34px 32px 30px;background:linear-gradient(160deg,#1d4ed8 0%,#1f3f73 52%,#102a5c 100%);color:#f7f8ff;box-shadow:0 24px 64px rgba(24,27,84,.42);border:1px solid rgba(255,255,255,.16);overflow:hidden}
    html[data-theme="dark"] #wa-join-modal .wa-modal-content{background:linear-gradient(160deg,#1b2f61 0%,#0f1f3d 100%);box-shadow:0 24px 70px rgba(5,6,18,.64);border-color:rgba(91,143,194,.38)}
    #wa-join-modal .wa-close{position:absolute;top:18px;left:22px;width:36px;height:36px;border-radius:50%;border:1px solid rgba(255,255,255,.22);background:rgba(15,17,45,.45);color:#f6f7ff;display:flex;align-items:center;justify-content:center;font-size:1.2rem;cursor:pointer;transition:background-color .2s ease, transform .12s ease}
    #wa-join-modal .wa-close:hover{background:rgba(15,17,45,.62)}
    #wa-join-modal .wa-close:active{transform:scale(.94)}
    #wa-join-modal .wa-close:focus-visible{outline:2px solid rgba(255,255,255,.55);outline-offset:2px}
    html[data-theme="light"] #wa-join-modal .wa-close{background:rgba(255,255,255,.24);color:#1b1d3b}
    #wa-join-modal .wa-badge{display:flex;align-items:center;gap:12px;padding:12px 18px;background:rgba(255,255,255,.15);border-radius:999px;margin:0 0 22px;font-size:.95rem;color:inherit}
    html[data-theme="light"] #wa-join-modal .wa-badge{background:rgba(255,255,255,.2)}
    #wa-join-modal .wa-wave{font-size:1.25rem}
    #wa-join-modal .wa-badge-text{display:flex;flex-direction:column;gap:2px;line-height:1.2}
    #wa-join-modal .wa-badge-sub{font-size:.82rem;opacity:.84}
    #wa-join-modal .wa-badge-brand{font-size:1rem}
    #wa-join-modal h3{margin:0 0 14px;font-size:1.55rem;font-weight:700}
    #wa-join-modal p{margin:0 0 22px;font-size:1rem;color:rgba(245,246,255,.86);line-height:1.75}
    #wa-join-modal .wa-benefits{list-style:none;margin:0 0 26px;padding:0;display:flex;flex-direction:column;gap:12px}
    #wa-join-modal .wa-benefits li{display:flex;align-items:flex-start;gap:12px;font-size:.98rem;color:rgba(245,246,255,.9)}
    #wa-join-modal .wa-benefits i{color:#7fe3a0;font-size:1.15rem;margin-top:3px}
    #wa-join-modal .wa-btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;border:none;border-radius:999px;padding:14px 30px;font-size:1.08rem;font-weight:700;cursor:pointer;text-decoration:none;color:#fff;background:transparent;transition:transform .12s ease, box-shadow .25s ease, filter .2s ease}
    #wa-join-modal .wa-btn:active{transform:translateY(1px)}
    #wa-join-modal .wa-btn:focus-visible{outline:2px solid rgba(255,255,255,.4);outline-offset:2px}
    #wa-join-modal .wa-btn i{font-size:1.15rem}
    #wa-join-modal .wa-primary{background:linear-gradient(135deg,#3A8BD1 0%,#2d6ee8 50%,#1f4b99 100%);box-shadow:0 18px 42px rgba(37,99,235,.45)}
    #wa-join-modal .wa-primary:hover{filter:brightness(1.05);box-shadow:0 24px 50px rgba(37,99,235,.55)}
    #wa-join-modal .wa-note{margin:26px 0 0;font-size:.82rem;color:rgba(240,241,255,.72)}
    @media (max-width:480px){#wa-join-modal .wa-modal-content{padding:26px 22px 24px;border-radius:20px}#wa-join-modal .wa-close{top:14px;left:16px}}
  </style>
  <div id="wa-join-modal" role="dialog" aria-modal="true" aria-labelledby="wa-title" aria-describedby="wa-desc">
    <div class="wa-modal-content">
      <button type="button" class="wa-close" id="wa-close-btn" aria-label="إغلاق النافذة">
        <span aria-hidden="true">&times;</span>
      </button>
      <div class="wa-badge" role="text">
        <span class="wa-wave" aria-hidden="true">👋</span>
        <div class="wa-badge-text">
          <span class="wa-badge-sub">حياكم الله في</span>
          <strong class="wa-badge-brand">JS4ACC</strong>
        </div>
      </div>
      <h3 id="wa-title">نورّتنا!</h3>
      <p id="wa-desc">يرجى الانضمام إلى مجتمع الواتساب الخاص بنا لتصلك أهم أخبار المتجر والعروض الحصرية.</p>
      <ul class="wa-benefits" aria-label="مزايا الانضمام">
        <li>
          <i class="fa-solid fa-circle-check" aria-hidden="true"></i>
          <span>تحديثات المتجر أولاً بأول</span>
        </li>
        <li>
          <i class="fa-solid fa-circle-check" aria-hidden="true"></i>
          <span>عروض مميزة لأعضاء القروب</span>
        </li>
      </ul>
      <a class="wa-btn wa-primary" href="https://chat.whatsapp.com/Gs3vxpniUy6a?mode=wwt" target="_blank" rel="noopener noreferrer">
        <i class="fa-brands fa-whatsapp" aria-hidden="true"></i>
        <span>انضم للقروب الآن</span>
      </a>
    </div>
  </div>

<script>
  (function(){
    var modal = document.getElementById('wa-join-modal');
    if(!modal) return;
    var KEY = 'wa_join_session_seen';

      function lockScroll(on){ try { document.body.style.overflow = on ? 'hidden' : ''; } catch(_){} }
      function open(){ modal.style.display = 'flex'; lockScroll(true); try { sessionStorage.setItem(KEY, '1'); } catch(_){} }
      function close(){ modal.style.display = 'none'; lockScroll(false); }

      var seen = '0';
      try { seen = sessionStorage.getItem(KEY) || '0'; } catch(_){ seen = '0'; }
      if (seen !== '1') {
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', open);
        } else { open(); }
      }

      var closeBtn = document.getElementById('wa-close-btn');
      if (closeBtn) closeBtn.addEventListener('click', close);
      modal.addEventListener('click', function(e){ if(e.target === modal) close(); });
      document.addEventListener('keydown', function(e){ if(e.key === 'Escape') close(); });
    })();
  </script>

  
  <div id="preloader"><div class="loader"></div></div>

</body>
</html>







